================================================================================
[01] Samba - 01 (共有フォルダ)
================================================================================
[01]
  Samba - 01 (共有フォルダ)
  
[内容]
  ## 作業内容
    共有フォルダを作成、Windows側から誰でも閲覧可能、変更可能にする
  
  ## 使用マシン
    HOST : localhost               # ホスト名を「FS01」に変更
    IPV4 : 192.168.1.3             # DHCP
    MEMO : ノート(CentOS7)         # Windows用ファイルサーバーに構築する
    USER : kate, mike              # OSユーザーで追加しておく
  
  ## 使用マシン
    HOST : localhost               # ホスト名を「PC01」に変更
    IPV4 : 192.168.1.2             # DHCP
    MEMO : ノート(Windows10)       # ドメイン未参加(WORKGROUP)
    USER : Owner                   # 元々存在していたユーザー(Administrators)
  
  ## 設定情報(Samba)
    DIRECTORY : /home/samba        # サーバー側ディレクトリ
    SHARENAME : share              # 共有名
  
[確認]
  # cd $HOME
  # yum -y install samba samba-client (パッケージ追加)
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> エラー出力が無ければOK
  --------------------------------------------------
  
  # cd $HOME
  # hostnamectl set-hostname FS01 (ホスト名変更)
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> 出力なし
  --------------------------------------------------
  
  # cd $HOME
  # useradd -s /usr/bin/bash kate (ユーザー追加)
  # useradd -s /usr/bin/bash mike (ユーザー追加)
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> 出力なし
  --------------------------------------------------
  
  # cd $HOME
  # LANG=C passwd kate (パスワード変更)
  # LANG=C passwd mike (パスワード変更)
  
  コマンドの実行結果
  --------------------------------------------------
  // Kate
  Changing password for user kate.
  New password: (ka0122maと入力)
  Retype new password: (ka0122maと入力)
  passwd: all authentication tokens updated successfully.
  
  // Mike
  Changing password for user mike.
  New password: (mi0122maと入力)
  Retype new password: (mi0122maと入力)
  passwd: all authentication tokens updated successfully.
  --------------------------------------------------
  
  # cd $HOME
  # mkdir -p /home/samba (共有フォルダ作成)
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> 出力なし
  --------------------------------------------------
  
  # cd $HOME
  # chmod 777 /home/samba (共有フォルダの権限変更)
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> 誰でも閲覧可能、変更可能にする
  --------------------------------------------------
  
  # cd $HOME
  # echo 'AAA AAA AAA' > file1.txt (共有フォルダ内にファイル作成)
  # echo 'BBB BBB BBB' > file2.txt (共有フォルダ内にファイル作成)
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> 出力なし
  --------------------------------------------------
  
  # cd $HOME
  # chmod 777 file[1-2].txt (共有フォルダの権限変更)
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> 誰でも閲覧可能、変更可能にする
  --------------------------------------------------
  
  # cd /etc/samba
  # cp -p smb.conf smb.conf.org (設定ファイルのバックアップ)
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> 出力なし
  --------------------------------------------------
  
  # cd /etc/samba
  # sudo vi smb.conf (設定ファイルのバックアップ)
  
  コマンドの実行結果
  --------------------------------------------------
  [global]
    workgroup = WORKGROUP                         // This server is WORKGROUP
    server role = STANDALONE                      // This server is not Domain Controller
    netbios name = FS01                           // NetBIOS
    server string = File Server for Windows User  // Description
    hosts allow = 192.168.1. 127.                 // Accessible Hosts
    guest account = makoto                        // Guest behaves as makoto user in Linux
    map to guest = Bad User                       // If input user is not existed, Samba reckon guest
    log file = /var/log/samba/%m.log              // Samba log
    max log size = 0                              // Samba log size is unlimited
    encrypt passwords = Yes                       // Samba use encrypt password
    wins support = No                             // Samba needs no WINS, uses /etc/samba/lmhosts
    security = user                               // Samba needs Linux Account
    passdb backend = smbpasswd                    // Samba stores user data in smbpasswd
    smb passwd file = /etc/samba/smbpasswd        // Smbpasswd file
    create mask = 0777                            // File Permission
    directory mask = 0777                         // Directory Permission
    local master = Yes                            // Master Browser is me
    preferred master = Yes                        // Master Browser is me
    domain master = No                            // Master Browser is me
    os level = 30                                 // Master Browser is me
    
  [share]
    comment = share directory in FS01  // Description
    browseable = Yes                   // Windows User can browse this SHARE
    writable = Yes                     // Windows User can write in this SHARE
    path = /home/samba                 // Specify the directory path for this SHARE
    public = Yes                       // Guest User can login this SHARE
    guest ok = Yes                     // Guest User
    guest only = Yes                   // Guest User
  --------------------------------------------------
  
  # cd $HOME
  # testparm (構文チェック)
  
  コマンドの実行結果
  --------------------------------------------------
  Load smb config files from /etc/samba/smb.conf
  Loaded services file OK.      // 構文チェックに異常なし
  Server role: ROLE_STANDALONE  // スタンドアロン
  
  // Enterキー押下で先に進む
  Press enter to see a dump of your service definitions
  
  # Global parameters
  [global]
    domain master = No
    guest account = makoto
    log file = /var/log/samba/%m.log
    map to guest = Bad User
    max log size = 0
    os level = 30
    passdb backend = smbpasswd
    preferred master = Yes
    security = USER
    server role = standalone server
    server string = File Server for Windows User
    smb passwd file = /etc/samba/smbpasswd
    idmap config * : backend = tdb
    create mask = 0777
    directory mask = 0777
    hosts allow = 192.168.1. 127.
  
  [share]
    comment = share directory in FS01
    guest ok = Yes
    guest only = Yes
    path = /home/samba
    read only = No
  --------------------------------------------------
  
  # cd $HOME
  # pdbedit -a kate (Sambaユーザー登録)
  # pdbedit -a mike (Sambaユーザー登録)
  
  コマンドの実行結果
  --------------------------------------------------
  // Kate
  new password         : (ka0122maと入力)
  retype new password  : (ka0122maと入力)
  Unix username        : kate
  NT username          : 
  Account Flags        : [U          ]
  User SID             : S-1-5-21-333211391-2767060413-2512415146-3002
  Primary Group SID    : S-1-5-21-333211391-2767060413-2512415146-513
  Full Name            : 
  Home Directory       : \\fs01\kate
  HomeDir Drive        : 
  Logon Script         : 
  Profile Path         : \\fs01\kate\profile
  Domain               : FS01
  Account desc         : 
  Workstations         : 
  Munged dial          : 
  Logon time           : 0
  Logoff time          : never
  Kickoff time         : never
  Password last set    : 日, 23  1月 2022 23:48:12 JST
  Password can change  : 日, 23  1月 2022 23:48:12 JST
  Password must change : never
  Last bad password    : 0
  Bad password count   : 0
  Logon hours          : FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
  
  // Mike
  new password         : (mi0122maと入力)
  retype new password  : (mi0122maと入力)
  Unix username        : mike
  NT username          : 
  Account Flags        : [U          ]
  User SID             : S-1-5-21-333211391-2767060413-2512415146-3004
  Primary Group SID    : S-1-5-21-333211391-2767060413-2512415146-513
  Full Name            : 
  Home Directory       : \\fs01\mike
  HomeDir Drive        : 
  Logon Script         : 
  Profile Path         : \\fs01\mike\profile
  Domain               : FS01
  Account desc         : 
  Workstations         : 
  Munged dial          : 
  Logon time           : 0
  Logoff time          : never
  Kickoff time         : never
  Password last set    : 日, 23  1月 2022 23:52:23 JST
  Password can change  : 日, 23  1月 2022 23:52:23 JST
  Password must change : never
  Last bad password    : 0
  Bad password count   : 0
  Logon hours          : FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
  --------------------------------------------------
  
  # cd $HOME
  # pdbedit -L (Sambaユーザーの一覧)
  
  コマンドの実行結果
  --------------------------------------------------
  kate:1001:
  mike:1002:
  --------------------------------------------------
  
  # cd $HOME
  # vi /etc/samba/lmhosts (設定ファイル修正)
  
  コマンドの実行結果
  --------------------------------------------------
  127.0.0.1 localhost
  192.168.1.2 PC01 (追加)
  192.168.1.3 FS01 (追加)
  --------------------------------------------------
  
  # cd $HOME
  # vi /etc/hosts (設定ファイル修正)
  
  コマンドの実行結果
  --------------------------------------------------
  127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
  ::1         localhost localhost.localdomain localhost6 localhost6.localdomain6
  192.168.1.2 PC01 (追加)
  192.168.1.3 FS01 (追加)
  --------------------------------------------------
  
  # cd $HOME
  # firewall-cmd --add-service=samba --permanent (設定ファイル修正)
  
  コマンドの実行結果
  --------------------------------------------------
  success
  --------------------------------------------------
  
  # cd $HOME
  # firewall-cmd --reload (設定ファイル修正)
  
  コマンドの実行結果
  --------------------------------------------------
  success
  --------------------------------------------------
  
  # cd $HOME
  # systemctl start smb nmb (Sambaサービスの起動)
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> 出力なし
  --------------------------------------------------
  
  ==================================================
    Sambaクライアントで接続(Sambaユーザー登録済み)
  ==================================================
  
  # cd $HOME
  # setenforce 0 (SELinuxの無効化)
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> 出力なし
  --------------------------------------------------
  
  # cd $HOME
  # smbclient -U kate //FS01/share (Sambaクライアントで共有フォルダに接続)
  
  コマンドの実行結果
  --------------------------------------------------
  Enter WORKGROUP\kate's password: (ka0122maと入力)
  Try "help" to get a list of possible commands.
  
  smb: \> 
  smb: \> help (コマンド一覧)
  
  ?              allinfo        altname        archive        backup         
  blocksize      cancel         case_sensitive cd             chmod          
  chown          close          del            deltree        dir            
  du             echo           exit           get            getfacl        
  geteas         hardlink       help           history        iosize         
  lcd            link           lock           lowercase      ls             
  l              mask           md             mget           mkdir          
  more           mput           newer          notify         open           
  posix          posix_encrypt  posix_open     posix_mkdir    posix_rmdir    
  posix_unlink   posix_whoami   print          prompt         put            
  pwd            q              queue          quit           readlink       
  rd             recurse        reget          rename         reput          
  rm             rmdir          showacls       setea          setmode        
  scopy          stat           symlink        tar            tarmode        
  timeout        translate      unlock         volume         vuid           
  wdel           logon          listconnect    showconnect    tcon           
  tdis           tid            utimes         logoff         ..             
  
  smb: \> 
  smb: \> ls
  
  .(カレントディレクトリ)             D        0  Sun Jan 23 22:06:02 2022
  ..(親ディレクトリ)                  D        0  Sun Jan 23 23:42:13 2022
  
  smb: \> 
  smb: \> mput file1.txt (Linux上のカレントディレクトリのファイルを共有フォルダにアップロード)
  
  Put file file1.txt? (yes)
  putting file file1.txt as \file1.txt (0.5 kb/s) (average 0.5 kb/s)
  
  smb: \> 
  smb: \> mput file2.txt (Linux上のカレントディレクトリのファイルを共有フォルダにアップロード)
  
  Put file file2.txt? (yes)
  putting file file2.txt as \file2.txt (1.0 kb/s) (average 0.7 kb/s)
  
  smb: \> 
  smb: \> ls (コンテンツ一覧)
  
  .(カレントディレクトリ)             D        0  Sun Jan 23 22:06:02 2022
  ..(親ディレクトリ)                  D        0  Sun Jan 23 23:42:13 2022
  file1.txt                           A       12  Mon Jan 24 02:44:12 2022
  file2.txt                           A       12  Mon Jan 24 02:44:21 2022
  
  smb: \> 
  smb: \> exit (Sambaクライアント終了)
  --------------------------------------------------
  
  # cd $HOME
  # setenforce 1 (SELinuxの有効化)
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> 出力なし
  --------------------------------------------------
  
  以下の確認に続く
  
================================================================================
