================================================================================
[01] メールサーバー構築(練習版)
[02] Sieve - 01 (特定メールアドレスからのメール拒否)
[03] //
================================================================================
[01]
  メールサーバー構築(練習版)
  
[内容]
  ## 作業内容
    メールサーバー構築を行う。
    ただしセキュリティ設定なし、DNS参照よりHOSTSが優先、と本番運用向きではないので注意。
  
  ## 使用マシン
    HOST : vm12
    IPV4 : 192.168.122.12
    MEMO : 仮想マシン
  
[確認]
  vm12# cd $HOME
  vm12# firewall-cmd --add-service={smtp,pop3} --permanent (ファイアーウォールの設定)
  
  コマンドの実行結果
  --------------------------------------------------
  success
  --------------------------------------------------
  
  vm12# cd $HOME
  vm12# firewall-cmd --reload (ファイアーウォールの設定を反映)
  
  コマンドの実行結果
  --------------------------------------------------
  success
  --------------------------------------------------
  
  vm12# cd $HOME
  vm12# yum -y install postfix dovecot telnet (パッケージ追加)
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> エラー出力が無ければOK
  --------------------------------------------------
  
  ==================================================
                    SMTP(Postfix)
  ==================================================

  vm12# cd /etc/postfix
  vm12# ls -lh (設定ファイルの一覧)
  
  コマンドの実行結果
  --------------------------------------------------
  -rw-r--r--. 1 root root  21K 11月  4  2010 access
  -rw-r--r--. 1 root root  12K  4月  1  2020 canonical
  -rw-r--r--. 1 root root 9.9K  4月  1  2020 generic
  -rw-r--r--. 1 root root  22K  9月  4  2012 header_checks
  -rw-r--r--. 1 root root  27K  4月  1  2020 main.cf    // メイン設定ファイル
  -rw-r--r--. 1 root root 6.0K  4月  1  2020 master.cf  // マスタープロセス設定ファイル
  -rw-r--r--. 1 root root 6.7K  3月 27  2007 relocated
  -rw-r--r--. 1 root root  13K 11月 22  2009 transport
  -rw-r--r--. 1 root root  13K  4月  1  2020 virtual
  --------------------------------------------------
  
  vm12# cd /etc/postfix
  vm12# cp -p main.cf main.cf.org (設定ファイルの退避)
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> 出力なし
  --------------------------------------------------
  
  vm12# cd /etc/postfix
  vm12# vi main.cf (設定ファイルの修正)
  
  コマンドの実行結果
  --------------------------------------------------
  // 変更部分のみ抜粋
  myhostname = vm12.example.com                                // 自ホスト名
  mydomain = example.com                                       // ドメイン名
  myorigin = $mydomain                                         // メールアドレスの「@」以降に適用されるドメイン名
  inet_interfaces = all                                        // SMTP接続可能なNIC
  inet_protocols = all                                         // IPv4とIPv6の両方可
  mydestination = $myhostname, localhost.$mydomain, localhost, $mydomain  // ローカル配送の受付ドメイン
  local_recipient_maps = (空白)                                // ローカルユーザー
  unknown_local_recipient_reject_code = 550                    // 不明
  mynetworks = 192.168.122.0/24, 127.0.0.0/8                   // 受付許可ネットワーク
  home_mailbox = Maildir/                                      // メールボックス形式
  mail_spool_directory = /var/spool/mail                       // メールスプール場所
  mailbox_command = /usr/libexec/dovecot/deliver -f "$SENDER" -a "$RECIPIENT"  // ローカル配送プログラム
  smtp_host_lookup = native                                    // DNS参照よりHOSTSが優先
  --------------------------------------------------
  
  vm12# cd /etc/skel
  vm12# mkdir Maildir (スケルトンファイルにディレクトリ追加)
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> 出力なし
  --------------------------------------------------
  
  vm12# cd $HOME
  vm12# vi /etc/hosts (ネットワーク設定ファイルを修正)
  
  コマンドの実行結果
  --------------------------------------------------
  127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
  ::1         localhost localhost.localdomain localhost6 localhost6.localdomain6
  192.168.122.11 vm11
  192.168.122.12 vm12 example.com(追加)
  192.168.122.13 vm13
  192.168.122.14 vm14
  --------------------------------------------------
  
  vm12# cd $HOME
  vm12# useradd aaa (ユーザー追加)
  vm12# useradd bbb (ユーザー追加)
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> 出力なし
  --------------------------------------------------
  
  vm12# cd $HOME
  vm12# echo aa0122ma | passwd --stdin aaa (パスワード設定)
  vm12# echo bb0122ma | passwd --stdin bbb (パスワード設定)
  
  コマンドの実行結果
  --------------------------------------------------
  // aaa
  ユーザー aaa のパスワードを変更。
  passwd: すべての認証トークンが正しく更新できました。
  
  // bbb
  ユーザー bbb のパスワードを変更。
  passwd: すべての認証トークンが正しく更新できました。
  --------------------------------------------------
  
  vm12# cd $HOME
  vm12# systemctl restart postfix (サービスの再起動)
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> 出力なし
  --------------------------------------------------
  
  ==================================================
                    POP3(Dovecot)
  ==================================================
  
  vm12# cd /etc/dovecot
  vm12# ls -lh (設定ファイルの一覧)
  
  コマンドの実行結果
  --------------------------------------------------
  drwxr-xr-x. 2 root root 4.0K  1月 31 17:52 conf.d        // 追加設定ファイル群
  -rw-r--r--. 1 root root 4.3K  4月 30  2018 dovecot.conf  // メイン設定ファイル
  --------------------------------------------------
  
  vm12# cd /etc/dovecot
  vm12# cp -p dovecot.conf dovecot.conf.org (設定ファイルの退避)
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> 出力なし
  --------------------------------------------------
  
  vm12# cd /etc/dovecot
  vm12# vi dovecot.conf (設定ファイルの修正)
  
  コマンドの実行結果
  --------------------------------------------------
  protocols = imap pop3 lmtp  // 対応プロトコル
  --------------------------------------------------
  
  vm12# cd /etc/dovecot/conf.d
  vm12# cp -p 10-mail.conf 10-mail.conf.org (設定ファイルの退避)
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> 出力なし
  --------------------------------------------------
  
  vm12# cd /etc/dovecot/conf.d
  vm12# vi 10-mail.conf (設定ファイルの修正)
  
  コマンドの実行結果
  --------------------------------------------------
  mail_location = maildir:~/Maildir  // メールの場所
  --------------------------------------------------
  
  vm12# cd /etc/dovecot/conf.d
  vm12# cp -p 10-auth.conf 10-auth.conf.org (設定ファイルの退避)
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> 出力なし
  --------------------------------------------------
  
  vm12# cd /etc/dovecot/conf.d
  vm12# vi 10-auth.conf (設定ファイルの修正)
  
  コマンドの実行結果
  --------------------------------------------------
  disable_plaintext_auth = no  // 平文認証を無効化しない -> 本来は危険!!
  --------------------------------------------------
  
  vm12# cd /etc/dovecot/conf.d
  vm12# cp -p 10-ssl.conf 10-ssl.conf.org (設定ファイルの退避)
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> 出力なし
  --------------------------------------------------
  
  vm12# cd /etc/dovecot/conf.d
  vm12# vi 10-ssl.conf (設定ファイルの修正)
  
  コマンドの実行結果
  --------------------------------------------------
  ssl = no  // SSL/TLSを使用しない -> 本来は危険!!
  --------------------------------------------------
  
  vm12# cd $HOME
  vm12# systemctl start dovecot (サービスの起動)
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> 出力なし
  --------------------------------------------------
  
  ==================================================
                    スクリプト作成
  ==================================================
  
  vm12# cd $HOME
  vm12# vi send_mail.sh (スクリプト作成)
  
  コマンドの実行結果
  --------------------------------------------------
  #!/bin/bash
  
  ## 関数定義
  function send_mail () {
    echo "ehlo localhost"
    sleep 1
    echo "mail from: $1@example.com"
    sleep 1
    echo "rcpt to: $2@example.com"
    sleep 1
    echo "data"
    sleep 1
    echo "from: $1@example.com"
    sleep 1
    echo "to: $2@example.com"
    sleep 1
    echo "Subject: test$3"
    sleep 1
    echo "I sent test$3."
    sleep 1
    echo "."
    sleep 1
    echo "quit"
  }
  
  ## サーバーにコマンド送信
  for i in $(seq 1 $3) ; do
    send_mail $1 $2 $i | telnet localhost 25;
  done
  --------------------------------------------------
  
  ==================================================
                スクリプトでメール送信
  ==================================================
  
  vm12# cd $HOME
  vm12# bash send_mail.sh aaa bbb 2 (AAAからBBBへ二通メール送信)
  
  コマンドの実行結果
  --------------------------------------------------
  // 1通目
  Trying ::1...
  Connected to localhost.
  Escape character is '^]'.
  220 vm12.example.com ESMTP Postfix
  250-vm12.example.com
  250-PIPELINING
  250-SIZE 10240000
  250-VRFY
  250-ETRN
  250-ENHANCEDSTATUSCODES
  250-8BITMIME
  250 DSN
  250 2.1.0 Ok
  250 2.1.5 Ok
  354 End data with <CR><LF>.<CR><LF>
  250 2.0.0 Ok: queued as E450F200AE0E
  Connection closed by foreign host.
  
  // 2通目
  Trying ::1...
  Connected to localhost.
  Escape character is '^]'.
  220 vm12.example.com ESMTP Postfix
  250-vm12.example.com
  250-PIPELINING
  250-SIZE 10240000
  250-VRFY
  250-ETRN
  250-ENHANCEDSTATUSCODES
  250-8BITMIME
  250 DSN
  250 2.1.0 Ok
  250 2.1.5 Ok
  354 End data with <CR><LF>.<CR><LF>
  250 2.0.0 Ok: queued as EA575200AE11
  Connection closed by foreign host.
  --------------------------------------------------
  
  ==================================================
                  メール受信を確認
  ==================================================
  
  vm12# cd $HOME
  vm12# telnet localhost 110 (メール受信を確認)
  
  コマンドの実行結果
  --------------------------------------------------
  Trying ::1...
  Connected to localhost.
  Escape character is '^]'.
  +OK Dovecot ready.
    
    > (ユーザー名)
    > user bbb
    
    コマンドの実行結果
    --------------------------------------------------
    +OK
    --------------------------------------------------
    
    > (パスワード)
    > pass bb0122ma
    
    コマンドの実行結果
    --------------------------------------------------
    +OK Logged in.
    --------------------------------------------------
    
    > (メール一覧)
    > list

    コマンドの実行結果
    --------------------------------------------------
    +OK 2 messages:
    1 448
    2 448
    --------------------------------------------------
    
    > (一番目のメール参照)
    > retr 1

    コマンドの実行結果
    --------------------------------------------------
    +OK 448 octets
    Return-Path: <aaa@example.com>
    X-Original-To: bbb@example.com
    Delivered-To: bbb@example.com
    Received: from localhost (localhost [IPv6:::1])
      by vm12.example.com (Postfix) with ESMTP id BB38F200AE13
      for <bbb@example.com>; Tue,  1 Feb 2022 15:10:10 +0900 (JST)
    from: aaa@example.com
    to: bbb@example.com
    Subject: test1
    Message-Id: <20220201061011.BB38F200AE13@vm12.example.com>
    Date: Tue,  1 Feb 2022 15:10:10 +0900 (JST)
    
    // メール本文
    I sent test1.
    --------------------------------------------------
    
    > (二番目のメール参照)
    > retr 2

    コマンドの実行結果
    --------------------------------------------------
    +OK 448 octets
    Return-Path: <aaa@example.com>
    X-Original-To: bbb@example.com
    Delivered-To: bbb@example.com
    Received: from localhost (localhost [IPv6:::1])
      by vm12.example.com (Postfix) with ESMTP id C1061200AE01
      for <bbb@example.com>; Tue,  1 Feb 2022 15:10:19 +0900 (JST)
    from: aaa@example.com
    to: bbb@example.com
    Subject: test2
    Message-Id: <20220201061020.C1061200AE01@vm12.example.com>
    Date: Tue,  1 Feb 2022 15:10:19 +0900 (JST)
    
    // メール本文
    I sent test2.
    --------------------------------------------------
    
    > (ログアウト)
    > quit

    コマンドの実行結果
    --------------------------------------------------
    +OK Logging out.
    Connection closed by foreign host.
    --------------------------------------------------
    
    OSプロンプトに戻る
    
  --------------------------------------------------
  
  ==================================================
                    メール削除
  ==================================================
  
  vm12# cd $HOME
  vm12# doveadm expunge mailbox -u bbb inbox all (メールボックス内のメール削除)
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> 出力なし
  --------------------------------------------------
  
  vm12# cd $HOME
  vm12# doveadm mailbox status -u bbb messages inbox (メールボックス内のメール確認)
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> 出力なし
  --------------------------------------------------
  
  以下の確認に続く
  
================================================================================
[02]
  Sieve - 01 (特定メールアドレスからのメール拒否)
  
[内容]
  ## 作業内容
    プラグイン(Sieve)を使用してメールフィルタリングを行う
  
  ## 使用マシン
    HOST : vm12
    IPV4 : 192.168.122.12
    MEMO : 仮想マシン
  
[確認]
  vm12# cd $HOME
  vm12# yum -y install dovecot-pigeonhole (パッケージ追加)
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> エラー出力が無ければOK
  --------------------------------------------------
  
  vm12# cd /etc/dovecot/conf.d
  vm12# cp -p 15-lda.conf 15-lda.conf.org (設定ファイルの退避)
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> 出力なし
  --------------------------------------------------
  
  vm12# cd /etc/dovecot/conf.d
  vm12# vi 15-lda.conf (設定ファイルにプラグイン追加を記述)
  
  コマンドの実行結果
  --------------------------------------------------
  protocol lda {
    mail_plugins = $mail_plugins sieve (修正後)
  }
  --------------------------------------------------
  
  vm12# cd /etc/dovecot/conf.d
  vm12# cp -p 20-lmtp.conf 20-lmtp.conf.org (設定ファイルの退避)
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> 出力なし
  --------------------------------------------------
  
  vm12# cd /etc/dovecot/conf.d
  vm12# vi 20-lmtp.conf (設定ファイルにプラグイン追加を記述)
  
  コマンドの実行結果
  --------------------------------------------------
  protocol lmtp {
    mail_plugins = $mail_plugins sieve (修正後)
  }
  --------------------------------------------------
  
  vm12# cd $HOME
  vm12# systemctl restart dovecot (サービスの再起動)
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> 出力なし
  --------------------------------------------------
  
  vm12# cd $HOME
  vm12# // (//)
  
  コマンドの実行結果
  --------------------------------------------------
  //
  --------------------------------------------------
  
  vm12# cd $HOME
  vm12# // (//)
  
  コマンドの実行結果
  --------------------------------------------------
  //
  --------------------------------------------------
  
  vm12# cd $HOME
  vm12# // (//)
  
  コマンドの実行結果
  --------------------------------------------------
  //
  --------------------------------------------------
  
  vm12# cd $HOME
  vm12# // (//)
  
  コマンドの実行結果
  --------------------------------------------------
  //
  --------------------------------------------------
  
  vm12# cd $HOME
  vm12# // (//)
  
  コマンドの実行結果
  --------------------------------------------------
  //
  --------------------------------------------------
  
  vm12# cd $HOME
  vm12# // (//)
  
  コマンドの実行結果
  --------------------------------------------------
  //
  --------------------------------------------------
  
  以下の確認に続く
  
================================================================================
[03]
  //
  
[内容]
  ## 作業内容
    //
  
  ## 使用マシン
    HOST : vm12
    IPV4 : 192.168.122.12
    MEMO : 仮想マシン
  
[確認]
  vm12# cd $HOME
  vm12# // (//)
  
  コマンドの実行結果
  --------------------------------------------------
  //
  --------------------------------------------------
  
  vm12# cd $HOME
  vm12# // (//)
  
  コマンドの実行結果
  --------------------------------------------------
  //
  --------------------------------------------------
  
  以下の確認に続く
  
================================================================================
