================================================================================
[001] Postfix & Dovecot
[002] Sieve - 01
[003] Sieve - 02
[004] Sieve - 03
[005] メール転送 - 01
[006] メール転送 - 02
[007] メール転送 - 03
[008] Procmail - 01
[009] Procmail - 02
[010] Procmail - 03
[011] Procmail - 04
[012] SMTP-AUTH
[013] SpamAssassin
================================================================================
[001]
  Postfix & Dovecot
  
[内容]
  ## 作業内容
    旧版から引用 => メールサーバー(練習板)の構築を行う。
    ただしセキュリティ設定なし、DNS参照よりHOSTS優先、と本番運用向きではないので注意。
  
  ## 使用マシン
    HOST : vm12
    IPV4 : 192.168.122.12
    MEMO : 仮想マシン
  
[確認]
  vm12# cd $HOME
  vm12# firewall-cmd --add-service={smtp,pop3} --permanent
  
  コマンドの実行結果
  --------------------------------------------------
  success
  --------------------------------------------------
  
  vm12# cd $HOME
  vm12# firewall-cmd --reload
  
  コマンドの実行結果
  --------------------------------------------------
  success
  --------------------------------------------------
  
  vm12# cd $HOME
  vm12# yum -y install postfix dovecot telnet
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> エラー出力が無ければOK
  --------------------------------------------------
  
  ==================================================
                    SMTP(Postfix)
  ==================================================

  vm12# cd /etc/postfix
  vm12# ls -lh
  
  コマンドの実行結果
  --------------------------------------------------
  -rw-r--r--. 1 root root  21K 11月  4  2010 access
  -rw-r--r--. 1 root root  12K  4月  1  2020 canonical
  -rw-r--r--. 1 root root 9.9K  4月  1  2020 generic
  -rw-r--r--. 1 root root  22K  9月  4  2012 header_checks
  -rw-r--r--. 1 root root  27K  4月  1  2020 main.cf    // メイン設定ファイル
  -rw-r--r--. 1 root root 6.0K  4月  1  2020 master.cf  // マスタープロセス設定ファイル
  -rw-r--r--. 1 root root 6.7K  3月 27  2007 relocated
  -rw-r--r--. 1 root root  13K 11月 22  2009 transport
  -rw-r--r--. 1 root root  13K  4月  1  2020 virtual
  --------------------------------------------------
  
  vm12# cd /etc/postfix
  vm12# cp -p main.cf main.cf.org
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> 出力なし
  --------------------------------------------------
  
  vm12# cd /etc/postfix
  vm12# vi main.cf
  
  コマンドの実行結果
  --------------------------------------------------
  // 変更部分のみ抜粋
  myhostname = vm12.example.com                                           // 自ホスト名
  mydomain = example.com                                                  // ドメイン名
  myorigin = $mydomain                                                    // メールアドレスの「@」以降のドメイン名
  inet_interfaces = all                                                   // SMTP接続可能なNIC
  inet_protocols = all                                                    // IPv4とIPv6の両方可
  mydestination = $myhostname, localhost.$mydomain, localhost, $mydomain  // ローカル配送の受付ドメイン
  local_recipient_maps = (空白)
  unknown_local_recipient_reject_code = 550
  mynetworks = 192.168.122.0/24, 127.0.0.0/8                                   // 受付許可ネットワーク
  home_mailbox = Maildir/                                                      // メールボックス形式
  mail_spool_directory = /var/spool/mail                                       // メールスプール場所
  mailbox_command = /usr/libexec/dovecot/deliver -f "$SENDER" -a "$RECIPIENT"  // ローカル配送プログラム
  smtp_host_lookup = native                                                    // DNS参照よりHOSTSが優先
  --------------------------------------------------
  
  vm12# cd /etc/skel
  vm12# mkdir Maildir -> スケルトンファイルにディレクトリ追加
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> 出力なし
  --------------------------------------------------
  
  vm12# cd $HOME
  vm12# vi /etc/hosts -> ネットワーク設定ファイルを修正
  
  コマンドの実行結果
  --------------------------------------------------
  127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
  ::1         localhost localhost.localdomain localhost6 localhost6.localdomain6
  192.168.122.11 vm11
  192.168.122.12 vm12 example.com(追加)
  192.168.122.13 vm13
  192.168.122.14 vm14
  --------------------------------------------------
  
  vm12# cd $HOME
  vm12# useradd aaa -> ユーザー追加
  vm12# useradd bbb -> ユーザー追加
  vm12# useradd ccc -> ユーザー追加
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> 出力なし
  --------------------------------------------------
  
  vm12# cd $HOME
  vm12# echo aa0122ma | passwd --stdin aaa -> パスワード設定
  vm12# echo bb0122ma | passwd --stdin bbb -> パスワード設定
  vm12# echo cc0122ma | passwd --stdin ccc -> パスワード設定
  
  コマンドの実行結果
  --------------------------------------------------
  // aaa
  ユーザー aaa のパスワードを変更。
  passwd: すべての認証トークンが正しく更新できました。
  
  // bbb
  ユーザー bbb のパスワードを変更。
  passwd: すべての認証トークンが正しく更新できました。

  // ccc
  ユーザー ccc のパスワードを変更。
  passwd: すべての認証トークンが正しく更新できました。
  --------------------------------------------------
  
  vm12# cd $HOME
  vm12# systemctl restart postfix
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> 出力なし
  --------------------------------------------------
  
  ==================================================
                    POP3(Dovecot)
  ==================================================
  
  vm12# cd /etc/dovecot
  vm12# ls -lh
  
  コマンドの実行結果
  --------------------------------------------------
  drwxr-xr-x. 2 root root 4.0K  1月 31 17:52 conf.d        // 追加設定ファイル群
  -rw-r--r--. 1 root root 4.3K  4月 30  2018 dovecot.conf  // メイン設定ファイル
  --------------------------------------------------
  
  vm12# cd /etc/dovecot
  vm12# cp -p dovecot.conf dovecot.conf.org
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> 出力なし
  --------------------------------------------------
  
  vm12# cd /etc/dovecot
  vm12# vi dovecot.conf
  
  コマンドの実行結果
  --------------------------------------------------
  protocols = imap pop3 lmtp  // 対応プロトコル
  --------------------------------------------------
  
  vm12# cd /etc/dovecot/conf.d
  vm12# cp -p 10-mail.conf 10-mail.conf.org
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> 出力なし
  --------------------------------------------------
  
  vm12# cd /etc/dovecot/conf.d
  vm12# vi 10-mail.conf
  
  コマンドの実行結果
  --------------------------------------------------
  mail_location = maildir:~/Maildir  // メールの場所
  --------------------------------------------------
  
  vm12# cd /etc/dovecot/conf.d
  vm12# cp -p 10-auth.conf 10-auth.conf.org
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> 出力なし
  --------------------------------------------------
  
  vm12# cd /etc/dovecot/conf.d
  vm12# vi 10-auth.conf
  
  コマンドの実行結果
  --------------------------------------------------
  disable_plaintext_auth = no  // 平文認証を無効化しない -> 本来は危険!!
  --------------------------------------------------
  
  vm12# cd /etc/dovecot/conf.d
  vm12# cp -p 10-ssl.conf 10-ssl.conf.org
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> 出力なし
  --------------------------------------------------
  
  vm12# cd /etc/dovecot/conf.d
  vm12# vi 10-ssl.conf
  
  コマンドの実行結果
  --------------------------------------------------
  ssl = no  // SSL/TLSを使用しない -> 本来は危険!!
  --------------------------------------------------
  
  vm12# cd $HOME
  vm12# systemctl enable dovecot
  
  コマンドの実行結果
  --------------------------------------------------
  (省略)
  --------------------------------------------------
  
  vm12# cd $HOME
  vm12# systemctl start dovecot
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> 出力なし
  --------------------------------------------------
  
  ==================================================
                    スクリプト作成
  ==================================================
  
  vm12# cd $HOME
  vm12# vi send_mail.sh
  
  コマンドの実行結果
  --------------------------------------------------
  #!/bin/bash
  
  ## 関数定義
  function send_mail () {
    echo "ehlo localhost"
    sleep 1
    echo "mail from: $1@example.com"
    sleep 1
    echo "rcpt to: $2@example.com"
    sleep 1
    echo "data"
    sleep 1
    echo "from: $1@example.com"
    sleep 1
    echo "to: $2@example.com"
    sleep 1
    echo "Subject: test$3"
    sleep 1
    echo "I sent test$3."
    sleep 1
    echo "."
    sleep 1
    echo "quit"
  }
  
  ## サーバーにコマンド送信
  for i in $(seq 1 $3) ; do
    send_mail $1 $2 $i | telnet localhost 25;
  done
  --------------------------------------------------
  
  ==================================================
                スクリプトでメール送受信
  ==================================================
  
  vm12# cd $HOME
  vm12# bash send_mail.sh aaa bbb 2 -> AAAからBBBへ二通メール送信
  
  コマンドの実行結果
  --------------------------------------------------
  // 1通目
  Trying ::1...
  Connected to localhost.
  Escape character is '^]'.
  220 vm12.example.com ESMTP Postfix
  250-vm12.example.com
  250-PIPELINING
  250-SIZE 10240000
  250-VRFY
  250-ETRN
  250-ENHANCEDSTATUSCODES
  250-8BITMIME
  250 DSN
  250 2.1.0 Ok
  250 2.1.5 Ok
  354 End data with <CR><LF>.<CR><LF>
  250 2.0.0 Ok: queued as E450F200AE0E
  Connection closed by foreign host.
  
  // 2通目
  Trying ::1...
  Connected to localhost.
  Escape character is '^]'.
  220 vm12.example.com ESMTP Postfix
  250-vm12.example.com
  250-PIPELINING
  250-SIZE 10240000
  250-VRFY
  250-ETRN
  250-ENHANCEDSTATUSCODES
  250-8BITMIME
  250 DSN
  250 2.1.0 Ok
  250 2.1.5 Ok
  354 End data with <CR><LF>.<CR><LF>
  250 2.0.0 Ok: queued as EA575200AE11
  Connection closed by foreign host.
  --------------------------------------------------
  
  vm12# cd $HOME
  vm12# telnet localhost 110 -> メール受信を確認
  
  コマンドの実行結果
  --------------------------------------------------
  Trying ::1...
  Connected to localhost.
  Escape character is '^]'.
  +OK Dovecot ready.
  
  // ユーザー名
  user bbb
  +OK
  
  // パスワード
  pass bb0122ma
  +OK Logged in.
  
  // メール一覧
  list
  +OK 2 messages:
  1 448
  2 448
  
  // 一番目のメール参照
  retr 1
  +OK 448 octets
  Return-Path: <aaa@example.com>
  X-Original-To: bbb@example.com
  Delivered-To: bbb@example.com
  Received: from localhost (localhost [IPv6:::1])
    by vm12.example.com (Postfix) with ESMTP id BB38F200AE13
    for <bbb@example.com>; Tue,  1 Feb 2022 15:10:10 +0900 (JST)
  from: aaa@example.com
  to: bbb@example.com
  Subject: test1
  Message-Id: <20220201061011.BB38F200AE13@vm12.example.com>
  Date: Tue,  1 Feb 2022 15:10:10 +0900 (JST)
  
  I sent test1.

  // 二番目のメール参照
  retr 2
  +OK 448 octets
  Return-Path: <aaa@example.com>
  X-Original-To: bbb@example.com
  Delivered-To: bbb@example.com
  Received: from localhost (localhost [IPv6:::1])
    by vm12.example.com (Postfix) with ESMTP id C1061200AE01
    for <bbb@example.com>; Tue,  1 Feb 2022 15:10:19 +0900 (JST)
  from: aaa@example.com
  to: bbb@example.com
  Subject: test2
  Message-Id: <20220201061020.C1061200AE01@vm12.example.com>
  Date: Tue,  1 Feb 2022 15:10:19 +0900 (JST)
  
  I sent test2.

  // ログアウト
  quit
  +OK Logging out.
  Connection closed by foreign host.
  --------------------------------------------------
  
  vm12# cd $HOME
  vm12# doveadm expunge mailbox -u aaa inbox all -> メールボックス内のメール削除
  vm12# doveadm expunge mailbox -u bbb inbox all -> メールボックス内のメール削除
  vm12# doveadm expunge mailbox -u ccc inbox all -> メールボックス内のメール削除
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> 出力なし
  --------------------------------------------------
  
  以下の確認に続く
  
================================================================================
[002]
  Sieve - 01
  
[内容]
  ## 作業内容
    旧版から引用 => プラグイン(Sieve)を使用してメールフィルタリングを行う
  
  ## 使用マシン
    HOST : vm12
    IPV4 : 192.168.122.12
    MEMO : 仮想マシン
  
[確認]
  vm12# cd $HOME
  vm12# yum -y install dovecot-pigeonhole
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> エラー出力が無ければOK
  --------------------------------------------------
  
  vm12# cd /etc/dovecot/conf.d
  vm12# cp -p 15-lda.conf 15-lda.conf.org
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> 出力なし
  --------------------------------------------------
  
  vm12# cd /etc/dovecot/conf.d
  vm12# vi 15-lda.conf
  
  コマンドの実行結果
  --------------------------------------------------
  protocol lda {
    mail_plugins = $mail_plugins sieve (修正後)
  }
  --------------------------------------------------
  
  vm12# cd /etc/dovecot/conf.d
  vm12# cp -p 20-lmtp.conf 20-lmtp.conf.org
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> 出力なし
  --------------------------------------------------
  
  vm12# cd /etc/dovecot/conf.d
  vm12# vi 20-lmtp.conf
  
  コマンドの実行結果
  --------------------------------------------------
  protocol lmtp {
    mail_plugins = $mail_plugins sieve (修正後)
  }
  --------------------------------------------------
  
  vm12# cd /etc/dovecot/conf.d
  vm12# systemctl restart dovecot
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> 出力なし
  --------------------------------------------------
  
  ==================================================
              フィルタリングルール記述
  ==================================================
  
  vm12# cd /etc/dovecot/conf.d
  vm12# cat 90-sieve.conf | grep -vE '^#|^$|^.*#' -> フィルタリングルールの記述場所を確認
  
  コマンドの実行結果
  --------------------------------------------------
  plugin {
    sieve = file:~/sieve;active=~/.dovecot.sieve  (ホーム配下の「.dovecot.sieve」ファイル)
  }
  --------------------------------------------------
  
  vm12# cd ~bbb
  vm12# vi .dovecot.sieve
  
  コマンドの実行結果
  --------------------------------------------------
  require ["reject"];
  
  ## 差出が「aaa@example.com」の場合
  if address :is "from" "aaa@example.com"
  {
    ## メッセージを添えて拒否
    reject "This Address is invalid.";
  }
  --------------------------------------------------
  
  vm12# cd ~bbb
  vm12# chown bbb.bbb .dovecot.sieve
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> 出力なし
  --------------------------------------------------
  
  ==================================================
                スクリプトでメール送受信
  ==================================================
  
  vm12# cd $HOME
  vm12# bash send_mail.sh aaa bbb 1 -> AAAからBBBへ一通メール送信
  
  コマンドの実行結果
  --------------------------------------------------
  Trying ::1...
  Connected to localhost.
  Escape character is '^]'.
  220 vm12.example.com ESMTP Postfix
  250-vm12.example.com
  250-PIPELINING
  250-SIZE 10240000
  250-VRFY
  250-ETRN
  250-ENHANCEDSTATUSCODES
  250-8BITMIME
  250 DSN
  250 2.1.0 Ok
  250 2.1.5 Ok
  354 End data with <CR><LF>.<CR><LF>
  250 2.0.0 Ok: queued as 6157B200AE09
  Connection closed by foreign host.
  --------------------------------------------------
  
  vm12# cd $HOME
  vm12# doveadm mailbox status -u aaa messages inbox -> メールボックス内のメール確認
  vm12# doveadm mailbox status -u bbb messages inbox -> メールボックス内のメール確認
  vm12# doveadm mailbox status -u ccc messages inbox -> メールボックス内のメール確認
  
  コマンドの実行結果
  --------------------------------------------------
  // aaa
  INBOX messages=1 -> 送付したメールが拒否されて送り返された

  // bbb
  INBOX messages=0
  
  // ccc
  INBOX messages=0
  --------------------------------------------------
  
  vm12# cd $HOME
  vm12# telnet localhost 110 -> メール受信を確認
  
  コマンドの実行結果
  --------------------------------------------------
  Trying ::1...
  Connected to localhost.
  Escape character is '^]'.
  +OK Dovecot ready.
  
  // ユーザー名
  user aaa
  +OK
  
  // パスワード
  pass aa0122ma
  +OK Logged in.
  
  // メール一覧
  list
  +OK 1 messages:
  1 1582
  
  // メール参照
  retr 1
  +OK 1582 octets
  Return-Path: <>
  X-Original-To: aaa@example.com
  Delivered-To: aaa@example.com
  Received: by vm12.example.com (Postfix, from userid 1004)
    id B4450200AE34; Wed,  2 Feb 2022 14:30:25 +0900 (JST)
  Message-ID: <dovecot-1643779825-547995-0@vm12>
  Date: Wed, 02 Feb 2022 14:30:25 +0900
  From: Mail Delivery Subsystem <postmaster@>
  To: <aaa@example.com>
  MIME-Version: 1.0
  Content-Type: multipart/report; report-type=disposition-notification;
    boundary="1570/vm12"
  Subject: Rejected: test1  // 拒否された旨「Rejected」と表示
  Auto-Submitted: auto-replied (rejected)
  Precedence: bulk
  
  This is a MIME-encapsulated message
  
  --1570/vm12
  Content-Type: text/plain; charset=utf-8
  Content-Disposition: inline
  Content-Transfer-Encoding: 8bit
  
  Your message to <bbb@example.com> was automatically rejected:
  This Address is invalid.  // プラグイン(Sieve)で設定されたメッセージ
  
  --1570/vm12
  Content-Type: message/disposition-notification
  
  Reporting-UA: vm12; Dovecot Mail Delivery Agent
  Final-Recipient: rfc822; bbb@example.com
  Original-Message-ID: <20220202053019.6157B200AE09@vm12.example.com>
  Disposition: automatic-action/MDN-sent-automatically; deleted
  
  --1570/vm12
  Content-Type: message/rfc822
  
  Return-Path: <aaa@example.com>
  X-Original-To: bbb@example.com
  Delivered-To: bbb@example.com
  Received: from localhost (localhost [IPv6:::1])
    by vm12.example.com (Postfix) with ESMTP id 6157B200AE09
    for <bbb@example.com>; Wed,  2 Feb 2022 14:30:18 +0900 (JST)
  from: aaa@example.com
  to: bbb@example.com
  Subject: test1
  Message-Id: <20220202053019.6157B200AE09@vm12.example.com>
  Date: Wed,  2 Feb 2022 14:30:18 +0900 (JST)
    
  // ログアウト
  quit
  +OK Logging out.
  Connection closed by foreign host.
  --------------------------------------------------
  
  vm12# cd $HOME
  vm12# doveadm expunge mailbox -u aaa inbox all -> メールボックス内のメール削除
  vm12# doveadm expunge mailbox -u bbb inbox all -> メールボックス内のメール削除
  vm12# doveadm expunge mailbox -u ccc inbox all -> メールボックス内のメール削除
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> 出力なし
  --------------------------------------------------
  
  以下の確認に続く
  
================================================================================
[003]
  Sieve - 02
  
[内容]
  ## 作業内容
    旧版から引用 => プラグイン(Sieve)を使用してメールフィルタリングを行う
  
  ## 使用マシン
    HOST : vm12
    IPV4 : 192.168.122.12
    MEMO : 仮想マシン
  
[確認]
  vm12# cd $HOME
  vm12# systemctl is-active dovecot
  
  コマンドの実行結果
  --------------------------------------------------
  active
  --------------------------------------------------
  
  ==================================================
              フィルタリングルール記述
  ==================================================
  
  vm12# cd ~bbb
  vm12# vi .dovecot.sieve
  
  コマンドの実行結果
  --------------------------------------------------
  require ["fileinto"];
  
  ## 差出が「aaa@example.com」の場合
  if address :is "from" "aaa@example.com"
  {
    ## 指定フォルダ移動
    fileinto "AAA";
  }
  --------------------------------------------------
  
  vm12# cd $HOME
  vm12# doveadm mailbox create -u bbb AAA -> フォルダ作成
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> 出力なし
  --------------------------------------------------
  
  vm12# cd $HOME
  vm12# doveadm mailbox list -u bbb -> フォルダ確認
  
  コマンドの実行結果
  --------------------------------------------------
  AAA
  INBOX
  --------------------------------------------------
  
  ==================================================
                スクリプトでメール送受信
  ==================================================
  
  vm12# cd $HOME
  vm12# bash send_mail.sh aaa bbb 1 -> AAAからBBBへ一通メール送信
  
  コマンドの実行結果
  --------------------------------------------------
  Trying ::1...
  Connected to localhost.
  Escape character is '^]'.
  220 vm12.example.com ESMTP Postfix
  250-vm12.example.com
  250-PIPELINING
  250-SIZE 10240000
  250-VRFY
  250-ETRN
  250-ENHANCEDSTATUSCODES
  250-8BITMIME
  250 DSN
  250 2.1.0 Ok
  250 2.1.5 Ok
  354 End data with <CR><LF>.<CR><LF>
  250 2.0.0 Ok: queued as EA921200AE12
  Connection closed by foreign host.
  --------------------------------------------------
  
  vm12# cd $HOME
  vm12# doveadm mailbox status -u aaa messages inbox -> メールボックス内のメール確認
  vm12# doveadm mailbox status -u bbb messages inbox -> メールボックス内のメール確認
  vm12# doveadm mailbox status -u ccc messages inbox -> メールボックス内のメール確認
  vm12# doveadm mailbox status -u bbb messages AAA   -> メールボックス内のメール確認
  
  コマンドの実行結果
  --------------------------------------------------
  // aaa
  INBOX messages=1
  
  // bbb
  INBOX messages=0
  
  // ccc
  INBOX messages=0
  
  // bbb(AAA)
  AAA messages=1 -> 送付したメールが指定フォルダ移動
  --------------------------------------------------
  
  vm12# cd $HOME
  vm12# doveadm mailbox delete -u bbb AAA -> フォルダ削除
  
  コマンドの実行結果
  --------------------------------------------------
  (出力なし)
  --------------------------------------------------
  
  vm12# cd $HOME
  vm12# doveadm expunge mailbox -u aaa inbox all -> メールボックス内のメール削除
  vm12# doveadm expunge mailbox -u bbb inbox all -> メールボックス内のメール削除
  vm12# doveadm expunge mailbox -u ccc inbox all -> メールボックス内のメール削除
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> 出力なし
  --------------------------------------------------
  
  以下の確認に続く
  
================================================================================
[004]
  Sieve - 03
  
[内容]
  ## 作業内容
    旧版から引用 => プラグイン(Sieve)を使用してメールフィルタリングを行う
  
  ## 使用マシン
    HOST : vm12
    IPV4 : 192.168.122.12
    MEMO : 仮想マシン
  
[確認]
  vm12# cd $HOME
  vm12# systemctl is-active dovecot
  
  コマンドの実行結果
  --------------------------------------------------
  active
  --------------------------------------------------
  
  ==================================================
              フィルタリングルール記述
  ==================================================
  
  vm12# cd ~bbb
  vm12# vi .dovecot.sieve
  
  コマンドの実行結果
  --------------------------------------------------
  ## 差出が「aaa@example.com」の場合
  if address :is "from" "aaa@example.com"
  {
    ## メール転送
    redirect "ccc@example.com";
  }
  --------------------------------------------------
  
  ==================================================
                スクリプトでメール送受信
  ==================================================
  
  vm12# cd $HOME
  vm12# bash send_mail.sh aaa bbb 1 -> AAAからBBBへ一通メール送信
  
  コマンドの実行結果
  --------------------------------------------------
  Trying ::1...
  Connected to localhost.
  Escape character is '^]'.
  220 vm12.example.com ESMTP Postfix
  250-vm12.example.com
  250-PIPELINING
  250-SIZE 10240000
  250-VRFY
  250-ETRN
  250-ENHANCEDSTATUSCODES
  250-8BITMIME
  250 DSN
  250 2.1.0 Ok
  250 2.1.5 Ok
  354 End data with <CR><LF>.<CR><LF>
  250 2.0.0 Ok: queued as 0B9B7200AE12
  Connection closed by foreign host.
  --------------------------------------------------
  
  vm12# cd $HOME
  vm12# doveadm mailbox status -u aaa messages inbox -> メールボックス内のメール確認
  vm12# doveadm mailbox status -u bbb messages inbox -> メールボックス内のメール確認
  vm12# doveadm mailbox status -u ccc messages inbox -> メールボックス内のメール確認
  
  コマンドの実行結果
  --------------------------------------------------
  // aaa
  INBOX messages=0
  
  // bbb
  INBOX messages=0
  
  // ccc
  INBOX messages=1 -> メール転送された
  --------------------------------------------------
  
  vm12# cd $HOME
  vm12# doveadm expunge mailbox -u aaa inbox all -> メールボックス内のメール削除
  vm12# doveadm expunge mailbox -u bbb inbox all -> メールボックス内のメール削除
  vm12# doveadm expunge mailbox -u ccc inbox all -> メールボックス内のメール削除
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> 出力なし
  --------------------------------------------------
  
  vm12# cd ~bbb
  vm12# rm -f .dovecot.sieve
  vm12# touch .dovecot.sieve
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> 出力なし
  --------------------------------------------------
  
  以下の確認に続く
  
================================================================================
[005]
  メール転送 - 01
  
[内容]
  ## 作業内容
    旧版から引用 => メール転送をファイル(.forward)で行う
  
  ## 使用マシン
    HOST : vm12
    IPV4 : 192.168.122.12
    MEMO : 仮想マシン
  
[確認]
  vm12# cd $HOME
  vm12# systemctl is-active dovecot
  
  コマンドの実行結果
  --------------------------------------------------
  active
  --------------------------------------------------
  
  ==================================================
              フィルタリングルール記述
  ==================================================
  
  vm12# cd ~bbb
  vm12# vi .forward
  
  コマンドの実行結果
  --------------------------------------------------
  ccc@example.com
  --------------------------------------------------
  
  ==================================================
                スクリプトでメール送受信
  ==================================================
  
  vm12# cd $HOME
  vm12# bash send_mail.sh aaa bbb 1 -> AAAからBBBへ一通メール送信
  
  コマンドの実行結果
  --------------------------------------------------
  Trying ::1...
  Connected to localhost.
  Escape character is '^]'.
  220 vm12.example.com ESMTP Postfix
  250-vm12.example.com
  250-PIPELINING
  250-SIZE 10240000
  250-VRFY
  250-ETRN
  250-ENHANCEDSTATUSCODES
  250-8BITMIME
  250 DSN
  250 2.1.0 Ok
  250 2.1.5 Ok
  354 End data with <CR><LF>.<CR><LF>
  250 2.0.0 Ok: queued as 641FC200AE12
  Connection closed by foreign host.
  --------------------------------------------------
  
  vm12# cd $HOME
  vm12# doveadm mailbox status -u aaa messages inbox -> メールボックス内のメール確認
  vm12# doveadm mailbox status -u bbb messages inbox -> メールボックス内のメール確認
  vm12# doveadm mailbox status -u ccc messages inbox -> メールボックス内のメール確認
  
  コマンドの実行結果
  --------------------------------------------------
  // aaa
  INBOX messages=0
  
  // bbb
  INBOX messages=0
  
  // ccc
  INBOX messages=1 -> メール転送された
  --------------------------------------------------
  
  vm12# cd $HOME
  vm12# doveadm expunge mailbox -u aaa inbox all -> メールボックス内のメール削除
  vm12# doveadm expunge mailbox -u bbb inbox all -> メールボックス内のメール削除
  vm12# doveadm expunge mailbox -u ccc inbox all -> メールボックス内のメール削除
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> 出力なし
  --------------------------------------------------
  
  vm12# cd ~bbb
  vm12# rm -f .forward
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> 出力なし
  --------------------------------------------------
  
  以下の確認に続く
  
================================================================================
[006]
  メール転送 - 02
  
[内容]
  ## 作業内容
    旧版から引用 => メール転送をコマンド(newaliases)で行う
  
  ## 使用マシン
    HOST : vm12
    IPV4 : 192.168.122.12
    MEMO : 仮想マシン
  
[確認]
  vm12# cd $HOME
  vm12# systemctl is-active dovecot
  
  コマンドの実行結果
  --------------------------------------------------
  active
  --------------------------------------------------
  
  ==================================================
              フィルタリングルール記述
  ==================================================
  
  vm12# cd $HOME
  vm12# vi /etc/aliases
  
  コマンドの実行結果
  --------------------------------------------------
  bbb: ccc -> 末尾に追加
  --------------------------------------------------
  
  vm12# cd $HOME
  vm12# newaliases
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> 出力なし
  --------------------------------------------------
  
  ==================================================
                スクリプトでメール送受信
  ==================================================
  
  vm12# cd $HOME
  vm12# bash send_mail.sh aaa bbb 1 -> AAAからBBBへ一通メール送信
  
  コマンドの実行結果
  --------------------------------------------------
  Trying ::1...
  Connected to localhost.
  Escape character is '^]'.
  220 vm12.example.com ESMTP Postfix
  250-vm12.example.com
  250-PIPELINING
  250-SIZE 10240000
  250-VRFY
  250-ETRN
  250-ENHANCEDSTATUSCODES
  250-8BITMIME
  250 DSN
  250 2.1.0 Ok
  250 2.1.5 Ok
  354 End data with <CR><LF>.<CR><LF>
  250 2.0.0 Ok: queued as 2D58B200AE33
  Connection closed by foreign host.
  --------------------------------------------------
  
  vm12# cd $HOME
  vm12# doveadm mailbox status -u aaa messages inbox -> メールボックス内のメール確認
  vm12# doveadm mailbox status -u bbb messages inbox -> メールボックス内のメール確認
  vm12# doveadm mailbox status -u ccc messages inbox -> メールボックス内のメール確認
  
  コマンドの実行結果
  --------------------------------------------------
  // aaa
  INBOX messages=0
  
  // bbb
  INBOX messages=0
  
  // ccc
  INBOX messages=1 -> メール転送された
  --------------------------------------------------
  
  vm12# cd $HOME
  vm12# doveadm expunge mailbox -u aaa inbox all -> メールボックス内のメール削除
  vm12# doveadm expunge mailbox -u bbb inbox all -> メールボックス内のメール削除
  vm12# doveadm expunge mailbox -u ccc inbox all -> メールボックス内のメール削除
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> 出力なし
  --------------------------------------------------
  
  vm12# cd $HOME
  vm12# vi /etc/aliases
  
  コマンドの実行結果
  --------------------------------------------------
  bbb: ccc -> 削除
  --------------------------------------------------
  
  vm12# cd $HOME
  vm12# newaliases
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> 出力なし
  --------------------------------------------------
  
  以下の確認に続く
  
================================================================================
[007]
  メール転送 - 03
  
[内容]
  ## 作業内容
    旧版から引用 => 簡易メーリングリストを作成する
  
  ## 使用マシン
    HOST : vm12
    IPV4 : 192.168.122.12
    MEMO : 仮想マシン
  
[確認]
  vm12# cd $HOME
  vm12# systemctl is-active dovecot
  
  コマンドの実行結果
  --------------------------------------------------
  active
  --------------------------------------------------
  
  ==================================================
              フィルタリングルール記述
  ==================================================
  
  vm12# cd $HOME
  vm12# vi /etc/MLIST -> ファイル内に所属アドレスを記述
  
  コマンドの実行結果
  --------------------------------------------------
  aaa@example.com
  bbb@example.com
  ccc@example.com
  --------------------------------------------------
  
  vm12# cd $HOME
  vm12# vi /etc/aliases
  
  コマンドの実行結果
  --------------------------------------------------
  MLIST: :include: /etc/MLIST -> 末尾に追加
  --------------------------------------------------
  
  vm12# cd $HOME
  vm12# newaliases
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> 出力なし
  --------------------------------------------------
  
  ==================================================
                スクリプトでメール送受信
  ==================================================
  
  vm12# cd $HOME
  vm12# bash send_mail.sh aaa MLIST 1 -> AAAからメーリングリストへメール送信
  
  コマンドの実行結果
  --------------------------------------------------
  Trying ::1...
  Connected to localhost.
  Escape character is '^]'.
  220 vm12.example.com ESMTP Postfix
  250-vm12.example.com
  250-PIPELINING
  250-SIZE 10240000
  250-VRFY
  250-ETRN
  250-ENHANCEDSTATUSCODES
  250-8BITMIME
  250 DSN
  250 2.1.0 Ok
  250 2.1.5 Ok
  354 End data with <CR><LF>.<CR><LF>
  250 2.0.0 Ok: queued as C0C20200AE12
  Connection closed by foreign host.
  --------------------------------------------------
  
  vm12# cd $HOME
  vm12# doveadm mailbox status -u aaa messages inbox -> メールボックス内のメール確認
  vm12# doveadm mailbox status -u bbb messages inbox -> メールボックス内のメール確認
  vm12# doveadm mailbox status -u ccc messages inbox -> メールボックス内のメール確認
  
  コマンドの実行結果
  --------------------------------------------------
  // aaa
  INBOX messages=1 -> メール転送された
  
  // bbb
  INBOX messages=1 -> メール転送された
  
  // ccc
  INBOX messages=1 -> メール転送された
  --------------------------------------------------
  
  vm12# cd $HOME
  vm12# doveadm expunge mailbox -u aaa inbox all -> メールボックス内のメール削除
  vm12# doveadm expunge mailbox -u bbb inbox all -> メールボックス内のメール削除
  vm12# doveadm expunge mailbox -u ccc inbox all -> メールボックス内のメール削除
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> 出力なし
  --------------------------------------------------
  
  vm12# cd $HOME
  vm12# vi /etc/aliases
  
  コマンドの実行結果
  --------------------------------------------------
  MLIST: :include: /etc/MLIST -> 削除
  --------------------------------------------------
  
  vm12# cd $HOME
  vm12# newaliases
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> 出力なし
  --------------------------------------------------
  
  以下の確認に続く
  
================================================================================
[008]
  Procmail - 01
  
[内容]
  ## 作業内容
    旧版から引用 => メール配送プログラムを「Procmail」に変更する
    (http://linux.kororo.jp/cont/server/procmail.php)
  
  ## 使用マシン
    HOST : vm12
    IPV4 : 192.168.122.12
    MEMO : 仮想マシン
  
[確認]
  vm12# cd $HOME
  vm12# yum -y install procmail
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> エラー出力が無ければOK
  --------------------------------------------------
  
  vm12# cd $HOME
  vm12# which procmail
  
  コマンドの実行結果
  --------------------------------------------------
  /bin/procmail
  --------------------------------------------------
  
  vm12# cd $HOME
  vm12# vi /etc/postfix/main.cf -> ローカル配送プログラムを変更
  
  コマンドの実行結果
  --------------------------------------------------
  (修正前)
  mailbox_command = /usr/libexec/dovecot/deliver -f "$SENDER" -a "$RECIPIENT"
  
  (修正後)
  mailbox_command = /bin/procmail
  --------------------------------------------------
  
  vm12# cd $HOME
  vm12# vi /etc/procmailrc
  
  コマンドの実行結果
  --------------------------------------------------
  ## ログファイル名
  LOGFILE=$HOME/.procmail.log
  
  ## メールの保存ディレクトリ
  MAILDIR=$HOME/Maildir/
  
  ## デフォルト
  DEFAULT=$MAILDIR
  --------------------------------------------------
  
  vm12# cd $HOME
  vm12# systemctl restart postfix
  
  コマンドの実行結果
  --------------------------------------------------
  /bin/procmail
  --------------------------------------------------
  
  vm12# cd $HOME
  vm12# vi ~aaa/.forward
  vm12# vi ~bbb/.forward
  vm12# vi ~ccc/.forward
  
  コマンドの実行結果
  --------------------------------------------------
  "|IFS=' ' && exec /usr/bin/procmail -f- || exit 75 #~/Maildir/"
  --------------------------------------------------
  
  vm12# cd $HOME
  vm12# chown aaa.aaa ~aaa/.forward
  vm12# chown bbb.bbb ~bbb/.forward
  vm12# chown ccc.ccc ~ccc/.forward
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> 出力なし
  --------------------------------------------------
  
  ==================================================
                スクリプトでメール送受信
  ==================================================
  
  vm12# cd $HOME
  vm12# bash send_mail.sh aaa bbb 1 -> AAAからBBBへメール送信
  
  コマンドの実行結果
  --------------------------------------------------
  Trying ::1...
  Connected to localhost.
  Escape character is '^]'.
  220 vm12.example.com ESMTP Postfix
  250-vm12.example.com
  250-PIPELINING
  250-SIZE 10240000
  250-VRFY
  250-ETRN
  250-ENHANCEDSTATUSCODES
  250-8BITMIME
  250 DSN
  250 2.1.0 Ok
  250 2.1.5 Ok
  354 End data with <CR><LF>.<CR><LF>
  250 2.0.0 Ok: queued as 6C9C6200AE33
  Connection closed by foreign host.
  --------------------------------------------------
  
  vm12# cd $HOME
  vm12# doveadm mailbox status -u aaa messages inbox -> メールボックス内のメール確認
  vm12# doveadm mailbox status -u bbb messages inbox -> メールボックス内のメール確認
  vm12# doveadm mailbox status -u ccc messages inbox -> メールボックス内のメール確認
  
  コマンドの実行結果
  --------------------------------------------------
  // aaa
  INBOX messages=0
  
  // bbb
  INBOX messages=1 -> メール送信された
  
  // ccc
  INBOX messages=0
  --------------------------------------------------
  
  vm12# cd ~bbb
  vm12# cat .procmail.log -> ローカル配送プログラムのログ確認
  
  コマンドの実行結果
  --------------------------------------------------
  From aaa@example.com  Thu Feb  3 11:05:00 2022
    Subject: test1
      Folder: /home/bbb/Maildir/new/1643853900.1690_0.vm12
  --------------------------------------------------
  
  vm12# cd $HOME
  vm12# doveadm expunge mailbox -u aaa inbox all -> メールボックス内のメール削除
  vm12# doveadm expunge mailbox -u bbb inbox all -> メールボックス内のメール削除
  vm12# doveadm expunge mailbox -u ccc inbox all -> メールボックス内のメール削除
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> 出力なし
  --------------------------------------------------
  
  以下の確認に続く
  
================================================================================
[009]
  Procmail - 02
  
[内容]
  ## 作業内容
    旧版から引用 => メール配送プログラム(Procmail)を使用してメールフィルタリングを行う
  
  ## 使用マシン
    HOST : vm12
    IPV4 : 192.168.122.12
    MEMO : 仮想マシン
  
[確認]
  vm12# cd $HOME
  vm12# systemctl is-active postfix
  
  コマンドの実行結果
  --------------------------------------------------
  active
  --------------------------------------------------
  
  ==================================================
              フィルタリングルール記述
  ==================================================
  
  vm12# cd ~bbb
  vm12# vi .procmailrc
  
  コマンドの実行結果
  --------------------------------------------------
  ## 差出が「aaa@example.com」の場合はメール破棄
  :0
  * ^From:.*aaa@example\.com.*
  /dev/null
  --------------------------------------------------
  
  vm12# cd ~bbb
  vm12# chown bbb.bbb .procmailrc
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> 出力なし
  --------------------------------------------------
  
  ==================================================
                スクリプトでメール送受信
  ==================================================
  
  vm12# cd $HOME
  vm12# bash send_mail.sh aaa bbb 1 -> AAAからBBBへ一通メール送信
  
  コマンドの実行結果
  --------------------------------------------------
  Trying ::1...
  Connected to localhost.
  Escape character is '^]'.
  220 vm12.example.com ESMTP Postfix
  250-vm12.example.com
  250-PIPELINING
  250-SIZE 10240000
  250-VRFY
  250-ETRN
  250-ENHANCEDSTATUSCODES
  250-8BITMIME
  250 DSN
  250 2.1.0 Ok
  250 2.1.5 Ok
  354 End data with <CR><LF>.<CR><LF>
  250 2.0.0 Ok: queued as 92025200AE3E
  Connection closed by foreign host.
  --------------------------------------------------
  
  vm12# cd $HOME
  vm12# doveadm mailbox status -u aaa messages inbox -> メールボックス内のメール確認
  vm12# doveadm mailbox status -u bbb messages inbox -> メールボックス内のメール確認
  vm12# doveadm mailbox status -u ccc messages inbox -> メールボックス内のメール確認
  
  コマンドの実行結果
  --------------------------------------------------
  // aaa
  INBOX messages=0

  // bbb
  INBOX messages=0 -> 送付したメールは廃棄された
  
  // ccc
  INBOX messages=0
  --------------------------------------------------
  
  vm12# cd ~bbb
  vm12# cat .procmail.log -> ローカル配送プログラムのログ確認
  
  コマンドの実行結果
  --------------------------------------------------
  From aaa@example.com  Thu Feb  3 12:27:49 2022
    Subject: test1
      Folder: /dev/null 482
  --------------------------------------------------
  
  vm12# cd $HOME
  vm12# doveadm expunge mailbox -u aaa inbox all -> メールボックス内のメール削除
  vm12# doveadm expunge mailbox -u bbb inbox all -> メールボックス内のメール削除
  vm12# doveadm expunge mailbox -u ccc inbox all -> メールボックス内のメール削除
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> 出力なし
  --------------------------------------------------
  
  以下の確認に続く
  
================================================================================
[010]
  Procmail - 03
  
[内容]
  ## 作業内容
    旧版から引用 => メール配送プログラム(Procmail)を使用してメールフィルタリングを行う
  
  ## 使用マシン
    HOST : vm12
    IPV4 : 192.168.122.12
    MEMO : 仮想マシン
  
[確認]
  vm12# cd $HOME
  vm12# systemctl is-active postfix
  
  コマンドの実行結果
  --------------------------------------------------
  active
  --------------------------------------------------
  
  ==================================================
              フィルタリングルール記述
  ==================================================
  
  vm12# cd ~bbb
  vm12# vi .procmailrc
  
  コマンドの実行結果
  --------------------------------------------------
  ## 差出が「aaa@example.com」の場合は指定フォルダ「AAA」に格納
  :0
  * ^From:.*aaa@example\.com.*
  AAA/.(ディレクトリ内にメールを連番で格納)
  --------------------------------------------------
  
  vm12# cd ~bbb
  vm12# mkdir AAA ; chown bbb.bbb AAA -> 指定フォルダ作成と所有者変更
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> 出力なし
  --------------------------------------------------
  
  ==================================================
                スクリプトでメール送受信
  ==================================================
  
  vm12# cd $HOME
  vm12# bash send_mail.sh aaa bbb 3 -> AAAからBBBへ三通メール送信
  
  コマンドの実行結果
  --------------------------------------------------
  // 一通目
  Trying ::1...
  Connected to localhost.
  Escape character is '^]'.
  220 vm12.example.com ESMTP Postfix
  250-vm12.example.com
  250-PIPELINING
  250-SIZE 10240000
  250-VRFY
  250-ETRN
  250-ENHANCEDSTATUSCODES
  250-8BITMIME
  250 DSN
  250 2.1.0 Ok
  250 2.1.5 Ok
  354 End data with <CR><LF>.<CR><LF>
  250 2.0.0 Ok: queued as ED9C3200AE3E
  Connection closed by foreign host.

  // 二通目
  Trying ::1...
  Connected to localhost.
  Escape character is '^]'.
  220 vm12.example.com ESMTP Postfix
  250-vm12.example.com
  250-PIPELINING
  250-SIZE 10240000
  250-VRFY
  250-ETRN
  250-ENHANCEDSTATUSCODES
  250-8BITMIME
  250 DSN
  250 2.1.0 Ok
  250 2.1.5 Ok
  354 End data with <CR><LF>.<CR><LF>
  250 2.0.0 Ok: queued as F3E60200AE3E
  Connection closed by foreign host.

  // 三通目
  Trying ::1...
  Connected to localhost.
  Escape character is '^]'.
  220 vm12.example.com ESMTP Postfix
  250-vm12.example.com
  250-PIPELINING
  250-SIZE 10240000
  250-VRFY
  250-ETRN
  250-ENHANCEDSTATUSCODES
  250-8BITMIME
  250 DSN
  250 2.1.0 Ok
  250 2.1.5 Ok
  354 End data with <CR><LF>.<CR><LF>
  250 2.0.0 Ok: queued as 0D9BA200AE3F
  Connection closed by foreign host.
  --------------------------------------------------
  
  vm12# cd $HOME
  vm12# doveadm mailbox status -u aaa messages inbox -> メールボックス内のメール確認
  vm12# doveadm mailbox status -u bbb messages inbox -> メールボックス内のメール確認
  vm12# doveadm mailbox status -u ccc messages inbox -> メールボックス内のメール確認
  
  コマンドの実行結果
  --------------------------------------------------
  // aaa
  INBOX messages=0
  
  // bbb
  INBOX messages=0 -> 指定フォルダ「AAA」内のメール件数を取得する方法が見つからなかった…
  
  // ccc
  INBOX messages=0
  --------------------------------------------------
  
  vm12# cd ~bbb
  vm12# cat .procmail.log -> ローカル配送プログラムのログ確認
  
  コマンドの実行結果
  --------------------------------------------------
  From aaa@example.com  Thu Feb  3 12:55:33 2022
    Subject: test1
      Folder: AAA/1    483
  From aaa@example.com  Thu Feb  3 12:55:42 2022
    Subject: test2
      Folder: AAA/2    483
  From aaa@example.com  Thu Feb  3 12:55:51 2022
    Subject: test3
      Folder: AAA/3    483
  --------------------------------------------------
  
  vm12# cd ~bbb/Maildir/AAA
  vm12# ls -lh
  
  コマンドの実行結果
  --------------------------------------------------
  -rw-------. 1 bbb bbb 483  2月  3 12:55 1
  -rw-------. 1 bbb bbb 483  2月  3 12:55 2
  -rw-------. 1 bbb bbb 483  2月  3 12:55 3
  --------------------------------------------------
  
  vm12# cd ~bbb/Maildir/AAA
  vm12# cat 1 2 3
  
  コマンドの実行結果
  --------------------------------------------------
  // 一通目
  From aaa@example.com  Thu Feb  3 12:55:33 2022
  Return-Path: <aaa@example.com>
  X-Original-To: bbb@example.com
  Delivered-To: bbb@example.com
  Received: from localhost (localhost [IPv6:::1])
    by vm12.example.com (Postfix) with ESMTP id ED9C3200AE3E
    for <bbb@example.com>; Thu,  3 Feb 2022 12:55:25 +0900 (JST)
  from: aaa@example.com
  to: bbb@example.com
  Subject: test1
  Message-Id: <20220203035526.ED9C3200AE3E@vm12.example.com>
  Date: Thu,  3 Feb 2022 12:55:25 +0900 (JST)
  
  I sent test1.
  
  // 二通目
  From aaa@example.com  Thu Feb  3 12:55:42 2022
  Return-Path: <aaa@example.com>
  X-Original-To: bbb@example.com
  Delivered-To: bbb@example.com
  Received: from localhost (localhost [IPv6:::1])
    by vm12.example.com (Postfix) with ESMTP id F3E60200AE3E
    for <bbb@example.com>; Thu,  3 Feb 2022 12:55:34 +0900 (JST)
  from: aaa@example.com
  to: bbb@example.com
  Subject: test2
  Message-Id: <20220203035535.F3E60200AE3E@vm12.example.com>
  Date: Thu,  3 Feb 2022 12:55:34 +0900 (JST)
  
  I sent test2.
  
  // 三通目
  From aaa@example.com  Thu Feb  3 12:55:51 2022
  Return-Path: <aaa@example.com>
  X-Original-To: bbb@example.com
  Delivered-To: bbb@example.com
  Received: from localhost (localhost [IPv6:::1])
    by vm12.example.com (Postfix) with ESMTP id 0D9BA200AE3F
    for <bbb@example.com>; Thu,  3 Feb 2022 12:55:44 +0900 (JST)
  from: aaa@example.com
  to: bbb@example.com
  Subject: test3
  Message-Id: <20220203035545.0D9BA200AE3F@vm12.example.com>
  Date: Thu,  3 Feb 2022 12:55:44 +0900 (JST)
  
  I sent test3.
  --------------------------------------------------
  
  vm12# cd $HOME
  vm12# doveadm expunge mailbox -u aaa inbox all -> メールボックス内のメール削除
  vm12# doveadm expunge mailbox -u bbb inbox all -> メールボックス内のメール削除
  vm12# doveadm expunge mailbox -u ccc inbox all -> メールボックス内のメール削除
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> 出力なし
  --------------------------------------------------
  
  以下の確認に続く
  
================================================================================
[011]
  Procmail - 04
  
[内容]
  ## 作業内容
    旧版から引用 => メール配送プログラム(Procmail)を使用してメールフィルタリングを行う
  
  ## 使用マシン
    HOST : vm12
    IPV4 : 192.168.122.12
    MEMO : 仮想マシン
  
[確認]
  vm12# cd $HOME
  vm12# systemctl is-active postfix
  
  コマンドの実行結果
  --------------------------------------------------
  active
  --------------------------------------------------
  
  ==================================================
              フィルタリングルール記述
  ==================================================
  
  vm12# cd ~bbb
  vm12# vi .procmailrc
  
  コマンドの実行結果
  --------------------------------------------------
  ## 差出が「aaa@example.com」の場合、アドレス「ccc@example.com」に転送
  :0
  * ^From:.*aaa@example\.com.*
  !ccc@example.com
  --------------------------------------------------
  
  ==================================================
                スクリプトでメール送受信
  ==================================================
  
  vm12# cd $HOME
  vm12# bash send_mail.sh aaa bbb 1 -> AAAからBBBへ一通メール送信
  
  コマンドの実行結果
  --------------------------------------------------
  Trying ::1...
  Connected to localhost.
  Escape character is '^]'.
  220 vm12.example.com ESMTP Postfix
  250-vm12.example.com
  250-PIPELINING
  250-SIZE 10240000
  250-VRFY
  250-ETRN
  250-ENHANCEDSTATUSCODES
  250-8BITMIME
  250 DSN
  250 2.1.0 Ok
  250 2.1.5 Ok
  354 End data with <CR><LF>.<CR><LF>
  250 2.0.0 Ok: queued as B82E5200AE3E
  Connection closed by foreign host.
  --------------------------------------------------
  
  vm12# cd $HOME
  vm12# doveadm mailbox status -u aaa messages inbox -> メールボックス内のメール確認
  vm12# doveadm mailbox status -u bbb messages inbox -> メールボックス内のメール確認
  vm12# doveadm mailbox status -u ccc messages inbox -> メールボックス内のメール確認
  
  コマンドの実行結果
  --------------------------------------------------
  // aaa
  INBOX messages=0
  
  // bbb
  INBOX messages=0
  
  // ccc
  INBOX messages=1 -> メール転送された
  --------------------------------------------------
  
  vm12# cd ~bbb
  vm12# cat .procmail.log -> ローカル配送プログラムのログ確認
  
  コマンドの実行結果
  --------------------------------------------------
  From aaa@example.com  Thu Feb  3 13:37:39 2022
    Subject: test1
      Folder: /usr/sbin/sendmail -oi ccc@example.com  436
  --------------------------------------------------
  
  vm12# cd $HOME
  vm12# doveadm expunge mailbox -u aaa inbox all -> メールボックス内のメール削除
  vm12# doveadm expunge mailbox -u bbb inbox all -> メールボックス内のメール削除
  vm12# doveadm expunge mailbox -u ccc inbox all -> メールボックス内のメール削除
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> 出力なし
  --------------------------------------------------
  
  以下の確認に続く
  
================================================================================
[012]
  SMTP-AUTH
  
[内容]
  ## 作業内容
    旧版から引用 => 認証機能の無いSMTPサーバー(Postfix)に認証プログラム(Saslauthd)を導入する
  
  ## 使用マシン
    HOST : vm12
    IPV4 : 192.168.122.12
    MEMO : 仮想マシン
  
[確認]
  vm12# cd $HOME
  vm12# firewall-cmd --add-port=587/tcp --permanent
  
  コマンドの実行結果
  --------------------------------------------------
  success
  --------------------------------------------------
  
  vm12# cd $HOME
  vm12# firewall-cmd --reload
  
  コマンドの実行結果
  --------------------------------------------------
  success
  --------------------------------------------------
  
  vm12# cd $HOME
  vm12# yum -y install cyrus-sasl cyrus-sasl-plain
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> 出力なし
  --------------------------------------------------
  
  ==================================================
              認証プログラム(Saslauthd)
  ==================================================
  
  vm12# cd $HOME
  vm12# saslauthd -v -> 使用可能な認証タイプを出力
  
  コマンドの実行結果
  --------------------------------------------------
  saslauthd 2.1.26
  authentication mechanisms: getpwent kerberos5 pam rimap shadow ldap httpform  // shadow -> /etc/shadow
  --------------------------------------------------
  
  vm12# cd $HOME
  vm12# vi /etc/sysconfig/saslauthd
  
  コマンドの実行結果
  --------------------------------------------------
  (修正前)
  MECH=pam
  
  (修正後)
  MECH=shadow  -> システムの「/etc/shadow」を認証時に参照
  --------------------------------------------------
  
  vm12# cd $HOME
  vm12# systemctl enable saslauthd
  
  コマンドの実行結果
  --------------------------------------------------
  (省略)
  --------------------------------------------------
  
  vm12# cd $HOME
  vm12# systemctl start saslauthd
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> 出力なし
  --------------------------------------------------
  
  ==================================================
                    SMTP(Postfix)
  ==================================================
  
  vm12# cd /etc/postfix
  vm12# vi main.cf
  
  コマンドの実行結果
  --------------------------------------------------
  smtpd_sasl_auth_enable = yes               // SASL認証を有効化
  smtpd_sasl_security_options = noanonymous  // 匿名接続を拒否
  smtpd_recipient_restrictions = permit_mynetworks, permit_sasl_authenticated, reject_unauth_destination
  --------------------------------------------------
  
  vm12# cd /etc/postfix
  vm12# cp -p master.cf master.cf.org
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> 出力なし
  --------------------------------------------------
  
  vm12# cd /etc/postfix
  vm12# vi master.cf
  
  コマンドの実行結果
  --------------------------------------------------
  # service   type  private  unpriv  chroot  wakeup   maxproc  command + args
  submission  inet  n        -       n       -        -        smtpd
  
  // SASL認証を有効化
  -o smtpd_sasl_auth_enable=yes

  // SASL認証されたクライアントのみ許可
  -o smtpd_client_restrictions=permit_sasl_authenticated,reject
  --------------------------------------------------
  
  vm12# cd $HOME
  vm12# systemctl restart postfix
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> 出力なし
  --------------------------------------------------
  
  ==================================================
                  SASL認証(単体テスト)
  ==================================================
  
  vm12# cd $HOME
  vm12# testsaslauthd -u aaa -p aa0122ma -> SASL認証のテスト
  vm12# testsaslauthd -u bbb -p bb0122ma -> SASL認証のテスト
  vm12# testsaslauthd -u ccc -p cc0122ma -> SASL認証のテスト
  
  コマンドの実行結果
  --------------------------------------------------
  // aaa
  0: NO "authentication failed"

  // bbb
  0: NO "authentication failed"

  // ccc
  0: NO "authentication failed"
  --------------------------------------------------
  
  vm12# cd $HOME
  vm12# less /var/log/messages -> SASL認証のログ確認
  
  コマンドの実行結果
  --------------------------------------------------
  // aaa -> /etc/shadow 参照時に失敗
  Feb  4 06:50:11 vm12 saslauthd[1304] ...
  auth failure: [user=aaa] ... [mech=shadow] [reason=Username shadow lookup failure: No such file or directory]
  
  // bbb -> /etc/shadow 参照時に失敗
  Feb  4 06:50:40 vm12 saslauthd[1304] ...
  auth failure: [user=bbb] ... [mech=shadow] [reason=Username shadow lookup failure: No such file or directory]
  
  // ccc -> /etc/shadow 参照時に失敗
  Feb  4 06:51:05 vm12 saslauthd[1304] ...
  auth failure: [user=ccc] ... [mech=shadow] [reason=Username shadow lookup failure: No such file or directory]
  --------------------------------------------------
  
  vm12# cd $HOME
  vm12# getenforce -> SELinuxの確認
  
  コマンドの実行結果
  --------------------------------------------------
  Enforcing -> 有効
  --------------------------------------------------
  
  vm12# cd $HOME
  vm12# setsebool saslauthd_read_shadow on -> 認証プログラム「Saslauthd」にファイル「/etc/shadow」へアクセス許可
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> 出力なし
  --------------------------------------------------
  
  vm12# cd $HOME
  vm12# testsaslauthd -u aaa -p aa0122ma -> SASL認証のテスト
  vm12# testsaslauthd -u bbb -p bb0122ma -> SASL認証のテスト
  vm12# testsaslauthd -u ccc -p cc0122ma -> SASL認証のテスト
  
  コマンドの実行結果
  --------------------------------------------------
  // aaa
  0: OK "Success."
  
  // bbb
  0: OK "Success."
  
  // ccc
  0: OK "Success."
  --------------------------------------------------
  
  ==================================================
                SASL認証(AUTH-PLAIN方式)
  ==================================================
  
  vm12# cd $HOME -> AUTH-PLAIN時の認証文字列を出力
  vm12# printf "%s\0%s\0%s" aaa@example.jp aaa@example.jp aa0122ma | openssl base64 -e | tr -d '\n'; echo
  vm12# printf "%s\0%s\0%s" bbb@example.jp bbb@example.jp bb0122ma | openssl base64 -e | tr -d '\n'; echo
  vm12# printf "%s\0%s\0%s" ccc@example.jp ccc@example.jp cc0122ma | openssl base64 -e | tr -d '\n'; echo
  
  コマンドの実行結果
  --------------------------------------------------
  // aaa
  YWFhQGV4YW1wbGUuanAAYWFhQGV4YW1wbGUuanAAYWEwMTIybWE=
  
  // bbb
  YmJiQGV4YW1wbGUuanAAYmJiQGV4YW1wbGUuanAAYmIwMTIybWE=
  
  // ccc
  Y2NjQGV4YW1wbGUuanAAY2NjQGV4YW1wbGUuanAAY2MwMTIybWE=
  --------------------------------------------------
  
  vm12# cd $HOME
  vm12# telnet localhost 587 -> 認証プログラム経由でSMTPサーバーに接続
  
  コマンドの実行結果
  --------------------------------------------------
  Trying ::1...
  Connected to localhost.
  Escape character is '^]'.
  220 vm12.example.com ESMTP Postfix
    
  // 接続準備
  ehlo localhost
  250-vm12.example.com
  250-PIPELINING
  250-SIZE 10240000
  250-VRFY
  250-ETRN
  250-AUTH PLAIN LOGIN  // AUTH-PLAIN, AUTH-LOGIN を確認
  250-ENHANCEDSTATUSCODES
  250-8BITMIME
  250 DSN
  
  // AUTH-PLAIN方式で認証
  auth plain YWFhQGV4YW1wbGUuanAAYWFhQGV4YW1wbGUuanAAYWEwMTIybWE=  // aaa@example.jp aaa@example.jp aa0122ma
  235 2.7.0 Authentication successful
  
  // AUTH-PLAIN方式で認証
  auth plain YmJiQGV4YW1wbGUuanAAYmJiQGV4YW1wbGUuanAAYmIwMTIybWE=  // bbb@example.jp bbb@example.jp bb0122ma
  235 2.7.0 Authentication successful
  
  // AUTH-PLAIN方式で認証
  auth plain Y2NjQGV4YW1wbGUuanAAY2NjQGV4YW1wbGUuanAAY2MwMTIybWE=  // ccc@example.jp ccc@example.jp cc0122ma
  235 2.7.0 Authentication successful

  // ログアウト
  quit
  221 2.0.0 Bye
  Connection closed by foreign host.
  --------------------------------------------------
  
  ==================================================
                SASL認証(AUTH-LOGIN方式)
  ==================================================
  
  vm12# cd $HOME
  vm12# echo -n aaa | base64 -> ユーザー名のエンコード
  vm12# echo -n bbb | base64 -> ユーザー名のエンコード
  vm12# echo -n ccc | base64 -> ユーザー名のエンコード
  
  コマンドの実行結果
  --------------------------------------------------
  YWFh  // aaa
  YmJi  // bbb
  Y2Nj  // ccc
  --------------------------------------------------
  
  vm12# cd $HOME
  vm12# echo -n aa0122ma | base64 -> パスワードのエンコード
  vm12# echo -n bb0122ma | base64 -> パスワードのエンコード
  vm12# echo -n cc0122ma | base64 -> パスワードのエンコード
  
  コマンドの実行結果
  --------------------------------------------------
  YWEwMTIybWE=  // aaa
  YmIwMTIybWE=  // bbb
  Y2MwMTIybWE=  // ccc
  --------------------------------------------------
  
  vm12# cd $HOME
  vm12# telnet localhost 587 -> 認証プログラム経由でSMTPサーバーに接続
  
  コマンドの実行結果
  --------------------------------------------------
  Trying ::1...
  Connected to localhost.
  Escape character is '^]'.
  220 vm12.example.com ESMTP Postfix
  
  // 接続準備
  ehlo localhost
  250-vm12.example.com
  250-PIPELINING
  250-SIZE 10240000
  250-VRFY
  250-ETRN
  250-AUTH PLAIN LOGIN  // AUTH-PLAIN, AUTH-LOGIN を確認
  250-ENHANCEDSTATUSCODES
  250-8BITMIME
  250 DSN
  
  // AUTH-LOGIN方式で認証
  auth login
  334 VXNlcm5hbWU6
  
  // ユーザー名をエンコード状態で入力 - aaa
  YWFh
  334 UGFzc3dvcmQ6
  
  // パスワードをエンコード状態で入力 - aa0122ma
  YWEwMTIybWE=
  235 2.7.0 Authentication successful
  
  // ユーザー名をエンコード状態で入力 - bbb
  YmJi
  334 UGFzc3dvcmQ6
  
  // パスワードをエンコード状態で入力 - bb0122ma
  YmIwMTIybWE=
  235 2.7.0 Authentication successful

  // ユーザー名をエンコード状態で入力 - ccc
  Y2Nj
  334 UGFzc3dvcmQ6
  
  // パスワードをエンコード状態で入力 - cc0122ma
  Y2MwMTIybWE=
  235 2.7.0 Authentication successful
    
  // ログアウト
  quit
  221 2.0.0 Bye
  Connection closed by foreign host.
  --------------------------------------------------
  
  ==================================================
                    スクリプト修正
  ==================================================
  
  vm12# cd $HOME
  vm12# vi send_mail.sh
  
  コマンドの実行結果
  --------------------------------------------------
  #!/bin/bash
  
  ## 関数定義
  function send_mail () {
    echo "ehlo localhost"
    sleep 1
    echo "auth login"
    sleep 1
    echo "$(echo -n $1 | base64)"  // AUTH-LOGIN方式のユーザー名
    sleep 1
    echo "$(echo -n $2 | base64)"  // AUTH-LOGIN方式のパスワード
    sleep 1
    echo "mail from: $3@example.com"
    sleep 1
    echo "rcpt to: $4@example.com"
    sleep 1
    echo "data"
    sleep 1
    echo "from: $3@example.com"
    sleep 1
    echo "to: $4@example.com"
    sleep 1
    echo "Subject: test$5"
    sleep 1
    echo "I sent test$5."
    sleep 1
    echo "."
    sleep 1
    echo "quit"
  }
  
  ## サーバーにコマンド送信
  for i in $(seq 1 $5) ; do
    send_mail $1 $2 $3 $4 $i | telnet localhost 25;
  done
  --------------------------------------------------
  
  ==================================================
                スクリプトでメール送受信
  ==================================================
  
  vm12# cd $HOME
  vm12# bash send_mail.sh aaa aa0122ma aaa bbb 1 -> AAAからBBBへ一通メール送信
  
  コマンドの実行結果
  --------------------------------------------------
  Trying ::1...
  Connected to localhost.
  Escape character is '^]'.
  220 vm12.example.com ESMTP Postfix
  250-vm12.example.com
  250-PIPELINING
  250-SIZE 10240000
  250-VRFY
  250-ETRN
  250-AUTH PLAIN LOGIN
  250-ENHANCEDSTATUSCODES
  250-8BITMIME
  250 DSN
  334 VXNlcm5hbWU6                     // auth login
  334 UGFzc3dvcmQ6                     // aaa
  235 2.7.0 Authentication successful  // aa0122ma
  250 2.1.0 Ok
  250 2.1.5 Ok
  354 End data with <CR><LF>.<CR><LF>
  250 2.0.0 Ok: queued as F1281200B112
  Connection closed by foreign host.
  --------------------------------------------------
  
  vm12# cd $HOME
  vm12# doveadm mailbox status -u aaa messages inbox -> メールボックス内のメール確認
  vm12# doveadm mailbox status -u bbb messages inbox -> メールボックス内のメール確認
  vm12# doveadm mailbox status -u ccc messages inbox -> メールボックス内のメール確認
  
  コマンドの実行結果
  --------------------------------------------------
  // aaa
  INBOX messages=0
  
  // bbb
  INBOX messages=0
  
  // ccc
  INBOX messages=1 -> 前回のメール転送設定がそのままで「ccc@example.com」に転送されただけなのでOK
  --------------------------------------------------
  
  vm12# cd $HOME
  vm12# doveadm expunge mailbox -u aaa inbox all -> メールボックス内のメール削除
  vm12# doveadm expunge mailbox -u bbb inbox all -> メールボックス内のメール削除
  vm12# doveadm expunge mailbox -u ccc inbox all -> メールボックス内のメール削除
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> 出力なし
  --------------------------------------------------
  
  以下の確認に続く
  
================================================================================
[013]
  SpamAssassin
  
[内容]
  ## 作業内容
    旧版から引用 => スパムフィルタリングを行う

    参考資料1 : https://centossrv.com/postfix-spamass-milter.shtml
    参考資料2 : https://www.bigbang.mydns.jp/spamassassin-x.htm
    参考資料3 : https://korodes.com/rocky/rocky_08/
  
  ## 使用マシン
    HOST : vm12
    IPV4 : 192.168.122.12
    MEMO : 仮想マシン
  
[確認]
  vm12# cd $HOME
  vm12# yum -y install epel-release
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> エラー出力が無ければOK
  --------------------------------------------------
  
  vm12# cd $HOME
  vm12# yum -y install wget unzip zip
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> エラー出力が無ければOK
  --------------------------------------------------
  
  vm12# cd $HOME
  vm12# yum -y install spamassassin spamass-milter-postfix
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> エラー出力が無ければOK
  --------------------------------------------------
  
  ##vm12# cd $HOME
  ##vm12# curl -s https://packagecloud.io/install/repositories/milter-manager/repos/script.rpm.sh | bash
  ##
  ##コマンドの実行結果
  ##--------------------------------------------------
  ##(省略) -> エラー出力が無ければOK
  ##--------------------------------------------------
  
  ##vm12# cd $HOME
  ##vm12# yum -y --skip-broken install milter-manager
  ##
  ##コマンドの実行結果
  ##--------------------------------------------------
  ##(省略) -> エラー出力が無ければOK
  ##--------------------------------------------------
  
  ==================================================
                    SpamAssassin
  ==================================================
  
  vm12# cd /etc/mail/spamassassin
  vm12# vi v310.pre
  
  コマンドの実行結果
  --------------------------------------------------
  (修正前)
  # TextCat - language guesser
  #
  # loadplugin Mail::SpamAssassin::Plugin::TextCat

  (修正後)
  # TextCat - language guesser
  #
  loadplugin Mail::SpamAssassin::Plugin::TextCat
  --------------------------------------------------
  
  vm12# cd /etc/mail/spamassassin
  vm12# cp -p local.cf local.cf.org
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> 出力なし
  --------------------------------------------------
  
  vm12# cd $HOME -> 最新の設定ファイルのダウンロード
  vm12# wget -q https://github.com/kittyfreak/spamassassin_user_prefs/archive/refs/heads/main.zip
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> 出力なし
  --------------------------------------------------
  
  vm12# cd $HOME
  vm12# unzip -q main.zip
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> 出力なし
  --------------------------------------------------
  
  vm12# cd $HOME
  vm12# ls -lh
  
  コマンドの実行結果
  --------------------------------------------------
  drwxr-xr-x. 2 root root   24 12月 29 00:02 spamassassin_user_prefs-main
  --------------------------------------------------
  
  vm12# cd $HOME/spamassassin_user_prefs-main
  vm12# cp -f user_prefs /etc/mail/spamassassin/local.cf
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> 出力なし
  --------------------------------------------------
  
  vm12# cd /etc/mail/spamassassin
  vm12# vi local.cf
  
  コマンドの実行結果
  --------------------------------------------------
  (末尾に追加)
  report_safe 0
  rewrite_header Subject ***SPAM***
  --------------------------------------------------
  
  vm12# cd $HOME
  vm12# systemctl enable spamassassin
  
  コマンドの実行結果
  --------------------------------------------------
  (省略)
  --------------------------------------------------
  
  vm12# cd $HOME
  vm12# systemctl start spamassassin
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> 出力なし
  --------------------------------------------------
  
  ==================================================
                    SpamAss-Milter
  ==================================================
  
  vm12# cd $HOME
  vm12# systemctl enable spamass-milter
  
  コマンドの実行結果
  --------------------------------------------------
  (省略)
  --------------------------------------------------
  
  vm12# cd $HOME
  vm12# systemctl start spamass-milter
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> 出力なし
  --------------------------------------------------
  
  ==================================================
                       Procmail
  ==================================================
  
  vm12# cd $HOME
  vm12# vi /etc/procmailrc
  
  コマンドの実行結果
  --------------------------------------------------
  ## ログファイル名
  LOGFILE=$HOME/.procmail.log
  
  ## メールの保存ディレクトリ
  MAILDIR=$HOME/Maildir/
  
  ## デフォルト
  DEFAULT=$MAILDIR
  
  ## スパムチェック
  :0fw
  |/bin/spamc
  --------------------------------------------------
  
  ==================================================
            スクリプトで通常メール送受信
  ==================================================
  
  vm12# cd $HOME
  vm12# bash send_mail.sh aaa aa0122ma aaa ccc 1 -> AAAからCCCへ一通メール送信
  
  コマンドの実行結果
  --------------------------------------------------
  Trying ::1...
  Connected to localhost.
  Escape character is '^]'.
  220 vm12.example.com ESMTP Postfix
  250-vm12.example.com
  250-PIPELINING
  250-SIZE 10240000
  250-VRFY
  250-ETRN
  250-AUTH PLAIN LOGIN
  250-ENHANCEDSTATUSCODES
  250-8BITMIME
  250 DSN
  334 VXNlcm5hbWU6
  334 UGFzc3dvcmQ6
  235 2.7.0 Authentication successful
  250 2.1.0 Ok
  250 2.1.5 Ok
  354 End data with <CR><LF>.<CR><LF>
  250 2.0.0 Ok: queued as 2090E2019D51
  Connection closed by foreign host.
  --------------------------------------------------
  
  vm12# cd $HOME
  vm12# doveadm mailbox status -u aaa messages inbox -> メールボックス内のメール確認
  vm12# doveadm mailbox status -u bbb messages inbox -> メールボックス内のメール確認
  vm12# doveadm mailbox status -u ccc messages inbox -> メールボックス内のメール確認
  
  コマンドの実行結果
  --------------------------------------------------
  // aaa
  INBOX messages=0
  
  // bbb
  INBOX messages=0
  
  // ccc
  INBOX messages=1 -> メール確認
  --------------------------------------------------
  
  vm12# cd ~ccc
  vm12# cat .procmail.log -> ローカル配送プログラムのログ確認
  
  コマンドの実行結果
  --------------------------------------------------
  From aaa@example.com  Fri Feb  4 23:00:19 2022
    Subject: test1
      Folder: /home/ccc/Maildir/new/1643983219.2754_0.vm12  665
  --------------------------------------------------
  
  vm12# cd ~ccc
  vm12# cat Maildir/new/1643983219.2754_0.vm12
  
  コマンドの実行結果
  --------------------------------------------------
  Return-Path: <aaa@example.com>
  X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on vm12  // バージョン情報
  X-Spam-Level: **                                                 // 脅威度は「**」と低く評価
  X-Spam-Status: No, score=2.7 required=13.0 tests=ALL_TRUSTED,    // スパム判定は「No」
    DNS_FROM_AHBL_RHSBL,NOTINCONTENTTYPE autolearn=no autolearn_force=no
    version=3.4.0
  X-Original-To: ccc@example.com
  Delivered-To: ccc@example.com
  Received: from localhost (localhost [IPv6:::1])
    by vm12.example.com (Postfix) with ESMTPA id 2090E2019D51
    for <ccc@example.com>; Fri,  4 Feb 2022 23:00:12 +0900 (JST)
  from: aaa@example.com
  to: ccc@example.com
  Subject: test1  // タイトルには影響なし
  Message-Id: <20220204140013.2090E2019D51@vm12.example.com>
  Date: Fri,  4 Feb 2022 23:00:12 +0900 (JST)
  
  // メール本文には影響なし
  I sent test1.
  --------------------------------------------------
  
  vm12# cd $HOME
  vm12# doveadm expunge mailbox -u aaa inbox all -> メールボックス内のメール削除
  vm12# doveadm expunge mailbox -u bbb inbox all -> メールボックス内のメール削除
  vm12# doveadm expunge mailbox -u ccc inbox all -> メールボックス内のメール削除
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> 出力なし
  --------------------------------------------------
  
  ==================================================
            スクリプトでスパムメール送受信
  ==================================================
  
  vm12# cd $HOME
  vm12# vi send_mail.sh -> スクリプト修正
  
  コマンドの実行結果
  --------------------------------------------------
  #!/bin/bash
  
  ## 関数定義
  function send_mail () {
    echo "ehlo localhost"
    sleep 1
    echo "auth login"
    sleep 1
    echo "$(echo -n $1 | base64)"  // AUTH-LOGIN方式のユーザー名
    sleep 1
    echo "$(echo -n $2 | base64)"  // AUTH-LOGIN方式のパスワード
    sleep 1
    echo "mail from: $3@example.com"
    sleep 1
    echo "rcpt to: $4@example.com"
    sleep 1
    echo "data"
    sleep 1
    echo "from: $3@example.com"
    sleep 1
    echo "to: $4@example.com"
    sleep 1
    echo "Subject: test$5"
    sleep 1
    echo "XJS*C4JDBQADN1.NSBN3*2IDNEN*GTUBE-STANDARD-ANTI-UBE-TEST-EMAIL*C.34X"  // 本文をGTUBEコード(スパム検出)
    sleep 1
    echo "."
    sleep 1
    echo "quit"
  }
  
  ## サーバーにコマンド送信
  for i in $(seq 1 $5) ; do
    send_mail $1 $2 $3 $4 $i | telnet localhost 25;
  done
  --------------------------------------------------
  
  vm12# cd $HOME
  vm12# bash send_mail.sh aaa aa0122ma aaa ccc 1 -> AAAからCCCへ一通メール送信
  
  コマンドの実行結果
  --------------------------------------------------
  Trying ::1...
  Connected to localhost.
  Escape character is '^]'.
  220 vm12.example.com ESMTP Postfix
  250-vm12.example.com
  250-PIPELINING
  250-SIZE 10240000
  250-VRFY
  250-ETRN
  250-AUTH PLAIN LOGIN
  250-ENHANCEDSTATUSCODES
  250-8BITMIME
  250 DSN
  334 VXNlcm5hbWU6
  334 UGFzc3dvcmQ6
  235 2.7.0 Authentication successful
  250 2.1.0 Ok
  250 2.1.5 Ok
  354 End data with <CR><LF>.<CR><LF>
  250 2.0.0 Ok: queued as AC2642019D51
  Connection closed by foreign host.
  --------------------------------------------------
  
  vm12# cd $HOME
  vm12# doveadm mailbox status -u aaa messages inbox -> メールボックス内のメール確認
  vm12# doveadm mailbox status -u bbb messages inbox -> メールボックス内のメール確認
  vm12# doveadm mailbox status -u ccc messages inbox -> メールボックス内のメール確認
  
  コマンドの実行結果
  --------------------------------------------------
  // aaa
  INBOX messages=0
  
  // bbb
  INBOX messages=0
  
  // ccc
  INBOX messages=1 -> メール確認
  --------------------------------------------------
  
  vm12# cd ~ccc
  vm12# cat .procmail.log -> ローカル配送プログラムのログ確認
  
  コマンドの実行結果
  --------------------------------------------------
  From aaa@example.com  Fri Feb  4 23:07:45 2022
    Subject: ***SPAM*** test1
      Folder: /home/ccc/Maildir/new/1643983665.2811_0.vm12  1160
  --------------------------------------------------
  
  vm12# cd ~ccc
  vm12# cat Maildir/new/1643983665.2811_0.vm12
  
  コマンドの実行結果
  --------------------------------------------------
  Return-Path: <aaa@example.com>
  X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on vm12    // バージョン情報
  X-Spam-Flag: YES                                                   // 不明
  X-Spam-Level: **************************************************   // 脅威度は高く評価
  X-Spam-Status: Yes, score=1002.7 required=13.0 tests=ALL_TRUSTED,  // スパム判定は「Yes」
    DNS_FROM_AHBL_RHSBL,GTUBE,NOTINCONTENTTYPE autolearn=no autolearn_force=no
    version=3.4.0
  X-Spam-Report: 
    *  2.4 DNS_FROM_AHBL_RHSBL RBL: Envelope sender listed in dnsbl.ahbl.org
    *      [listed in example.com.rhsbl.ahbl.org.	IN]
    [A]
    *  0.1 ALL_TRUSTED Passed through trusted hosts only via SMTP
    *  1000 GTUBE BODY: Generic Test for Unsolicited Bulk Email
    *  0.2 NOTINCONTENTTYPE ! There's no Content-Type header
  X-Original-To: ccc@example.com
  Delivered-To: ccc@example.com
  Received: from localhost (localhost [IPv6:::1])
    by vm12.example.com (Postfix) with ESMTPA id AC2642019D51
    for <ccc@example.com>; Fri,  4 Feb 2022 23:07:37 +0900 (JST)
  from: aaa@example.com
  to: ccc@example.com
  Subject: ***SPAM*** test1  // タイトルに「***SPAM***」と付与
  Message-Id: <20220204140738.AC2642019D51@vm12.example.com>
  Date: Fri,  4 Feb 2022 23:07:37 +0900 (JST)
  X-Spam-Prev-Subject: test1
  
  // メール本文には影響なし
  XJS*C4JDBQADN1.NSBN3*2IDNEN*GTUBE-STANDARD-ANTI-UBE-TEST-EMAIL*C.34X
  --------------------------------------------------
  
  vm12# cd $HOME
  vm12# doveadm expunge mailbox -u aaa inbox all -> メールボックス内のメール削除
  vm12# doveadm expunge mailbox -u bbb inbox all -> メールボックス内のメール削除
  vm12# doveadm expunge mailbox -u ccc inbox all -> メールボックス内のメール削除
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> 出力なし
  --------------------------------------------------
  
  以下の確認に続く
  
================================================================================