================================================================================
[001] dhcp - 01
[002] dhcp - 02
[003] dhcp - 03
[004] PAM認証 - 01
[005] PAM認証 - 02
[006] PAM認証 - 03
[007] PAM認証 - 04
[008] PAM認証 - 05
[009] PAM認証 - 06
[010] PAM認証 - 07
[011] OpenLDAP - 01
[012] OpenLDAP - 02
[005] LDAP - 01 (ディレクトリ作成)
[006] LDAP - 02 (認証時にディレクトリ参照)
================================================================================
[001]
  dhcp - 01
  
[内容]
  ## 作業内容
    DHCPサーバーによるIPアドレス割当
  
  ## コマンド(dhclient)
    dhclient -d  // フォアグラウンド処理
    dhclient -r  // 割当情報を開放
    dhclient -H  // リクエスト送付先のホスト指定
  
[確認]
  $ cd $HOME
  $ ssh vm11 -> 公開鍵認証でSSH接続
  
  コマンドの実行結果
  --------------------------------------------------
  Last login: Mon Jul  3 09:16:10 2023 from 192.168.122.1
  --------------------------------------------------
    
    vm11$ cd $HOME
    vm11$ sudo dnf -y install dhcp-server
    
    コマンドの実行結果
    --------------------------------------------------
    (省略) -> エラー出力が無ければOK
    --------------------------------------------------
    
    vm11$ cd $HOME
    vm11$ sudo cp -p /etc/dhcp/dhcpd.conf /etc/dhcp/dhcpd.conf.org
    
    コマンドの実行結果
    --------------------------------------------------
    (省略) -> 出力なし
    --------------------------------------------------
    
    vm11$ cd $HOME
    vm11$ sudo vi /etc/dhcp/dhcpd.conf
    
    コマンドの実行結果
    --------------------------------------------------
    ## ネットワーク 192.168.122.0/24
    subnet 192.168.122.0 netmask 255.255.255.0 {
      option routers 192.168.122.1;              // ルーター
      option subnet-mask 255.255.255.0;          // サブネットマスク
      option domain-name "avswa.com";            // ドメイン名
      option domain-name-servers 192.168.122.1;  // DNSサーバー
      range 192.168.122.100 192.168.122.150;     // IPアドレス - リース範囲
      default-lease-time 21600;                  // IPアドレス - リース期間(秒)
      max-lease-time 43200;                      // IPアドレス - 最大期間(秒)
    }
    --------------------------------------------------
    
    vm11$ cd $HOME
    vm11$ sudo systemctl start dhcpd
    
    コマンドの実行結果
    --------------------------------------------------
    (省略) -> 出力なし
    --------------------------------------------------
    
    vm11$ cd $HOME
    vm11$ exit
    
    コマンドの実行結果
    --------------------------------------------------
    Connection to vm11 closed.
    --------------------------------------------------
    
  $ cd $HOME
  $ sudo virsh console vm12 -> コンソール接続 (SSH接続ではプロファイル無効化で接続が切断されてしまう)
  
  コマンドの実行結果
  --------------------------------------------------
  前回のログイン: Mon Jul  3 11:37:33 接続元: 192.168.122.1
  --------------------------------------------------
    
    vm12$ cd $HOME
    vm12$ sudo dnf -y install dhcp-client
    
    コマンドの実行結果
    --------------------------------------------------
    (省略) -> エラー出力が無ければOK
    --------------------------------------------------
    
    vm12$ cd $HOME
    vm12$ ifconfig
    
    コマンドの実行結果
    --------------------------------------------------
    enp1s0: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500
            inet 192.168.122.12  netmask 255.255.255.0  broadcast 192.168.122.255
            inet6 fe80::5054:ff:fee5:ebba  prefixlen 64  scopeid 0x20<link>
            ether 52:54:00:e5:eb:ba  txqueuelen 1000  (Ethernet)
            RX packets 299  bytes 25009 (24.4 KiB)
            RX errors 0  dropped 198  overruns 0  frame 0
            TX packets 46  bytes 7041 (6.8 KiB)
            TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
    
    lo: flags=73<UP,LOOPBACK,RUNNING>  mtu 65536
            inet 127.0.0.1  netmask 255.0.0.0
            inet6 ::1  prefixlen 128  scopeid 0x10<host>
            loop  txqueuelen 1000  (Local Loopback)
            RX packets 0  bytes 0 (0.0 B)
            RX errors 0  dropped 0  overruns 0  frame 0
            TX packets 0  bytes 0 (0.0 B)
            TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
    --------------------------------------------------
    
    vm12$ cd $HOME
    vm12$ sudo vi /etc/hosts
    
    コマンドの実行結果
    --------------------------------------------------
    127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
    ::1         localhost localhost.localdomain localhost6 localhost6.localdomain6
    192.168.122.11 vm11 site1.avswa.com site2.avswa.com
    192.168.122.12 vm12  // 削除
    192.168.122.13 vm13
    --------------------------------------------------
    
    vm12$ cd $HOME
    vm12$ nmcli connection -> プロファイルの一覧
    
    コマンドの実行結果
    --------------------------------------------------
    NAME    UUID                                  TYPE      DEVICE 
    enp1s0  aa4b1fb9-3bdd-4e3b-8ce7-f67d2e585bce  ethernet  enp1s0 
    --------------------------------------------------
    
    vm12$ cd $HOME
    vm12$ LANG=C nmcli -f ipv4.addresses connection show enp1s0 -> プロファイルから情報抽出
    
    コマンドの実行結果
    --------------------------------------------------
    ipv4.addresses:  192.168.122.12/24
    --------------------------------------------------
    
    vm12$ cd $HOME
    vm12$ LANG=C sudo nmcli connection down enp1s0 -> プロファイル無効化
    
    コマンドの実行結果
    --------------------------------------------------
    Connection 'enp1s0' successfully deactivated
    (D-Bus active path: /org/freedesktop/NetworkManager/ActiveConnection/1)
    --------------------------------------------------
    
    vm12$ cd $HOME
    vm12$ ifconfig
    
    コマンドの実行結果
    --------------------------------------------------
    enp1s0: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500
            // inet  が消える
            // inet6 が消える
            ether 52:54:00:e5:eb:ba  txqueuelen 1000  (Ethernet)
            RX packets 3300  bytes 16644513 (15.8 MiB)
            RX errors 0  dropped 1088  overruns 0  frame 0
            TX packets 1299  bytes 97528 (95.2 KiB)
            TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
    
    lo: flags=73<UP,LOOPBACK,RUNNING>  mtu 65536
            inet 127.0.0.1  netmask 255.0.0.0
            inet6 ::1  prefixlen 128  scopeid 0x10<host>
            loop  txqueuelen 1000  (Local Loopback)
            RX packets 0  bytes 0 (0.0 B)
            RX errors 0  dropped 0  overruns 0  frame 0
            TX packets 0  bytes 0 (0.0 B)
            TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
    --------------------------------------------------
    
    vm12$ cd $HOME
    vm12$ sudo dhclient  // コマンド本体
        > -d             // フォアグラウンド
        > -H vm11        // サーバー指定
        > enp1s0         // インターフェース
    
    コマンドの実行結果
    --------------------------------------------------
    Internet Systems Consortium DHCP Client 4.3.6
    Copyright 2004-2017 Internet Systems Consortium.
    All rights reserved.
    For info, please visit https://www.isc.org/software/dhcp/
    
    Listening on LPF/enp1s0/52:54:00:e5:eb:ba
    Sending on   LPF/enp1s0/52:54:00:e5:eb:ba
    Sending on   Socket/fallback
    Created duid "\000\004\236R\201\212F\233K\354\225\375\361[\312\304o\232".

    DHCPDISCOVER on enp1s0 to 255.255.255.255 port 67 interval 3 (xid=0x4d358154)
    DHCPREQUEST on enp1s0 to 255.255.255.255 port 67 (xid=0x4d358154)
    DHCPOFFER from 192.168.122.11
    DHCPACK from 192.168.122.11 (xid=0x4d358154)
    bound to 192.168.122.100 -- renewal in 8688 seconds.  // 192.168.122.100 を割当
    --------------------------------------------------
    
    vm12$ cd $HOME
    vm12$ ifconfig
    
    コマンドの実行結果
    --------------------------------------------------
    enp1s0: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500
            inet 192.168.122.100  netmask 255.255.255.0  broadcast 192.168.122.255
            // inet6 は無い
            ether 52:54:00:e5:eb:ba  txqueuelen 1000  (Ethernet)
            RX packets 9272  bytes 51141109 (48.7 MiB)
            RX errors 0  dropped 1506  overruns 0  frame 0
            TX packets 4288  bytes 312346 (305.0 KiB)
            TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
    
    lo: flags=73<UP,LOOPBACK,RUNNING>  mtu 65536
            inet 127.0.0.1  netmask 255.0.0.0
            inet6 ::1  prefixlen 128  scopeid 0x10<host>
            loop  txqueuelen 1000  (Local Loopback)
            RX packets 96  bytes 7872 (7.6 KiB)
            RX errors 0  dropped 0  overruns 0  frame 0
            TX packets 96  bytes 7872 (7.6 KiB)
            TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
    --------------------------------------------------
    
    vm12$ cd $HOME
    vm12$ sudo dhclient  // コマンド本体
        > -d             // フォアグラウンド
        > -r             // 割当を返還
        > -H vm11        // サーバー指定
        > enp1s0         // インターフェース
    
    コマンドの実行結果
    --------------------------------------------------
    Removed stale PID file
    Internet Systems Consortium DHCP Client 4.3.6
    Copyright 2004-2017 Internet Systems Consortium.
    All rights reserved.
    For info, please visit https://www.isc.org/software/dhcp/
    
    Listening on LPF/enp1s0/52:54:00:e5:eb:ba
    Sending on   LPF/enp1s0/52:54:00:e5:eb:ba
    Sending on   Socket/fallback
    DHCPRELEASE on enp1s0 to 192.168.122.11 port 67 (xid=0x21442045)
    --------------------------------------------------
    
    vm12$ cd $HOME
    vm12$ ifconfig
    
    コマンドの実行結果
    --------------------------------------------------
    enp1s0: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500
            // inet  が消える
            // inet6 が消える
            ether 52:54:00:e5:eb:ba  txqueuelen 1000  (Ethernet)
            RX packets 3300  bytes 16644513 (15.8 MiB)
            RX errors 0  dropped 1088  overruns 0  frame 0
            TX packets 1299  bytes 97528 (95.2 KiB)
            TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
    
    lo: flags=73<UP,LOOPBACK,RUNNING>  mtu 65536
            inet 127.0.0.1  netmask 255.0.0.0
            inet6 ::1  prefixlen 128  scopeid 0x10<host>
            loop  txqueuelen 1000  (Local Loopback)
            RX packets 0  bytes 0 (0.0 B)
            RX errors 0  dropped 0  overruns 0  frame 0
            TX packets 0  bytes 0 (0.0 B)
            TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
    --------------------------------------------------
    
    vm12$ cd $HOME
    vm12$ sudo vi /etc/hosts
    
    コマンドの実行結果
    --------------------------------------------------
    127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
    ::1         localhost localhost.localdomain localhost6 localhost6.localdomain6
    192.168.122.11 vm11 site1.avswa.com site2.avswa.com
    192.168.122.12 vm12  // 元に戻す
    192.168.122.13 vm13
    --------------------------------------------------
    
    vm12$ cd $HOME
    vm12$ LANG=C sudo nmcli connection up enp1s0 -> プロファイル有効化
    
    コマンドの実行結果
    --------------------------------------------------
    Connection successfully activated
    (D-Bus active path: /org/freedesktop/NetworkManager/ActiveConnection/5)
    --------------------------------------------------
    
    vm12$ cd $HOME
    vm12$ ifconfig
    
    コマンドの実行結果
    --------------------------------------------------
    enp1s0: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500
            inet 192.168.122.12  netmask 255.255.255.0  broadcast 192.168.122.255
            inet6 fe80::5054:ff:fee5:ebba  prefixlen 64  scopeid 0x20<link>
            ether 52:54:00:e5:eb:ba  txqueuelen 1000  (Ethernet)
            RX packets 9687  bytes 51166591 (48.7 MiB)
            RX errors 0  dropped 1896  overruns 0  frame 0
            TX packets 4313  bytes 314364 (306.9 KiB)
            TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
    
    lo: flags=73<UP,LOOPBACK,RUNNING>  mtu 65536
            inet 127.0.0.1  netmask 255.0.0.0
            inet6 ::1  prefixlen 128  scopeid 0x10<host>
            loop  txqueuelen 1000  (Local Loopback)
            RX packets 96  bytes 7872 (7.6 KiB)
            RX errors 0  dropped 0  overruns 0  frame 0
            TX packets 96  bytes 7872 (7.6 KiB)
            TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
    --------------------------------------------------
    
    vm12$ cd $HOME
    vm12$ exit
    
    コマンドの実行結果
    --------------------------------------------------
    ログアウト
    --------------------------------------------------
    
  以下の確認に続く
  
================================================================================
[002]
  dhcp - 02
  
[内容]
  ## 作業内容
    DHCPサーバーによる固定IPアドレス割当
  
[確認]
  $ cd $HOME
  $ ssh vm11 -> 公開鍵認証でSSH接続
  
  コマンドの実行結果
  --------------------------------------------------
  Last login: Mon Jul  3 11:33:03 2023 from 192.168.122.1
  --------------------------------------------------
    
    vm11$ cd $HOME
    vm11$ sudo vi /etc/dhcp/dhcpd.conf
    
    コマンドの実行結果
    --------------------------------------------------
    ## ネットワーク 192.168.122.0/24
    subnet 192.168.122.0 netmask 255.255.255.0 {
      option routers 192.168.122.1;
      option subnet-mask 255.255.255.0;
      option domain-name "avswa.com";
      option domain-name-servers 192.168.122.1;
      range 192.168.122.100 192.168.122.150;
      default-lease-time 21600;
      max-lease-time 43200;
      
      ## 特定ホストに固定IPアドレスを付与
      host vm12 {
        hardware ethernet 52:54:00:e5:eb:ba;  // MAC
        fixed-address 192.168.122.114;        // 固定IP
      }
    }
    --------------------------------------------------
    
    vm11$ cd $HOME
    vm11$ sudo systemctl restart dhcpd
    
    コマンドの実行結果
    --------------------------------------------------
    (省略) -> 出力なし
    --------------------------------------------------
    
    vm11$ cd $HOME
    vm11$ exit
    
    コマンドの実行結果
    --------------------------------------------------
    Connection to vm11 closed.
    --------------------------------------------------
    
  $ cd $HOME
  $ sudo virsh console vm12 -> コンソール接続 (SSH接続ではプロファイル無効化で接続が切断されてしまう)
  
  コマンドの実行結果
  --------------------------------------------------
  前回のログイン: Mon Jul  3 12:26:43 端末: ttyS0
  --------------------------------------------------
    
    vm12$ cd $HOME
    vm12$ ifconfig
    
    コマンドの実行結果
    --------------------------------------------------
    enp1s0: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500
            inet 192.168.122.12  netmask 255.255.255.0  broadcast 192.168.122.255
            inet6 fe80::5054:ff:fee5:ebba  prefixlen 64  scopeid 0x20<link>
            ether 52:54:00:e5:eb:ba  txqueuelen 1000  (Ethernet)
            RX packets 211  bytes 15208 (14.8 KiB)
            RX errors 0  dropped 146  overruns 0  frame 0
            TX packets 14  bytes 992 (992.0 B)
            TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
    
    lo: flags=73<UP,LOOPBACK,RUNNING>  mtu 65536
            inet 127.0.0.1  netmask 255.0.0.0
            inet6 ::1  prefixlen 128  scopeid 0x10<host>
            loop  txqueuelen 1000  (Local Loopback)
            RX packets 0  bytes 0 (0.0 B)
            RX errors 0  dropped 0  overruns 0  frame 0
            TX packets 0  bytes 0 (0.0 B)
            TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
    --------------------------------------------------
    
    vm12$ cd $HOME
    vm12$ sudo vi /etc/hosts
    
    コマンドの実行結果
    --------------------------------------------------
    127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
    ::1         localhost localhost.localdomain localhost6 localhost6.localdomain6
    192.168.122.11 vm11 site1.avswa.com site2.avswa.com
    192.168.122.12 vm12  // 削除
    192.168.122.13 vm13
    --------------------------------------------------
    
    vm12$ cd $HOME
    vm12$ nmcli connection -> プロファイルの一覧
    
    コマンドの実行結果
    --------------------------------------------------
    NAME    UUID                                  TYPE      DEVICE 
    enp1s0  aa4b1fb9-3bdd-4e3b-8ce7-f67d2e585bce  ethernet  enp1s0 
    --------------------------------------------------
    
    vm12$ cd $HOME
    vm12$ LANG=C nmcli -f ipv4.addresses connection show enp1s0 -> プロファイルから情報抽出
    
    コマンドの実行結果
    --------------------------------------------------
    ipv4.addresses:  192.168.122.12/24
    --------------------------------------------------
    
    vm12$ cd $HOME
    vm12$ LANG=C sudo nmcli connection down enp1s0 -> プロファイル無効化
    
    コマンドの実行結果
    --------------------------------------------------
    Connection 'enp1s0' successfully deactivated
    (D-Bus active path: /org/freedesktop/NetworkManager/ActiveConnection/1)
    --------------------------------------------------
    
    vm12$ cd $HOME
    vm12$ ifconfig
    
    コマンドの実行結果
    --------------------------------------------------
    enp1s0: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500
            // inet  が消える
            // inet6 が消える
            ether 52:54:00:e5:eb:ba  txqueuelen 1000  (Ethernet)
            RX packets 3300  bytes 16644513 (15.8 MiB)
            RX errors 0  dropped 1088  overruns 0  frame 0
            TX packets 1299  bytes 97528 (95.2 KiB)
            TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
    
    lo: flags=73<UP,LOOPBACK,RUNNING>  mtu 65536
            inet 127.0.0.1  netmask 255.0.0.0
            inet6 ::1  prefixlen 128  scopeid 0x10<host>
            loop  txqueuelen 1000  (Local Loopback)
            RX packets 0  bytes 0 (0.0 B)
            RX errors 0  dropped 0  overruns 0  frame 0
            TX packets 0  bytes 0 (0.0 B)
            TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
    --------------------------------------------------
    
    vm12$ cd $HOME
    vm12$ sudo dhclient  // コマンド本体
        > -d             // フォアグラウンド
        > -H vm11        // サーバー指定
        > enp1s0         // インターフェース
    
    コマンドの実行結果
    --------------------------------------------------
    Internet Systems Consortium DHCP Client 4.3.6
    Copyright 2004-2017 Internet Systems Consortium.
    All rights reserved.
    For info, please visit https://www.isc.org/software/dhcp/
    
    Listening on LPF/enp1s0/52:54:00:e5:eb:ba
    Sending on   LPF/enp1s0/52:54:00:e5:eb:ba
    Sending on   Socket/fallback
    
    DHCPDISCOVER on enp1s0 to 255.255.255.255 port 67 interval 7 (xid=0x2a8c681b)
    DHCPREQUEST on enp1s0 to 255.255.255.255 port 67 (xid=0x2a8c681b)
    DHCPOFFER from 192.168.122.11
    DHCPACK from 192.168.122.11 (xid=0x2a8c681b)
    bound to 192.168.122.114 -- renewal in 8368 seconds.  // 192.168.122.114 を割当
    --------------------------------------------------
    
    vm12$ cd $HOME
    vm12$ ifconfig
    
    コマンドの実行結果
    --------------------------------------------------
    enp1s0: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500
            inet 192.168.122.114  netmask 255.255.255.0  broadcast 192.168.122.255
            // inet6 は無い
            ether 52:54:00:e5:eb:ba  txqueuelen 1000  (Ethernet)
            RX packets 9272  bytes 51141109 (48.7 MiB)
            RX errors 0  dropped 1506  overruns 0  frame 0
            TX packets 4288  bytes 312346 (305.0 KiB)
            TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
    
    lo: flags=73<UP,LOOPBACK,RUNNING>  mtu 65536
            inet 127.0.0.1  netmask 255.0.0.0
            inet6 ::1  prefixlen 128  scopeid 0x10<host>
            loop  txqueuelen 1000  (Local Loopback)
            RX packets 96  bytes 7872 (7.6 KiB)
            RX errors 0  dropped 0  overruns 0  frame 0
            TX packets 96  bytes 7872 (7.6 KiB)
            TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
    --------------------------------------------------
    
    vm12$ cd $HOME
    vm12$ sudo dhclient  // コマンド本体
        > -d             // フォアグラウンド
        > -r             // 割当を返還
        > -H vm11        // サーバー指定
        > enp1s0         // インターフェース
    
    コマンドの実行結果
    --------------------------------------------------
    Removed stale PID file
    Internet Systems Consortium DHCP Client 4.3.6
    Copyright 2004-2017 Internet Systems Consortium.
    All rights reserved.
    For info, please visit https://www.isc.org/software/dhcp/
    
    Listening on LPF/enp1s0/52:54:00:e5:eb:ba
    Sending on   LPF/enp1s0/52:54:00:e5:eb:ba
    Sending on   Socket/fallback
    DHCPRELEASE on enp1s0 to 192.168.122.11 port 67 (xid=0x6ce23746)
    --------------------------------------------------
    
    vm12$ cd $HOME
    vm12$ ifconfig
    
    コマンドの実行結果
    --------------------------------------------------
    enp1s0: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500
            // inet  が消える
            // inet6 が消える
            ether 52:54:00:e5:eb:ba  txqueuelen 1000  (Ethernet)
            RX packets 3300  bytes 16644513 (15.8 MiB)
            RX errors 0  dropped 1088  overruns 0  frame 0
            TX packets 1299  bytes 97528 (95.2 KiB)
            TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
    
    lo: flags=73<UP,LOOPBACK,RUNNING>  mtu 65536
            inet 127.0.0.1  netmask 255.0.0.0
            inet6 ::1  prefixlen 128  scopeid 0x10<host>
            loop  txqueuelen 1000  (Local Loopback)
            RX packets 0  bytes 0 (0.0 B)
            RX errors 0  dropped 0  overruns 0  frame 0
            TX packets 0  bytes 0 (0.0 B)
            TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
    --------------------------------------------------
    
    vm12$ cd $HOME
    vm12$ sudo vi /etc/hosts
    
    コマンドの実行結果
    --------------------------------------------------
    127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
    ::1         localhost localhost.localdomain localhost6 localhost6.localdomain6
    192.168.122.11 vm11 site1.avswa.com site2.avswa.com
    192.168.122.12 vm12  // 元に戻す
    192.168.122.13 vm13
    --------------------------------------------------
    
    vm12$ cd $HOME
    vm12$ LANG=C sudo nmcli connection up enp1s0 -> プロファイル有効化
    
    コマンドの実行結果
    --------------------------------------------------
    Connection successfully activated
    (D-Bus active path: /org/freedesktop/NetworkManager/ActiveConnection/5)
    --------------------------------------------------
    
    vm12$ cd $HOME
    vm12$ ifconfig
    
    コマンドの実行結果
    --------------------------------------------------
    enp1s0: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500
            inet 192.168.122.12  netmask 255.255.255.0  broadcast 192.168.122.255
            inet6 fe80::5054:ff:fee5:ebba  prefixlen 64  scopeid 0x20<link>
            ether 52:54:00:e5:eb:ba  txqueuelen 1000  (Ethernet)
            RX packets 9687  bytes 51166591 (48.7 MiB)
            RX errors 0  dropped 1896  overruns 0  frame 0
            TX packets 4313  bytes 314364 (306.9 KiB)
            TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
    
    lo: flags=73<UP,LOOPBACK,RUNNING>  mtu 65536
            inet 127.0.0.1  netmask 255.0.0.0
            inet6 ::1  prefixlen 128  scopeid 0x10<host>
            loop  txqueuelen 1000  (Local Loopback)
            RX packets 96  bytes 7872 (7.6 KiB)
            RX errors 0  dropped 0  overruns 0  frame 0
            TX packets 96  bytes 7872 (7.6 KiB)
            TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
    --------------------------------------------------
    
    vm12$ cd $HOME
    vm12$ exit
    
    コマンドの実行結果
    --------------------------------------------------
    ログアウト
    --------------------------------------------------
    
  以下の確認に続く
  
================================================================================
[003]
  dhcp - 03
  
[内容]
  ## 作業内容
    ソフトウェア停止
  
[確認]
  $ cd $HOME
  $ ssh vm11 -> 公開鍵認証でSSH接続
  
  コマンドの実行結果
  --------------------------------------------------
  Last login: Mon Jul  3 17:06:30 2023 from 192.168.122.1
  --------------------------------------------------
    
    vm11$ cd $HOME
    vm11$ sudo systemctl stop dhcpd
    
    コマンドの実行結果
    --------------------------------------------------
    (省略) -> 出力なし
    --------------------------------------------------
    
    vm11$ cd $HOME
    vm11$ sudo systemctl disable dhcpd
    
    コマンドの実行結果
    --------------------------------------------------
    (省略) -> 出力なし
    --------------------------------------------------
    
    vm11$ cd $HOME
    vm11$ exit
    
    コマンドの実行結果
    --------------------------------------------------
    Connection to vm11 closed.
    --------------------------------------------------
    
  以下の確認に続く
  
================================================================================
[004]
  PAM認証 - 01
  
[内容]
  ## 作業内容
    ログイン処理時に追加メッセージを出力させてみる
  
[確認]
  $ cd $HOME
  $ sudo virsh console vm11
  
  コマンドの実行結果
  --------------------------------------------------
  System is Linux
  Kernel is 4.20.1
  Architecture is x86_64
  Host is vm11
  vm11 login: (makoto)
  パスワード: (ma0122ma)
  前回のログイン: Wed Jul  5 11:46:57 端末: ttyS0
  This machine is for LPIC.
  --------------------------------------------------
    
    vm11$ cd $HOME
    vm11$ ls -lh /etc/pam.d | grep login
    
    コマンドの実行結果
    --------------------------------------------------
    -rw-r--r--. 1 root root 715  5月 16 18:59 login
    --------------------------------------------------
    
    vm11$ cd $HOME
    vm11$ sudo vi /etc/pam.d/login
    
    コマンドの実行結果
    --------------------------------------------------
    #%PAM-1.0
    auth       required     pam_echo.so 'This is PAM Test 01'  // 追加メッセージ
    auth       substack     system-auth
    auth       include      postlogin
    auth       required     pam_echo.so 'This is PAM Test 02'  // 追加メッセージ
    account    required     pam_nologin.so
    account    include      system-auth
    password   include      system-auth
    session    required     pam_selinux.so close
    session    required     pam_loginuid.so
    session    optional     pam_console.so
    session    required     pam_selinux.so open
    session    required     pam_namespace.so
    session    optional     pam_keyinit.so force revoke
    session    include      system-auth
    session    include      postlogin
    -session   optional     pam_ck_connector.so
    --------------------------------------------------
    
    vm11$ cd $HOME
    vm11$ exit
    
    コマンドの実行結果
    --------------------------------------------------
    ログアウト
    --------------------------------------------------
    
  $ cd $HOME
  $ sudo virsh console vm11
  
  コマンドの実行結果
  --------------------------------------------------
  System is Linux
  Kernel is 4.20.1
  Architecture is x86_64
  Host is vm11
  vm11 login: (makoto)
  'This is PAM Test 01'  // 追加メッセージ
  パスワード: (ma0122ma)
  'This is PAM Test 02'  // 追加メッセージ
  前回のログイン: Wed Jul  5 12:26:09 端末: ttyS0
  This machine is for LPIC.
  --------------------------------------------------
    
    vm11$ cd $HOME
    vm11$ sudo vi /etc/pam.d/login
    
    コマンドの実行結果
    --------------------------------------------------
    #%PAM-1.0
    auth       required     pam_echo.so 'This is PAM Test 01'  // 削除 -> 元に戻す
    auth       substack     system-auth
    auth       include      postlogin
    auth       required     pam_echo.so 'This is PAM Test 02'  // 削除 -> 元に戻す
    account    required     pam_nologin.so
    account    include      system-auth
    password   include      system-auth
    session    required     pam_selinux.so close
    session    required     pam_loginuid.so
    session    optional     pam_console.so
    session    required     pam_selinux.so open
    session    required     pam_namespace.so
    session    optional     pam_keyinit.so force revoke
    session    include      system-auth
    session    include      postlogin
    -session   optional     pam_ck_connector.so
    --------------------------------------------------
    
    vm11$ cd $HOME
    vm11$ exit
    
    コマンドの実行結果
    --------------------------------------------------
    ログアウト
    --------------------------------------------------
    
  以下の確認に続く
  
================================================================================
[005]
  PAM認証 - 02
  
[内容]
  ## 作業内容
    コマンド(su)で他ユーザー変更時は管理者(root)であってもパスワード入力
  
[確認]
  $ cd $HOME
  $ sudo virsh console vm11
  
  コマンドの実行結果
  --------------------------------------------------
  System is Linux
  Kernel is 4.20.1
  Architecture is x86_64
  Host is vm11
  vm11 login: (root)  // SSH接続では管理者(root)で接続不可
  パスワード: (rt0122ma)
  前回のログイン: Wed Jul  5 10:54:07 端末: ttyS0
  This machine is for LPIC.
  --------------------------------------------------
    
    vm11# cd $HOME
    vm11# su - makoto
    
    コマンドの実行結果
    --------------------------------------------------
    (省略) -> パスワード入力無しに他ユーザーになれる
    --------------------------------------------------
      
      vm11$ cd $HOME
      vm11$ exit
      
      コマンドの実行結果
      --------------------------------------------------
      ログアウト
      --------------------------------------------------
      
    vm11# cd $HOME
    vm11# vi /etc/pam.d/su
    
    コマンドの実行結果
    --------------------------------------------------
    #%PAM-1.0
    auth            required        pam_env.so
    #auth           sufficient      pam_rootok.so  // コメントアウト
    #auth           sufficient      pam_wheel.so trust use_uid
    auth            substack        system-auth
    auth            include         postlogin
    account         sufficient      pam_succeed_if.so uid = 0 use_uid quiet
    account         include         system-auth
    password        include         system-auth
    session         include         system-auth
    session         include         postlogin
    session         optional        pam_xauth.so
    --------------------------------------------------
    
    vm11# cd $HOME
    vm11# su - makoto
    
    コマンドの実行結果
    --------------------------------------------------
    パスワード: (ma0122ma)
    --------------------------------------------------
      
      vm11$ cd $HOME
      vm11$ exit
      
      コマンドの実行結果
      --------------------------------------------------
      ログアウト
      --------------------------------------------------
      
    vm11# cd $HOME
    vm11# vi /etc/pam.d/su
    
    コマンドの実行結果
    --------------------------------------------------
    #%PAM-1.0
    auth            required        pam_env.so
    auth            sufficient      pam_rootok.so  // 元に戻す
    #auth           sufficient      pam_wheel.so trust use_uid
    auth            substack        system-auth
    auth            include         postlogin
    account         sufficient      pam_succeed_if.so uid = 0 use_uid quiet
    account         include         system-auth
    password        include         system-auth
    session         include         system-auth
    session         include         postlogin
    session         optional        pam_xauth.so
    --------------------------------------------------
    
    vm11# cd $HOME
    vm11# exit
    
    コマンドの実行結果
    --------------------------------------------------
    ログアウト
    --------------------------------------------------
    
  以下の確認に続く
  
================================================================================
[006]
  PAM認証 - 03
  
[内容]
  ## 作業内容
    コマンド(su)で他ユーザー変更時の認証失敗の待ち時間を変更する
  
[確認]
  $ cd $HOME
  $ ssh vm11
  
  コマンドの実行結果
  --------------------------------------------------
  Last login: Wed Jul  5 13:10:29 2023
  --------------------------------------------------
    
    vm11$ cd $HOME
    vm11$ cat /etc/pam.d/su
    
    コマンドの実行結果
    --------------------------------------------------
    #%PAM-1.0
    auth            required        pam_env.so
    auth            sufficient      pam_rootok.so
    #auth           sufficient      pam_wheel.so trust use_uid
    auth            substack        system-auth  // 変更対象
    auth            include         postlogin
    account         sufficient      pam_succeed_if.so uid = 0 use_uid quiet
    account         include         system-auth
    password        include         system-auth
    session         include         system-auth
    session         include         postlogin
    session         optional        pam_xauth.so
    --------------------------------------------------
    
    vm11$ cd $HOME
    vm11$ sudo vi /etc/pam.d/system-auth
    
    コマンドの実行結果
    --------------------------------------------------
    #%PAM-1.0
    auth        required      pam_env.so
    auth        required      pam_faildelay.so delay=20000000  // 追加 => 認証失敗時の待ち時間を20秒に設定
    auth        sufficient    pam_unix.so try_first_pass nullok
    auth        required      pam_deny.so
    account     required      pam_unix.so
    password    requisite     pam_pwquality.so try_first_pass local_users_only retry=3 authtok_type=
    password    sufficient    pam_unix.so try_first_pass use_authtok nullok sha512 shadow
    password    required      pam_deny.so
    session     optional      pam_keyinit.so revoke
    session     required      pam_limits.so
    -session    optional      pam_systemd.so
    session     [success=1 default=ignore] pam_succeed_if.so service in crond quiet use_uid
    session     required      pam_unix.so
    --------------------------------------------------
    
    vm11$ cd $HOME
    vm11$ su - user1
    
    コマンドの実行結果
    --------------------------------------------------
    パスワード: (不正パスワード) => 20秒待機
    su: 認証失敗
    --------------------------------------------------
    
    vm11$ cd $HOME
    vm11$ sudo vi /etc/pam.d/system-auth
    
    コマンドの実行結果
    --------------------------------------------------
    #%PAM-1.0
    auth        required      pam_env.so
    auth        required      pam_faildelay.so delay=20000000  // 削除
    auth        sufficient    pam_unix.so try_first_pass nullok
    auth        required      pam_deny.so
    account     required      pam_unix.so
    password    requisite     pam_pwquality.so try_first_pass local_users_only retry=3 authtok_type=
    password    sufficient    pam_unix.so try_first_pass use_authtok nullok sha512 shadow
    password    required      pam_deny.so
    session     optional      pam_keyinit.so revoke
    session     required      pam_limits.so
    -session    optional      pam_systemd.so
    session     [success=1 default=ignore] pam_succeed_if.so service in crond quiet use_uid
    session     required      pam_unix.so
    --------------------------------------------------
    
    vm11$ cd $HOME
    vm11$ cat /etc/login.defs | grep -i delay -> デフォルト値の調査
    
    コマンドの実行結果
    --------------------------------------------------
    (省略) -> 設定されていなかった
    --------------------------------------------------
    
    vm11$ cd $HOME
    vm11$ su - user1
    
    コマンドの実行結果
    --------------------------------------------------
    パスワード: (不正パスワード) => デフォルト値(おそらく5秒前後)待機
    su: 認証失敗
    --------------------------------------------------
    
    vm11$ cd $HOME
    vm11$ exit
    
    コマンドの実行結果
    --------------------------------------------------
    Connection to vm11 closed.
    --------------------------------------------------
    
  以下の確認に続く
  
================================================================================
[007]
  PAM認証 - 04
  
[内容]
  ## 作業内容
    コマンド(su)でグループ(wheel)のメンバーはパスワード無しで変更可能
  
[確認]
  $ cd $HOME
  $ ssh vm11
  
  コマンドの実行結果
  --------------------------------------------------
  Last login: Wed Jul  5 17:14:51 2023 from 192.168.122.1
  --------------------------------------------------
    
    vm11$ cd $HOME
    vm11$ whoami
    
    コマンドの実行結果
    --------------------------------------------------
    makoto
    --------------------------------------------------
    
    vm11$ cd $HOME
    vm11$ getent group | grep wheel
    
    コマンドの実行結果
    --------------------------------------------------
    wheel:x:10:makoto -> グループ(wheel)のメンバー
    --------------------------------------------------
    
    vm11$ cd $HOME
    vm11$ su - user1
    
    コマンドの実行結果
    --------------------------------------------------
    パスワード: (user1) -> パスワードが要求される
    --------------------------------------------------
      
      vm11$ cd $HOME
      vm11$ exit
      
      コマンドの実行結果
      --------------------------------------------------
      ログアウト
      --------------------------------------------------
      
    vm11$ cd $HOME
    vm11$ sudo vi /etc/pam.d/su
    
    コマンドの実行結果
    --------------------------------------------------
    #%PAM-1.0
    auth            required        pam_env.so
    auth            sufficient      pam_rootok.so
    auth            sufficient      pam_wheel.so trust use_uid  // コメントアウト解除 => 今回は元に戻さない
    auth            substack        system-auth
    auth            include         postlogin
    account         sufficient      pam_succeed_if.so uid = 0 use_uid quiet
    account         include         system-auth
    password        include         system-auth
    session         include         system-auth
    session         include         postlogin
    session         optional        pam_xauth.so
    --------------------------------------------------
    
    vm11$ cd $HOME
    vm11$ su - user1
    
    コマンドの実行結果
    --------------------------------------------------
    (パスワード入力無しに他ユーザーになれる)
    --------------------------------------------------
      
      vm11$ cd $HOME
      vm11$ exit
      
      コマンドの実行結果
      --------------------------------------------------
      ログアウト
      --------------------------------------------------
      
    vm11$ cd $HOME
    vm11$ exit
    
    コマンドの実行結果
    --------------------------------------------------
    Connection to vm11 closed.
    --------------------------------------------------
    
  以下の確認に続く
  
================================================================================
[008]
  PAM認証 - 05
  
[内容]
  ## 作業内容
    コマンド(su)で無条件に失敗または無条件に成功
  
[確認]
  $ cd $HOME
  $ ssh vm11
  
  コマンドの実行結果
  --------------------------------------------------
  Last login: Wed Jul  5 17:33:29 2023 from 192.168.122.1
  --------------------------------------------------
    
    vm11$ cd $HOME
    vm11$ whoami
    
    コマンドの実行結果
    --------------------------------------------------
    makoto
    --------------------------------------------------
    
    vm11$ cd $HOME
    vm11$ su - user1
    
    コマンドの実行結果
    --------------------------------------------------
    (パスワード入力無しに他ユーザーになれる)
    --------------------------------------------------
      
      vm11$ cd $HOME
      vm11$ exit
      
      コマンドの実行結果
      --------------------------------------------------
      ログアウト
      --------------------------------------------------
      
    vm11$ cd $HOME
    vm11$ sudo vi /etc/pam.d/su
    
    コマンドの実行結果
    --------------------------------------------------
    #%PAM-1.0
    auth            required        pam_env.so
    auth            required        pam_deny.so  // 追加 => 常に失敗を返す
    auth            sufficient      pam_rootok.so
    auth            sufficient      pam_wheel.so trust use_uid
    auth            substack        system-auth
    auth            include         postlogin
    account         sufficient      pam_succeed_if.so uid = 0 use_uid quiet
    account         include         system-auth
    password        include         system-auth
    session         include         system-auth
    session         include         postlogin
    session         optional        pam_xauth.so
    --------------------------------------------------
    
    vm11$ cd $HOME
    vm11$ su - user1
    
    コマンドの実行結果
    --------------------------------------------------
    パスワード: (正しいパスワード入力)
    su: 認証失敗
    --------------------------------------------------
    
    vm11$ cd $HOME
    vm11$ sudo vi /etc/pam.d/su
    
    コマンドの実行結果
    --------------------------------------------------
    #%PAM-1.0
    auth            required        pam_env.so
    auth            required        pam_permit.so  // 修正 => 常に成功を返す
    auth            sufficient      pam_rootok.so
    auth            sufficient      pam_wheel.so trust use_uid
    auth            substack        system-auth
    auth            include         postlogin
    account         sufficient      pam_succeed_if.so uid = 0 use_uid quiet
    account         include         system-auth
    password        include         system-auth
    session         include         system-auth
    session         include         postlogin
    session         optional        pam_xauth.so
    --------------------------------------------------
    
    vm11$ cd $HOME
    vm11$ su - user1
    
    コマンドの実行結果
    --------------------------------------------------
    (パスワード入力無しに他ユーザーになれる)
    --------------------------------------------------
      
      vm11$ cd $HOME
      vm11$ exit
      
      コマンドの実行結果
      --------------------------------------------------
      ログアウト
      --------------------------------------------------
      
    vm11$ cd $HOME
    vm11$ sudo vi /etc/pam.d/su
    
    コマンドの実行結果
    --------------------------------------------------
    #%PAM-1.0
    auth            required        pam_env.so
    auth            required        pam_permit.so  // 削除
    auth            sufficient      pam_rootok.so
    auth            sufficient      pam_wheel.so trust use_uid
    auth            substack        system-auth
    auth            include         postlogin
    account         sufficient      pam_succeed_if.so uid = 0 use_uid quiet
    account         include         system-auth
    password        include         system-auth
    session         include         system-auth
    session         include         postlogin
    session         optional        pam_xauth.so
    --------------------------------------------------
      
    vm11$ cd $HOME
    vm11$ su - user1
    
    コマンドの実行結果
    --------------------------------------------------
    (パスワード入力無しに他ユーザーになれる)
    --------------------------------------------------
      
      vm11$ cd $HOME
      vm11$ exit
      
      コマンドの実行結果
      --------------------------------------------------
      ログアウト
      --------------------------------------------------
      
    vm11$ cd $HOME
    vm11$ exit
    
    コマンドの実行結果
    --------------------------------------------------
    Connection to vm11 closed.
    --------------------------------------------------
    
  以下の確認に続く
  
================================================================================
[009]
  PAM認証 - 06
  
[内容]
  ## 作業内容
    コマンド(su)でユーザー(root)や所属グループ(wheel)に拘らずパスワード入力を強制する
  
[確認]
  $ cd $HOME
  $ ssh vm11
  
  コマンドの実行結果
  --------------------------------------------------
  Last login: Wed Jul  5 18:33:07 2023 from 192.168.122.1
  --------------------------------------------------
    
    vm11$ cd $HOME
    vm11$ whoami
    
    コマンドの実行結果
    --------------------------------------------------
    makoto
    --------------------------------------------------
    
    vm11$ cd $HOME
    vm11$ getent passwd | grep makoto
    
    コマンドの実行結果
    --------------------------------------------------
    makoto:x:1000:1000:makoto:/home/makoto:/bin/bash
    --------------------------------------------------
    
    vm11$ cd $HOME
    vm11$ getent group | grep wheel
    
    コマンドの実行結果
    --------------------------------------------------
    wheel:x:10:makoto -> グループ(wheel)のメンバー
    --------------------------------------------------
    
    vm11$ cd $HOME
    vm11$ su - user1
    
    コマンドの実行結果
    --------------------------------------------------
    (パスワード入力無しに他ユーザーになれる)
    --------------------------------------------------
      
      vm11$ cd $HOME
      vm11$ exit
      
      コマンドの実行結果
      --------------------------------------------------
      ログアウト
      --------------------------------------------------
      
    vm11$ cd $HOME
    vm11$ sudo vi /etc/pam.d/su
    
    コマンドの実行結果
    --------------------------------------------------
    #%PAM-1.0
    auth            required        pam_env.so
    # auth          sufficient      pam_rootok.so               // コメントアウト => 今回は元に戻さない
    # auth          sufficient      pam_wheel.so trust use_uid  // コメントアウト => 今回は元に戻さない
    auth            substack        system-auth
    auth            include         postlogin
    account         sufficient      pam_succeed_if.so uid = 0 use_uid quiet
    account         include         system-auth
    password        include         system-auth
    session         include         system-auth
    session         include         postlogin
    session         optional        pam_xauth.so
    --------------------------------------------------
    
    vm11$ cd $HOME
    vm11$ su - user1
    
    コマンドの実行結果
    --------------------------------------------------
    パスワード: (正しいパスワード入力)
    --------------------------------------------------
      
      vm11$ cd $HOME
      vm11$ exit
      
      コマンドの実行結果
      --------------------------------------------------
      ログアウト
      --------------------------------------------------
      
    vm11$ cd $HOME
    vm11$ exit
    
    コマンドの実行結果
    --------------------------------------------------
    Connection to vm11 closed.
    --------------------------------------------------
    
  以下の確認に続く
  
================================================================================
[010]
  PAM認証 - 07
  
[内容]
  ## 作業内容
    コマンド(su)で試行回数以上のパスワード入力でアカウントロック
  
[確認]
  $ cd $HOME
  $ ssh vm11
  
  コマンドの実行結果
  --------------------------------------------------
  Last login: Wed Jul  5 19:01:11 2023 from 192.168.122.1
  --------------------------------------------------
    
    vm11$ cd $HOME
    vm11$ whoami
    
    コマンドの実行結果
    --------------------------------------------------
    makoto
    --------------------------------------------------
    
    vm11$ cd $HOME
    vm11$ su - user1
    vm11$ su - user1
    vm11$ su - user1
    vm11$ su - user1
    vm11$ su - user1
    
    コマンドの実行結果
    --------------------------------------------------
    // 1回目
    パスワード: (不正パスワード)
    su: 認証失敗
    
    // 2回目
    パスワード: (不正パスワード)
    su: 認証失敗
    
    // 3回目
    パスワード: (不正パスワード)
    su: 認証失敗
    
    // 4回目
    パスワード: (不正パスワード)
    su: 認証失敗
    
    // 5回目
    パスワード: (正しいパスワード入力)
    --------------------------------------------------
      
      vm11$ cd $HOME
      vm11$ exit
      
      コマンドの実行結果
      --------------------------------------------------
      ログアウト
      --------------------------------------------------
      
    vm11$ cd $HOME
    vm11$ sudo vi /etc/pam.d/su
    
    コマンドの実行結果
    --------------------------------------------------
    #%PAM-1.0
    auth            required        pam_env.so
    # auth          sufficient      pam_rootok.so
    # auth          sufficient      pam_wheel.so trust use_uid
    auth            substack        system-auth  // 今回はここを修正
    auth            include         postlogin
    account         sufficient      pam_succeed_if.so uid = 0 use_uid quiet
    account         include         system-auth
    password        include         system-auth
    session         include         system-auth
    session         include         postlogin
    session         optional        pam_xauth.so
    --------------------------------------------------
    
    vm11$ cd $HOME
    vm11$ man pam_faillock -> マニュアル参照
    
    コマンドの実行結果
    --------------------------------------------------
    (省略) => auth … pam_faillock.so パラメータ値
    --------------------------------------------------
    
    vm11$ cd $HOME
    vm11$ sudo find /usr/lib64 -name pam_faillock.so -> モジュール存在チェック
    
    コマンドの実行結果
    --------------------------------------------------
    /usr/lib64/security/pam_faillock.so
    --------------------------------------------------
    
    vm11$ cd $HOME
    vm11$ sudo vi /etc/pam.d/system-auth
    
    コマンドの実行結果
    --------------------------------------------------
    #%PAM-1.0
    auth        required      pam_env.so
    auth        required      pam_faillock.so preauth silent audit deny=3 unlock_time=0  // 追加
    auth        sufficient    pam_unix.so try_first_pass nullok
    auth        [default=die] pam_faillock.so authfail audit deny=3 unlock_time=0  // 追加
    auth        required      pam_deny.so
    account     required      pam_unix.so
    account     required      pam_faillock.so  // 追加
    password    requisite     pam_pwquality.so try_first_pass local_users_only retry=3 authtok_type=
    password    sufficient    pam_unix.so try_first_pass use_authtok nullok sha512 shadow
    password    required      pam_deny.so
    session     optional      pam_keyinit.so revoke
    session     required      pam_limits.so
    -session    optional      pam_systemd.so
    session     [success=1 default=ignore] pam_succeed_if.so service in crond quiet use_uid
    session     required      pam_unix.so
    --------------------------------------------------
    
    vm11$ cd $HOME
    vm11$ su - user1
    vm11$ su - user1
    vm11$ su - user1
    vm11$ su - user1
    vm11$ su - user1
    
    コマンドの実行結果
    --------------------------------------------------
    // 1回目
    パスワード: (不正パスワード)
    su: 拒否されたパーミッション
    
    // 2回目
    パスワード: (不正パスワード)
    su: 拒否されたパーミッション
    
    // 3回目
    パスワード: (不正パスワード)
    su: 拒否されたパーミッション => この時点でロックされる模様
    
    // 4回目
    パスワード: (不正パスワード)
    su: 認証失敗
    
    // 5回目
    パスワード: (正しいパスワード入力)
    su: 認証失敗
    --------------------------------------------------
    
    vm11$ cd $HOME
    vm11$ sudo faillock -> 認証失敗の情報確認
    
    コマンドの実行結果
    --------------------------------------------------
    makoto:
    When                 Type  Source  Valid
    
    user1:
    When                 Type  Source  Valid
    2023-07-05 21:17:55  TTY   pts/0       V  // 1回目
    2023-07-05 21:18:16  TTY   pts/0       V  // 2回目
    2023-07-05 21:18:31  TTY   pts/0       V  // 3回目
    --------------------------------------------------
    
    vm11$ cd $HOME
    vm11$ sudo faillock --user user1 --reset -> アカウントロック解除
    
    コマンドの実行結果
    --------------------------------------------------
    (省略) -> 出力なし
    --------------------------------------------------
    
    vm11$ cd $HOME
    vm11$ sudo faillock -> 認証失敗の情報確認
    
    コマンドの実行結果
    --------------------------------------------------
    makoto:
    When                 Type  Source  Valid
    
    user1:
    When                 Type  Source  Valid
    --------------------------------------------------
    
    vm11$ cd $HOME
    vm11$ sudo vi /etc/pam.d/system-auth
    
    コマンドの実行結果
    --------------------------------------------------
    #%PAM-1.0
    auth        required      pam_env.so
    auth        required      pam_faillock.so preauth silent audit deny=3 unlock_time=0  // 削除
    auth        sufficient    pam_unix.so try_first_pass nullok
    auth        [default=die] pam_faillock.so authfail audit deny=3 unlock_time=0  // 削除
    auth        required      pam_deny.so
    account     required      pam_unix.so
    account     required      pam_faillock.so  // 削除
    password    requisite     pam_pwquality.so try_first_pass local_users_only retry=3 authtok_type=
    password    sufficient    pam_unix.so try_first_pass use_authtok nullok sha512 shadow
    password    required      pam_deny.so
    session     optional      pam_keyinit.so revoke
    session     required      pam_limits.so
    -session    optional      pam_systemd.so
    session     [success=1 default=ignore] pam_succeed_if.so service in crond quiet use_uid
    session     required      pam_unix.so
    --------------------------------------------------
    
    vm11$ cd $HOME
    vm11$ exit
    
    コマンドの実行結果
    --------------------------------------------------
    Connection to vm11 closed.
    --------------------------------------------------
    
  以下の確認に続く
  
================================================================================
[011]
  OpenLDAP - 01
  
[内容]
  ## 作業内容
    ディレクトリ作成
  
[確認]
  $ cd $HOME
  $ ssh vm11
  
  コマンドの実行結果
  --------------------------------------------------
  Last login: Wed Jul  5 21:40:36 2023 from 192.168.122.1
  --------------------------------------------------
    
    vm11$ cd $HOME
    vm11$ sudo dnf --enablerepo=powertools -y install openldap-servers openldap-clients
    
    コマンドの実行結果
    --------------------------------------------------
    (省略) -> エラー出力が無ければOK
    --------------------------------------------------
    
    vm11$ cd $HOME
    vm11$ sudo cp -p /usr/share/openldap-servers/DB_CONFIG.example /var/lib/ldap/DB_CONFIG -> 基本設定ファイルをコピー
    
    コマンドの実行結果
    --------------------------------------------------
    (省略) -> 出力なし
    --------------------------------------------------
    
    vm11$ cd $HOME
    vm11$ sudo firewall-cmd --add-service=ldap --permanent
    
    コマンドの実行結果
    --------------------------------------------------
    success
    --------------------------------------------------
    
    vm11$ cd $HOME
    vm11$ exit
    
    コマンドの実行結果
    --------------------------------------------------
    Connection to vm11 closed.
    --------------------------------------------------
    
  $ cd $HOME
  $ sudo virsh destroy vm11
  
  コマンドの実行結果
  --------------------------------------------------
  Domain 'vm11' destroyed
  --------------------------------------------------
  
  $ cd $HOME
  $ sudo virsh start vm11
  
  コマンドの実行結果
  --------------------------------------------------
  Domain 'vm11' started
  --------------------------------------------------
  
  $ cd $HOME
  $ ssh vm11
  
  コマンドの実行結果
  --------------------------------------------------
  Last login: Thu Jul  6 09:52:30 2023 from 192.168.122.1
  --------------------------------------------------
    
    vm11$ cd $HOME
    vm11$ sudo firewall-cmd --list-all
    
    コマンドの実行結果
    --------------------------------------------------
    public
      target: default
      icmp-block-inversion: no
      interfaces: 
      sources: 
      services: cockpit dhcpv6-client dns http https iscsi-target ldap nfs squid ssh telnet  // ldap を確認
      ports: 12865/tcp 12866/tcp
      protocols: 
      forward: no
      masquerade: no
      forward-ports: 
      source-ports: 
      icmp-blocks: 
      rich rules: 
    --------------------------------------------------
    
    vm11$ cd $HOME
    vm11$ sudo systemctl start slapd
    
    コマンドの実行結果
    --------------------------------------------------
    (省略) -> 出力なし
    --------------------------------------------------
    
    vm11$ cd $HOME
    vm11$ sudo ldapsearch  // 内部データベース一覧
        > -LLL             // バージョンやコメント非表示
        > -Y external      // パスワード無しでローカル接続
        > -H ldapi:///     // ローカルサーバー
        > -b cn=config     // 検索開始DN
        > DN               // 検索対象
    
    コマンドの実行結果
    --------------------------------------------------
    // 認証状況
    SASL/EXTERNAL authentication started
    SASL username: gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth
    SASL SSF: 0
    
    // 検索結果(内部データベース一覧) => 接頭辞の「olc」はオンライン制御
    dn: cn=config
    dn: cn=schema,cn=config
    dn: cn={0}core,cn=schema,cn=config
    dn: olcDatabase={-1}frontend,cn=config  // 不明
    dn: olcDatabase={0}config,cn=config     // 設定データベース
    dn: olcDatabase={1}monitor,cn=config    // 不明
    dn: olcDatabase={2}mdb,cn=config        // ディレクトリ場所
    --------------------------------------------------
    
    vm11$ cd $HOME
    vm11$ sudo ldapsearch
        > -LLL
        > -Y external
        > -H ldapi:///
        > -b 'olcDatabase={0}config,cn=config'
    
    コマンドの実行結果
    --------------------------------------------------
    // 認証状況
    SASL/EXTERNAL authentication started
    SASL username: gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth
    SASL SSF: 0
    
    // 設定データベース
    dn: olcDatabase={0}config,cn=config
      objectClass: olcDatabaseConfig
      olcDatabase: {0}config
      olcAccess: {0}to * by dn.base="gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth" manage by * none
    --------------------------------------------------
    
    vm11$ cd $HOME
    vm11$ sudo slappasswd -s rt0122ma -> 設定データベース用の管理者パスワード生成
    
    コマンドの実行結果
    --------------------------------------------------
    {SSHA}Yao2ZmJIvd+F+hRcXsqJZIJS3sdh5wjf
    --------------------------------------------------
    
    vm11$ cd $HOME
    vm11$ mkdir ldap
    
    コマンドの実行結果
    --------------------------------------------------
    (省略) -> 出力なし
    --------------------------------------------------
    
    vm11$ cd $HOME
    vm11$ vi ldap/file01.ldif
    
    コマンドの実行結果
    --------------------------------------------------
    dn: olcDatabase={0}config,cn=config                // 設定データベース用のDN
    changetype: modify                                 // 変更タイプ
    add: olcRootPW                                     // 追加する項目名
    olcRootPW: {SSHA}Yao2ZmJIvd+F+hRcXsqJZIJS3sdh5wjf  // 項目の設定値
    --------------------------------------------------
    
    vm11$ cd $HOME
    vm11$ sudo ldapmodify
        > -Y external
        > -H ldapi:///
        > -f ldap/file01.ldif
    
    コマンドの実行結果
    --------------------------------------------------
    // 認証状況
    SASL/EXTERNAL authentication started
    SASL username: gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth
    SASL SSF: 0
    
    // 実行結果
    modifying entry "olcDatabase={0}config,cn=config"
    --------------------------------------------------
    
    vm11$ cd $HOME
    vm11$ sudo ldapsearch
        > -LLL
        > -Y external
        > -H ldapi:///
        > -b 'olcDatabase={0}config,cn=config'
    
    コマンドの実行結果
    --------------------------------------------------
    // 認証状況
    SASL/EXTERNAL authentication started
    SASL username: gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth
    SASL SSF: 0
    
    // 設定データベース
    dn: olcDatabase={0}config,cn=config
      objectClass: olcDatabaseConfig
      olcDatabase: {0}config
      olcAccess: {0}to * by dn.base="gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth" manage by * none
      olcRootPW: {SSHA}Yao2ZmJIvd+F+hRcXsqJZIJS3sdh5wjf  // 追加
    --------------------------------------------------
    
    vm11$ cd $HOME
    vm11$ sudo ldapsearch
        > -LLL
        > -Y external
        > -H ldapi:///
        > -b 'olcDatabase={2}mdb,cn=config'
    
    コマンドの実行結果
    --------------------------------------------------
    // 認証状況
    SASL/EXTERNAL authentication started
    SASL username: gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth
    SASL SSF: 0
    
    // ディレクトリ場所
    dn: olcDatabase={2}mdb,cn=config
      objectClass: olcDatabaseConfig
      objectClass: olcMdbConfig
      olcDatabase: {2}mdb
      olcDbDirectory: /var/lib/ldap
      olcSuffix: dc=my-domain,dc=com
      olcRootDN: cn=Manager,dc=my-domain,dc=com
      olcDbIndex: objectClass eq,pres
      olcDbIndex: ou,cn,mail,surname,givenname eq,pres,sub
    --------------------------------------------------
    
    vm11$ cd $HOME
    vm11$ slappasswd -s avswa-master -> ドメインの管理者パスワード生成
    
    コマンドの実行結果
    --------------------------------------------------
    {SSHA}62rs6VrI/zGhWbgnqSfnVnAuRi8KWzws
    --------------------------------------------------
    
    vm11$ cd $HOME
    vm11$ vi ldap/file02.ldif
    
    コマンドの実行結果
    --------------------------------------------------
    dn: olcDatabase={2}mdb,cn=config
    changetype: modify
    replace: olcSuffix
    olcSuffix: dc=avswa,dc=com
    
    dn: olcDatabase={2}mdb,cn=config
    changetype: modify
    replace: olcRootDN
    olcRootDN: cn=Manager,dc=avswa,dc=com
    
    dn: olcDatabase={2}mdb,cn=config
    changetype: modify
    add: olcRootPW
    olcRootPW: {SSHA}62rs6VrI/zGhWbgnqSfnVnAuRi8KWzws
    --------------------------------------------------
    
    vm11$ cd $HOME
    vm11$ sudo ldapmodify
        > -Y external
        > -H ldapi:///
        > -f ldap/file02.ldif
    
    コマンドの実行結果
    --------------------------------------------------
    // 認証状況
    SASL/EXTERNAL authentication started
    SASL username: gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth
    SASL SSF: 0
    
    // 実行結果
    modifying entry "olcDatabase={2}mdb,cn=config"
    modifying entry "olcDatabase={2}mdb,cn=config"
    modifying entry "olcDatabase={2}mdb,cn=config"
    --------------------------------------------------
    
    vm11$ cd $HOME
    vm11$ sudo ldapsearch
        > -LLL
        > -Y external
        > -H ldapi:///
        > -b 'olcDatabase={2}mdb,cn=config'
    
    コマンドの実行結果
    --------------------------------------------------
    // 認証状況
    SASL/EXTERNAL authentication started
    SASL username: gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth
    SASL SSF: 0
    
    // ディレクトリ場所
    dn: olcDatabase={2}mdb,cn=config
      objectClass: olcDatabaseConfig
      objectClass: olcMdbConfig
      olcDatabase: {2}mdb
      olcDbDirectory: /var/lib/ldap
      olcDbIndex: objectClass eq,pres
      olcDbIndex: ou,cn,mail,surname,givenname eq,pres,sub
      olcSuffix: dc=avswa,dc=com                         // ドメイン
      olcRootDN: cn=Manager,dc=avswa,dc=com              // ドメイン管理者
      olcRootPW: {SSHA}62rs6VrI/zGhWbgnqSfnVnAuRi8KWzws  // 管理者パスワード
    --------------------------------------------------
    
    vm11$ cd $HOME
    vm11$ exit
    
    コマンドの実行結果
    --------------------------------------------------
    Connection to vm11 closed.
    --------------------------------------------------
    
  以下の確認に続く
  
================================================================================
[012]
  OpenLDAP - 02
  
[内容]
  ## 作業内容
    スキーマ登録 => スキーマ(inetOrgPerson)を登録してみる
  
[確認]
  $ cd $HOME
  $ ssh vm11
  
  コマンドの実行結果
  --------------------------------------------------
  Last login: Thu Jul  6 12:32:19 2023 from 192.168.122.1
  --------------------------------------------------
    
    vm11$ cd $HOME
    vm11$ ls -lh /etc/openldap/schema/*.ldif -> スキーマ登録ファイル
    
    コマンドの実行結果
    --------------------------------------------------
    -r--r--r--. 1 root root 2.0K 10月 12  2021 /etc/openldap/schema/collective.ldif
    -r--r--r--. 1 root root 1.9K 10月 12  2021 /etc/openldap/schema/corba.ldif
    -r--r--r--. 1 root root  21K 10月 12  2021 /etc/openldap/schema/core.ldif           // 初期状態で登録済
    -r--r--r--. 1 root root  12K 10月 12  2021 /etc/openldap/schema/cosine.ldif         // 登録予定
    -r--r--r--. 1 root root 6.7K 10月 12  2021 /etc/openldap/schema/nis.ldif            // 登録予定
    -r--r--r--. 1 root root 3.4K 10月 12  2021 /etc/openldap/schema/inetorgperson.ldif  // 登録予定
    -r--r--r--. 1 root root 4.8K 10月 12  2021 /etc/openldap/schema/duaconf.ldif
    -r--r--r--. 1 root root 3.3K 10月 12  2021 /etc/openldap/schema/dyngroup.ldif
    -r--r--r--. 1 root root 3.0K 10月 12  2021 /etc/openldap/schema/java.ldif
    -r--r--r--. 1 root root 2.1K 10月 12  2021 /etc/openldap/schema/misc.ldif
    -r--r--r--. 1 root root 3.3K 10月 12  2021 /etc/openldap/schema/openldap.ldif
    -r--r--r--. 1 root root 6.8K 10月 12  2021 /etc/openldap/schema/pmi.ldif
    -r--r--r--. 1 root root 4.5K 10月 12  2021 /etc/openldap/schema/ppolicy.ldif
    --------------------------------------------------
    
    vm11$ cd $HOME
    vm11$ sudo ldapadd
        > -Y external
        > -H ldapi:///
        > -f /etc/openldap/schema/cosine.ldif
    
    コマンドの実行結果
    --------------------------------------------------
    // 認証状況
    SASL/EXTERNAL authentication started
    SASL username: gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth
    SASL SSF: 0
    
    // 実行結果
    adding new entry "cn=cosine,cn=schema,cn=config"
    --------------------------------------------------
    
    vm11$ cd $HOME
    vm11$ sudo ldapadd
        > -Y external
        > -H ldapi:///
        > -f /etc/openldap/schema/nis.ldif
    
    コマンドの実行結果
    --------------------------------------------------
    // 認証状況
    SASL/EXTERNAL authentication started
    SASL username: gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth
    SASL SSF: 0
    
    // 実行結果
    adding new entry "cn=nis,cn=schema,cn=config"
    --------------------------------------------------
    
    vm11$ cd $HOME
    vm11$ sudo ldapadd
        > -Y external
        > -H ldapi:///
        > -f /etc/openldap/schema/inetorgperson.ldif
    
    コマンドの実行結果
    --------------------------------------------------
    // 認証状況
    SASL/EXTERNAL authentication started
    SASL username: gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth
    SASL SSF: 0
    
    // 実行結果
    adding new entry "cn=inetorgperson,cn=schema,cn=config"
    --------------------------------------------------
    
    vm11$ cd $HOME
    vm11$ exit
    
    コマンドの実行結果
    --------------------------------------------------
    Connection to vm11 closed.
    --------------------------------------------------
    
  以下の確認に続く
  
================================================================================
[013]
  OpenLDAP - 03
  
[内容]
  ## 作業内容
    ディレクトリにデータ登録(1)
  
[確認]
  $ cd $HOME
  $ ssh vm11
  
  コマンドの実行結果
  --------------------------------------------------
  Last login: Fri Jul  7 16:18:12 2023 from 192.168.122.1
  --------------------------------------------------
    
    vm11$ cd $HOME
    vm11$ vi ldap/file03.ldif
    
    コマンドの実行結果
    --------------------------------------------------
    ## avswa.com
    dn: dc=avswa,dc=com
    objectClass: dcObject
    objectClass: organization
    dc: avswa
    o: avswa.com
    
    ## Tokyo.avswa.com
    dn: ou=Tokyo,dc=avswa,dc=com
    objectClass: organizationalUnit
    ou: Tokyo
    
    ## Group1.Tokyo.avswa.com
    dn: ou=Group1,ou=Tokyo,dc=avswa,dc=com
    objectClass: organizationalUnit
    ou: Group1
    
    ## Group2.Tokyo.avswa.com
    dn: ou=Group2,ou=Tokyo,dc=avswa,dc=com
    objectClass: organizationalUnit
    ou: Group2
    
    ## Osaka.avswa.com
    dn: ou=Osaka,dc=avswa,dc=com
    objectClass: organizationalUnit
    ou: Osaka
    
    ## Group1.Osaka.avswa.com
    dn: ou=Group1,ou=Osaka,dc=avswa,dc=com
    objectClass: organizationalUnit
    ou: Group1
    
    ## Group2.Osaka.avswa.com
    dn: ou=Group2,ou=Osaka,dc=avswa,dc=com
    objectClass: organizationalUnit
    ou: Group2
    --------------------------------------------------
    
    vm11$ cd $HOME
    vm11$ sudo ldapadd
        > -x
        > -D cn=Manager,dc=avswa,dc=com
        > -w avswa-master
        > -f ldap/file03.ldif
    
    コマンドの実行結果
    --------------------------------------------------
    adding new entry "dc=avswa,dc=com"
    adding new entry "ou=Tokyo,dc=avswa,dc=com"
    adding new entry "ou=Group1,ou=Tokyo,dc=avswa,dc=com"
    adding new entry "ou=Group2,ou=Tokyo,dc=avswa,dc=com"
    adding new entry "ou=Osaka,dc=avswa,dc=com"
    adding new entry "ou=Group1,ou=Osaka,dc=avswa,dc=com"
    adding new entry "ou=Group2,ou=Osaka,dc=avswa,dc=com"
    --------------------------------------------------
    
    vm11$ cd $HOME
    vm11$ sudo ldapsearch
        > -LLL
        > -Y external
        > -H ldapi:///
        > -b 'dc=avswa,dc=com'
    
    コマンドの実行結果
    --------------------------------------------------
    // 認証状況
    SASL/EXTERNAL authentication started
    SASL username: gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth
    SASL SSF: 0
    
    // avswa.com
    dn: dc=avswa,dc=com
      objectClass: dcObject
      objectClass: organization
      dc: avswa
      o: avswa.com
    
    // Tokyo.avswa.com
    dn: ou=Tokyo,dc=avswa,dc=com
      objectClass: organizationalUnit
      ou: Tokyo
    
    // Group1.Tokyo.avswa.com
    dn: ou=Group1,ou=Tokyo,dc=avswa,dc=com
      objectClass: organizationalUnit
      ou: Group1
    
    // Group2.Tokyo.avswa.com
    dn: ou=Group2,ou=Tokyo,dc=avswa,dc=com
      objectClass: organizationalUnit
      ou: Group2
    
    // Osaka.avswa.com
    dn: ou=Osaka,dc=avswa,dc=com
      objectClass: organizationalUnit
      ou: Osaka
    
    // Group1.Osaka.avswa.com
    dn: ou=Group1,ou=Osaka,dc=avswa,dc=com
      objectClass: organizationalUnit
      ou: Group1
    
    // Group2.Osaka.avswa.com
    dn: ou=Group2,ou=Osaka,dc=avswa,dc=com
      objectClass: organizationalUnit
      ou: Group2
    --------------------------------------------------
    
    vm11$ cd $HOME
    vm11$ exit
    
    コマンドの実行結果
    --------------------------------------------------
    Connection to vm11 closed.
    --------------------------------------------------
    
  以下の確認に続く
  
================================================================================
[006]
  LDAP - 02 (認証時にディレクトリ参照)
  
[内容]
  ## 作業内容
    認証時に「LDAP」のディレクトリを参照する
  
  ## 使用マシン
    HOST : vm12
    IPV4 : 192.168.122.12
    MEMO : LDAP Server
  
  ## 使用マシン
    HOST : vm13
    IPV4 : 192.168.122.13
    MEMO : LDAP Client
  
[確認]
  vm12# cd $HOME
  vm12# systemctl start slapd (サービスの起動)
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> 出力なし
  --------------------------------------------------
  
  vm12# cd $HOME
  vm12# yum -y install nss-pam-ldapd sssd sssd-client sssd-ldap (パッケージ追加)
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> エラー出力が無ければOK
  --------------------------------------------------
  
  vm12# cd $HOME
  vm12# setenforce 0 (SELinuxを無効化)
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> 出力なし
  --------------------------------------------------
  
  vm12# cd /etc/sssd
  vm12# vi sssd.conf (設定ファイルを作成)
  
  コマンドの実行結果
  --------------------------------------------------
  [domain/default]
  autofs_provider = ldap
  cache_credentials = True          // 認証情報のキャッシュ保存
  ldap_uri = ldapi:///              // サーバーのURI
  ldap_search_base = dc=AAA,dc=com  // ベースDN
  id_provider = ldap                // バックエンド
  auth_provider = ldap
  chpass_provider = ldap
  ldap_tls_cacertdir = /etc/openldap/cacerts
  enumerate = true
  
  [sssd]
  services = nss, pam, autofs
  domains = default
  
  [nss]
  homedir_substring = /home
  
  [pam]
  # No Settings
  
  [sudo]
  # No Settings
  
  [autofs]
  # No Settings
  
  [ssh]
  # No Settings
  
  [pac]
  # No Settings
  
  [ifp]
  # No Settings
  
  [secrets]
  # No Settings
  
  [session_recording]
  # No Settings
  --------------------------------------------------
  
  vm12# cd /etc/sssd
  vm12# chown root.root sssd.conf ; chmod 600 sssd.conf (設定ファイルの所有者と権限変更)
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> 出力なし
  --------------------------------------------------
  
  vm12# cd $HOME
  vm12# systemctl restart sssd (サービスの再起動)
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> 出力なし
  --------------------------------------------------
  
  vm12# cd $HOME
  vm12# (認証メカニズムを変更)
    authconfig
    --enableldap                    // LDAPを有効化
    --enableldapauth                // LDAP認証を有効化
    --ldapserver=ldap://localhost/  // サーバーを指定
    --ldapbasedn=dc=AAA,dc=com      // ベースDN
    --enablemkhomedir               // 自動的にホームディレクトリ作成
    --enablesssd                    // SSSDを有効化
    --enablesssdauth                // SSSD認証を有効化
    --update                        // 設定を反映
  
  コマンドの実行結果
  --------------------------------------------------
  [ 5811.405620] SELinux:  Converting 2287 SID table entries...
  [ 5812.344867] SELinux:  Context system_u:unconfined_r:sandbox_t:s0-s0:c0.c1023 became invalid (unmapped).
  [ 5813.466544] SELinux:  Context unconfined_u:unconfined_r:sandbox_t:s0-s0:c0.c1023 became invalid (unmapped).
  --------------------------------------------------
  
  vm12# cd $HOME
  vm12# vi /etc/nsswitch.conf (ネットワーク設定ファイルを確認)
  
  コマンドの実行結果
  --------------------------------------------------
  passwd: files sss ldap  // ldap を追加
  shadow: files sss ldap  // ldap を追加
  group:  files sss ldap  // ldap を追加
  --------------------------------------------------
  
  vm12# cd $HOME
  vm12# getent group | grep -E Group0[1-2] (システムにLDAPグループが存在することを確認)
  
  コマンドの実行結果
  --------------------------------------------------
  Group01:*:1041:
  Group02:*:1042:
  --------------------------------------------------
  
  vm12# cd $HOME
  vm12# getent passwd | grep -E user0[1-4] (システムにLDAPユーザーが存在することを確認)
  
  コマンドの実行結果
  --------------------------------------------------
  user01:*:1051:1041:User01:/home/user01:/bin/bash
  user02:*:1052:1041:User02:/home/user02:/bin/bash
  user03:*:1053:1042:User03:/home/user03:/bin/bash
  user04:*:1054:1042:User04:/home/user04:/bin/bash
  --------------------------------------------------
  
  vm12# cd $HOME
  vm12# ls -lh /home (ホームディレクトリはまだ存在しないことを確認)
  
  コマンドの実行結果
  --------------------------------------------------
  drwx------. 2 makoto makoto 97 12月  1 19:49 makoto
  --------------------------------------------------
  
  vm12# cd $HOME
  vm12# su - user01 (LDAPユーザーに変更)
  
  コマンドの実行結果
  --------------------------------------------------
  ディレクトリ '/home/user01' を作成中
  --------------------------------------------------
  
  vm12$ cd $HOME
  vm12$ id $(whoami) ; pwd (ユーザー名とホームディレクトリを確認)
  
  コマンドの実行結果
  --------------------------------------------------
  uid=1051(user01) gid=1041(Group01) groups=1041(Group01)
  /home/user01
  --------------------------------------------------
  
  vm12$ cd $HOME
  vm12$ ls -la (ホームディレクトリ内を確認)
  
  コマンドの実行結果
  --------------------------------------------------
  drwx------. 2 user01 Group01  83  1月 31 12:54 .
  drwxr-xr-x. 4 root   root     34  1月 31 12:52 ..
  -rw-------. 1 user01 Group01  36  1月 31 12:54 .bash_history
  -rw-------. 1 user01 Group01  18  1月 31 12:52 .bash_logout
  -rw-------. 1 user01 Group01 193  1月 31 12:52 .bash_profile
  -rw-------. 1 user01 Group01 231  1月 31 12:52 .bashrc
  --------------------------------------------------
  
  vm12$ cd $HOME
  vm12$ exit (元のユーザーに戻る)
  
  コマンドの実行結果
  --------------------------------------------------
  ログアウト
  --------------------------------------------------
    
    vm13# cd $HOME
    vm13# yum -y install nss-pam-ldapd sssd sssd-client sssd-ldap (パッケージ追加)
    
    コマンドの実行結果
    --------------------------------------------------
    (省略) -> エラー出力が無ければOK
    --------------------------------------------------
    
    vm13# cd $HOME
    vm13# setenforce 0 (SELinuxを無効化)
    
    コマンドの実行結果
    --------------------------------------------------
    (省略) -> 出力なし
    --------------------------------------------------
    
    vm13# cd /etc/sssd
    vm13# vi sssd.conf (設定ファイルを作成)
    
    コマンドの実行結果
    --------------------------------------------------
    [domain/default]
    autofs_provider = ldap
    cache_credentials = True          // 認証情報のキャッシュ保存
    ldap_uri = ldapi://vm12/          // サーバーのURI
    ldap_search_base = dc=AAA,dc=com  // ベースDN
    id_provider = ldap                // バックエンド
    auth_provider = ldap
    chpass_provider = ldap
    ldap_tls_cacertdir = /etc/openldap/cacerts
    enumerate = true
    
    [sssd]
    services = nss, pam, autofs
    domains = default
    
    [nss]
    homedir_substring = /home
    
    [pam]
    # No Settings
    
    [sudo]
    # No Settings
    
    [autofs]
    # No Settings
    
    [ssh]
    # No Settings
    
    [pac]
    # No Settings
    
    [ifp]
    # No Settings
    
    [secrets]
    # No Settings
    
    [session_recording]
    # No Settings
    --------------------------------------------------
    
    vm13# cd /etc/sssd
    vm13# chown root.root sssd.conf ; chmod 600 sssd.conf (設定ファイルの所有者と権限変更)
    
    コマンドの実行結果
    --------------------------------------------------
    (省略) -> 出力なし
    --------------------------------------------------
    
    vm13# cd $HOME
    vm13# systemctl restart sssd (サービスの再起動)
    
    コマンドの実行結果
    --------------------------------------------------
    (省略) -> 出力なし
    --------------------------------------------------
    
    vm13# cd $HOME
    vm13# (認証メカニズムを変更)
      authconfig
      --enableldap                    // LDAPを有効化
      --enableldapauth                // LDAP認証を有効化
      --ldapserver=ldap://vm12/       // サーバーを指定
      --ldapbasedn=dc=AAA,dc=com      // ベースDN
      --enablemkhomedir               // 自動的にホームディレクトリ作成
      --enablesssd                    // SSSDを有効化
      --enablesssdauth                // SSSD認証を有効化
      --update                        // 設定を反映
    
    コマンドの実行結果
    --------------------------------------------------
    [ 1920.197366] SELinux:  Converting 2274 SID table entries...
    [ 1921.124316] SELinux:  Context system_u:unconfined_r:sandbox_t:s0-s0:c0.c1023 became invalid (unmapped).
    [ 1922.125931] SELinux:  Context unconfined_u:unconfined_r:sandbox_t:s0-s0:c0.c1023 became invalid (unmapped).
    --------------------------------------------------
    
    vm13# cd $HOME
    vm13# vi /etc/nsswitch.conf (ネットワーク設定ファイルを確認)
    
    コマンドの実行結果
    --------------------------------------------------
    // 確認する箇所
    passwd: files sss
    shadow: files sss
    group:  files sss
    --------------------------------------------------
    
    vm13# cd $HOME
    vm13# getent group | grep -E Group0[1-2] (システムにLDAPグループが存在することを確認)
    
    コマンドの実行結果
    --------------------------------------------------
    Group01:*:1041:
    Group02:*:1042:
    --------------------------------------------------
    
    vm13# cd $HOME
    vm13# getent passwd | grep -E user0[1-4] (システムにLDAPユーザーが存在することを確認)
    
    コマンドの実行結果
    --------------------------------------------------
    user01:*:1051:1041:User01:/home/user01:/bin/bash
    user02:*:1052:1041:User02:/home/user02:/bin/bash
    user03:*:1053:1042:User03:/home/user03:/bin/bash
    user04:*:1054:1042:User04:/home/user04:/bin/bash
    --------------------------------------------------
    
    vm13# cd $HOME
    vm13# ls -lh /home (ホームディレクトリはまだ存在しないことを確認)
    
    コマンドの実行結果
    --------------------------------------------------
    drwx------. 2 makoto makoto 97 12月  1 19:49 makoto
    --------------------------------------------------
    
    vm13# cd $HOME
    vm13# su - user01 (LDAPユーザーに変更)
    
    コマンドの実行結果
    --------------------------------------------------
    ディレクトリ '/home/user01' を作成中
    --------------------------------------------------
    
    vm13$ cd $HOME
    vm13$ id $(whoami) ; pwd (ユーザー名とホームディレクトリを確認)
    
    コマンドの実行結果
    --------------------------------------------------
    uid=1051(user01) gid=1041(Group01) groups=1041(Group01)
    /home/user01
    --------------------------------------------------
    
    vm13$ cd $HOME
    vm13$ ls -la (ホームディレクトリ内を確認)
    
    コマンドの実行結果
    --------------------------------------------------
    drwx------. 2 user01 Group01  62  1月 31 13:09 .
    drwxr-xr-x. 4 root   root     34  1月 31 13:09 ..
    -rw-------. 1 user01 Group01  18  1月 31 13:09 .bash_logout
    -rw-------. 1 user01 Group01 193  1月 31 13:09 .bash_profile
    -rw-------. 1 user01 Group01 231  1月 31 13:09 .bashrc
    --------------------------------------------------
    
    vm13$ cd $HOME
    vm13$ exit (元のユーザーに戻る)
    
    コマンドの実行結果
    --------------------------------------------------
    ログアウト
    --------------------------------------------------
    
    vm13# cd $HOME
    vm13# setenforce 1 (SELinuxを有効化)
    
    コマンドの実行結果
    --------------------------------------------------
    (省略) -> 出力なし
    --------------------------------------------------
    
    vm13# cd $HOME
    vm13# systemctl stop sssd (サービスの停止)
    
    コマンドの実行結果
    --------------------------------------------------
    (省略) -> 出力なし
    --------------------------------------------------
    
  vm12# cd $HOME
  vm12# setenforce 1 (SELinuxを有効化)
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> 出力なし
  --------------------------------------------------
  
  vm12# cd $HOME
  vm12# systemctl stop sssd (サービスの停止)
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> 出力なし
  --------------------------------------------------
  
  vm12# cd $HOME
  vm12# systemctl stop slapd (サービスの停止)
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> 出力なし
  --------------------------------------------------
  
  以下の確認に続く
  
================================================================================
