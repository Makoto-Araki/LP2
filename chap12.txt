================================================================================
[01] DHCP
[02] PAM - 01 (モジュールと設定ファイル)
[03] PAM - 02 (設定ファイルの編集)
[04] PAM - 03 (処理の流れを追跡)
[05] //
================================================================================
[01]
  DHCP
  
[内容]
  ## 作業内容
    DHCPサーバー構築とDHCPクライアントによるIPアドレス取得
  
  ## 使用マシン
    HOST : vm12
    IPV4 : 192.168.122.12
    MEMO : 仮想マシン
  
  ## 使用マシン
    HOST : vm13
    IPV4 : 192.168.122.13
    MEMO : 仮想マシン
  
  ## コマンド(dhclient)
    dhclient -d  // フォアグラウンド処理
    dhclient -r  // 割当情報を開放
    dhclient -H  // リクエスト送付先のホスト指定
  
[確認]
  vm12# cd $HOME
  vm12# yum -y install dhcp (パッケージ追加)
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> エラー出力が無ければOK
  --------------------------------------------------
  
  vm12# cd /etc/dhcp
  vm12# cp -p dhcpd.conf dhcpd.conf.org (設定ファイルのバックアップ)
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> 出力なし
  --------------------------------------------------
  
  vm12# cd /etc/dhcp
  vm12# vi dhcpd.conf (設定ファイルの作成)
  
  コマンドの実行結果
  --------------------------------------------------
  ## ネットワーク 192.168.122.0/24
  subnet 192.168.122.0 netmask 255.255.255.0 {
    option routers 192.168.122.1;              // ルーター
    option subnet-mask 255.255.255.0;          // サブネットマスク
    option domain-name "example.com";          // ドメイン名
    option domain-name-servers 192.168.122.1;  // DNSサーバー
    range 192.168.122.100 192.168.122.150;     // IPアドレス - リース範囲
    default-lease-time 21600;                  // IPアドレス - リース期間(秒)
    max-lease-time 43200;                      // IPアドレス - 最大期間(秒)
    
    ## ホスト(vm13)
    host vm13 {
      hardware ethernet 52:54:00:05:4e:7c;  // MACアドレス
      fixed-address 192.168.122.51;         // 固定IPアドレスを付与
    }
  }
  --------------------------------------------------
  
  vm12# cd $HOME
  vm12# systemctl start dhcpd (サービスの起動)
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> 出力なし
  --------------------------------------------------
    
    vm13$ cd $HOME
    vm13$ ip addr show eth0 (IPアドレスを確認)
    
    コマンドの実行結果
    --------------------------------------------------
    2: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000
      link/ether 52:54:00:05:4e:7c brd ff:ff:ff:ff:ff:ff
      inet 192.168.122.13/24 brd 192.168.122.255 scope global noprefixroute eth0  // IPv4 = 192.168.122.13
        valid_lft forever preferred_lft forever
      inet6 fe80::5054:ff:fe05:4e7c/64 scope link 
        valid_lft forever preferred_lft forever
    --------------------------------------------------
    
    vm13$ cd $HOME
    vm13$ sudo vi /etc/hosts (設定ファイル修正)
    
    コマンドの実行結果
    --------------------------------------------------
    127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
    ::1         localhost localhost.localdomain localhost6 localhost6.localdomain6
    192.168.122.11 vm11
    192.168.122.12 vm12 vm12.example.com
    192.168.122.13 vm13 (削除)
    192.168.122.14 vm14
    --------------------------------------------------
    
    vm13$ cd $HOME
    vm13$ nmcli connection (ネットワーク接続プロファイル)
    
    コマンドの実行結果
    --------------------------------------------------
    NAME  UUID                                  TYPE      DEVICE 
    eth0  db786b62-d32c-49b8-aa68-c3f8d11f218b  ethernet  eth0   
    --------------------------------------------------
    
    vm13$ cd $HOME
    vm13$ LANG=C nmcli -f ipv4 connection show eth0 (ネットワーク接続プロファイルからIPv4のみ抽出)
    
    コマンドの実行結果
    --------------------------------------------------
    ipv4.method             : manual
    ipv4.dns                : 192.168.122.1
    ipv4.dns-search         : --
    ipv4.dns-options        : ""
    ipv4.dns-priority       : 0
    ipv4.addresses          : 192.168.122.13/24
    ipv4.gateway            : 192.168.122.1
    ipv4.routes             : --
    ipv4.route-metric       : -1
    ipv4.route-table        : 0 (unspec)
    ipv4.routing-rules      : --
    ipv4.ignore-auto-routes : no
    ipv4.ignore-auto-dns    : no
    ipv4.dhcp-client-id     : --
    ipv4.dhcp-timeout       : 0 (default)
    ipv4.dhcp-send-hostname : yes
    ipv4.dhcp-hostname      : --
    ipv4.dhcp-fqdn          : --
    ipv4.never-default      : no
    ipv4.may-fail           : yes
    ipv4.dad-timeout        : -1 (default)
    --------------------------------------------------
    
    vm13$ cd $HOME
    vm13$ sudo nmcli connection down eth0 (ネットワーク接続プロファイルを無効化)
    
    コマンドの実行結果
    --------------------------------------------------
    接続 'eth0' が正常に非アクティブ化されました (D-Bus アクティブパス: /org/freedesktop/NetworkManager/ActiveConnection/1)
    --------------------------------------------------
    
    vm13$ cd $HOME
    vm13$ ip addr show eth0 (IPアドレスを確認)
    
    コマンドの実行結果
    --------------------------------------------------
    2: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000
      link/ether 52:54:00:05:4e:7c brd ff:ff:ff:ff:ff:ff
      // IPv4 is not gone
    --------------------------------------------------
    
    vm13$ cd $HOME
    vm13$ sudo dhclient -d -H vm12 eth0 (フォアグラウンド処理、DHCPサーバー指定でIPアドレス取得)
    
    コマンドの実行結果
    --------------------------------------------------
    // 省略

    Listening on LPF/eth0/52:54:00:05:4e:7c
    Sending on   LPF/eth0/52:54:00:05:4e:7c
    Sending on   Socket/fallback
    DHCPREQUEST on eth0 to 255.255.255.255 port 67 (xid=0x70672627)
    DHCPACK from 192.168.122.12 (xid=0x70672627)
    bound to 192.168.122.51 -- renewal in 10571 seconds.

    // 終了(Ctrl + C)
    --------------------------------------------------
    
    vm13$ cd $HOME
    vm13$ ip addr show eth0 (IPアドレスを確認)
    
    コマンドの実行結果
    --------------------------------------------------
    2: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000
      link/ether 52:54:00:05:4e:7c brd ff:ff:ff:ff:ff:ff
      inet 192.168.122.51/24 brd 192.168.122.255 scope global dynamic eth0  // IPv4 = 192.168.122.51
        valid_lft 21554sec preferred_lft 21554sec
    --------------------------------------------------
    
    vm13$ cd $HOME
    vm13$ sudo vi /etc/hosts (設定ファイル修正)
    
    コマンドの実行結果
    --------------------------------------------------
    127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
    ::1         localhost localhost.localdomain localhost6 localhost6.localdomain6
    192.168.122.11 vm11
    192.168.122.12 vm12 vm12.example.com
    192.168.122.13 vm13 (元に戻す)
    192.168.122.14 vm14
    --------------------------------------------------
    
    vm13$ cd $HOME
    vm13$ sudo systemctl poweroff (仮想マシンのシャットダウン)
    
    コマンドの実行結果
    --------------------------------------------------
    (省略)
    --------------------------------------------------
    
  vm12# cd $HOME
  vm12# systemctl stop dhcpd (サービスの停止)
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> 出力なし
  --------------------------------------------------
  
  以下の確認に続く
  
================================================================================
[02]
  PAM - 01 (モジュールと設定ファイル)
  
[内容]
  ## 作業内容
    Linuxの認証機構(PAM)で使用されるモジュールと設定ファイルを見て行く
  
  ## 使用マシン
    HOST : vm12
    IPV4 : 192.168.122.12
    MEMO : 仮想マシン
  
[確認]
  vm12# cd /usr/lib64/security
  vm12# ls (モジュール一覧)
  
  コマンドの実行結果
  --------------------------------------------------
  pam_access.so          pam_ftp.so             pam_permit.so          pam_tally2.so
  pam_cap.so             pam_group.so           pam_postgresok.so      pam_time.so
  pam_chroot.so          pam_issue.so           pam_pwhistory.so       pam_timestamp.so
  pam_console.so         pam_keyinit.so         pam_pwquality.so       pam_tty_audit.so
  pam_cracklib.so        pam_lastlog.so         pam_rhosts.so          pam_umask.so
  pam_debug.so           pam_limits.so          pam_rootok.so          pam_unix.so
  pam_deny.so            pam_listfile.so        pam_securetty.so       pam_unix_acct.so
  pam_echo.so            pam_localuser.so       pam_selinux.so         pam_unix_auth.so
  pam_env.so             pam_loginuid.so        pam_selinux_permit.so  pam_unix_passwd.so
  pam_exec.so            pam_mail.so            pam_sepermit.so        pam_unix_session.so
  pam_faildelay.so       pam_mkhomedir.so       pam_shells.so          pam_userdb.so
  pam_faillock.so        pam_motd.so            pam_stress.so          pam_warn.so
  pam_filter             pam_namespace.so       pam_succeed_if.so      pam_wheel.so
  pam_filter.so          pam_nologin.so         pam_systemd.so         pam_xauth.so
  --------------------------------------------------
  
  vm12# cd /etc/pam.d
  vm12# ls (設定ファイル一覧)
  
  コマンドの実行結果
  --------------------------------------------------
  chfn                 passwd               runuser-l            sudo
  chsh                 password-auth        smartcard-auth       sudo-i
  config-util          password-auth-ac     smartcard-auth-ac    system-auth
  crond                polkit-1             smtp                 system-auth-ac
  fingerprint-auth     postlogin            smtp.postfix         systemd-user
  fingerprint-auth-ac  postlogin-ac         sshd                 vlock
  login                remote               su
  other                runuser              su-l
  --------------------------------------------------
  
  以下の確認に続く
  
================================================================================
[03]
  PAM - 02 (設定ファイルの編集)
  
[内容]
  ## 作業内容
    設定ファイル(su)で管理者(root)であっても他ユーザーになる時にはパスワード入力
  
  ## 使用マシン
    HOST : vm12
    IPV4 : 192.168.122.12
    MEMO : 仮想マシン
  
[確認]
  vm12# cd $HOME
  vm12# su - makoto (他ユーザーになる)
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> パスワード入力なしに他ユーザーになれる
  --------------------------------------------------
  
  vm12$ cd $HOME
  vm12$ exit (管理者に戻る)
  
  コマンドの実行結果
  --------------------------------------------------
  ログアウト
  --------------------------------------------------
  
  vm12# cd /etc/pam.d
  vm12# cat su | grep -vE '^#|^$' (設定ファイルの確認)
  
  コマンドの実行結果
  --------------------------------------------------
  auth      sufficient  pam_rootok.so
  auth      substack    system-auth
  auth      include     postlogin
  account   sufficient  pam_succeed_if.so uid = 0 use_uid quiet
  account   include     system-auth
  password  include     system-auth
  session   include     system-auth
  session   include     postlogin
  session   optional    pam_xauth.so

  // pam_rootok.so     : ユーザー「root」か否かをチェック
  // system-auth       : ファイル「system-auth」のセクション「auth」を使用
  // postlogin         : ファイル「postlogin」のセクション「auth」を使用
  // pam_succeed_if.so : アカウント属性(例. UID)をチェック
  // uid = 0           : UID=0 すなわち root
  // use_uid           : コマンド「su」の実行ユーザーを対象
  // quiet             : ログに記録しない
  // system-auth       : ファイル「system-auth」のセクション「account」を使用
  // system-auto       : ファイル「system-auth」のセクション「password」を使用
  // system-auth       : ファイル「system-auth」のセクション「session」を使用
  // postlogin         : ファイル「postlogin」のセクション「session」を使用
  // pam_xauth.so      : おそらく「xauth」の認証関連
  --------------------------------------------------
  
  vm12# cd /etc/pam.d
  vm12# cat system-auth | grep -vE '^#|^$' (設定ファイルの確認)
  
  コマンドの実行結果
  --------------------------------------------------
  auth        required      pam_env.so
  auth        required      pam_faildelay.so delay=2000000
  auth        sufficient    pam_unix.so nullok try_first_pass
  auth        requisite     pam_succeed_if.so uid >= 1000 quiet_success
  auth        required      pam_deny.so
  account     required      pam_unix.so
  account     sufficient    pam_localuser.so
  account     sufficient    pam_succeed_if.so uid < 1000 quiet
  account     required      pam_permit.so
  password    requisite     pam_pwquality.so try_first_pass local_users_only retry=3 authtok_type=
  password    sufficient    pam_unix.so sha512 shadow nullok try_first_pass use_authtok
  password    required      pam_deny.so
  session     optional      pam_keyinit.so revoke
  session     required      pam_limits.so
  -session    optional      pam_systemd.so  // 冒頭の「-」でモジュールのロード失敗時でもログ出力しない
  session     [success=1 default=ignore] pam_succeed_if.so service in crond quiet use_uid
  session     required      pam_unix.so

  // pam_env.so       : 設定ファイルを読み込み
  // pam_faildelay.so : ログイン失敗後の待機時間を制御
  // delay=2000000    : 待機時間を2000000マイクロ秒(2秒)に設定
  // pam_unix.so      : 伝統的なパスワード認証
  // nullok           : 空白パスワード許可
  // try_first_pass   : 取得済パスワード再利用、未取得なら入力要求
  // uid >= 1000      : UID>=1000 すなわち 一般ユーザー
  // quiet_success    : 成功ログは記録しない
  // pam_deny.so      : 常に失敗を返す
  // pam_localuser.so : パスワードファイルのユーザー一覧
  // uid < 1000       : UID<1000 すなわち 内部ユーザー
  // pam_permit.so    : 常に成功を返す
  // pam_pwquality.so : パスワード品質を制御
  // local_users_only : パスワードファイル外のチェックを行わない
  // retry=3          : 三回失敗したらエラー出力
  // authtok_type=    : パスワード入力時のプロンプト文字
  // sha512           : パスワードをアルゴリズム「sha512」で暗号化
  // shadow           : パスワードをファイル「/etc/shadow」に保持
  // use_authtok      : 以降のモジュールでパスワード入力要求をせず、入力パスワードを使用
  // pam_keyinit.so   : 不明
  // revoke           : 不明
  // pam_limits.so    : リソース制限を制御
  // pam_systemd.so   : 不明
  // [success=1 default=ignore] : 成功時は1行スキップ(次の行を処理しない)、失敗時は無視して次の行を処理
  // service in crond : サービス名が「crond」
  --------------------------------------------------
  
  vm12# cd /etc/pam.d
  vm12# cp -p su su.org (設定ファイルのバックアップ)
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> 出力なし
  --------------------------------------------------
  
  vm12# cd /etc/pam.d
  vm12# vi su (設定ファイルの修正)
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> 1行目をコメントアウト
  --------------------------------------------------
  
  vm12# cd /etc/pam.d
  vm12# diff su.org su (修正箇所の確認)
  
  コマンドの実行結果
  --------------------------------------------------
  < auth    sufficient  pam_rootok.so
  ---
  > #auth   sufficient  pam_rootok.so
  --------------------------------------------------
  
  vm12# cd $HOME
  vm12# su - makoto (他ユーザーになる)
  
  コマンドの実行結果
  --------------------------------------------------
  パスワード: (パスワード入力)
  --------------------------------------------------
  
  vm12$ cd $HOME
  vm12$ exit (管理者に戻る)
  
  コマンドの実行結果
  --------------------------------------------------
  ログアウト
  --------------------------------------------------
  
  vm12# cd /etc/pam.d
  vm12# vi su (設定ファイルの修正)
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> 1行目をコメントアウトを元に戻す
  --------------------------------------------------
  
  以下の確認に続く
  
================================================================================
[04]
  PAM - 03 (処理の流れを追跡)
  
[内容]
  ## 作業内容
    設定ファイル(su)で処理の流れを追跡
  
  ## 使用マシン
    HOST : vm12
    IPV4 : 192.168.122.12
    MEMO : 仮想マシン
  
[確認]
  vm12# cd /etc/pam.d
  vm12# vi su (設定ファイルの修正)
  
  コマンドの実行結果
  --------------------------------------------------
  auth        required    pam_echo.so 01  // 追加
  auth        sufficient  pam_rootok.so
  auth        required    pam_echo.so 02  // 追加
  auth        substack    system-auth
  auth        required    pam_echo.so 03  // 追加
  auth        include     postlogin
  auth        required    pam_echo.so 04  // 追加
  account     required    pam_echo.so 05  // 追加
  account     sufficient  pam_succeed_if.so uid = 0 use_uid quiet
  account     required    pam_echo.so 06  // 追加
  account     include     system-auth
  account     required    pam_echo.so 07  // 追加
  password    required    pam_echo.so 08  // 追加
  password    include     system-auth
  password    required    pam_echo.so 09  // 追加
  session     required    pam_echo.so 10  // 追加
  session     include     system-auth
  session     required    pam_echo.so 11  // 追加
  session     include     postlogin
  session     required    pam_echo.so 12  // 追加
  session     optional    pam_xauth.so
  session     required    pam_echo.so 13  // 追加
  --------------------------------------------------
  
  vm12# cd $HOME
  vm12# LANG=C su - makoto (他ユーザーになる)
  
  コマンドの実行結果
  --------------------------------------------------
  01
  05
  10
  11
  Last login: Thu Jan 27 19:32:52 JST 2022 on ttyS0
  12
  13
  --------------------------------------------------
  
  vm12$ cd $HOME
  vm12$ LANG=C exit (管理者に戻る)
  
  コマンドの実行結果
  --------------------------------------------------
  logout
  --------------------------------------------------
  
  vm12# cd /etc/pam.d
  vm12# vi su (設定ファイルの修正)
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> 前回の「auth  sufficient  pam_rootok.so」を再びコメントアウト
  --------------------------------------------------
  
  vm12# cd $HOME
  vm12# LANG=C su - makoto (他ユーザーになる)
  
  コマンドの実行結果
  --------------------------------------------------
  01
  02
  Password: (パスワード入力)
  03
  04
  05
  10
  11
  Last login: Thu Jan 27 19:37:27 JST 2022 on ttyS0
  12
  13
  --------------------------------------------------
  
  vm12$ cd $HOME
  vm12$ LANG=C exit (管理者に戻る)
  
  コマンドの実行結果
  --------------------------------------------------
  logout
  --------------------------------------------------
  
  vm12# cd /etc/pam.d
  vm12# cp -f su.org su (設定ファイルを初期状態に戻す)
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> 出力なし
  --------------------------------------------------
  
  以下の確認に続く
  
================================================================================
