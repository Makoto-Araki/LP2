================================================================================
[01] DNSクライアントコマンド - 01 (nslookup)
[02] DNSクライアントコマンド - 02 (host)
[03] DNSクライアントコマンド - 03 (dig)
[04] 設定ファイル(/etc/named.conf) - 01 (コンテンツサーバー)
[05] 設定ファイル(/etc/named.conf) - 02 (コンテンツサーバー)
[06] 設定ファイル(/etc/named.conf) - 03 (キャッシュサーバー)
================================================================================
[01]
  DNSクライアントコマンド - 01 (nslookup)
  
[内容]
  ## 作業内容
    コマンド(nslookup)でDNSサーバーに名前解決を依頼する
  
  ## 使用マシン
    HOST : vm12
    IPV4 : 192.168.122.12
    MEMO : 仮想マシン
  
  ## コマンド(nslookup)
    nslookup -type=XX    // レコードタイプ(XX)を指定
    nslookup -norecurse  // 再帰問合せをしない
  
[確認]
  vm12$ cd $HOME
  vm12$ sudo yum -y bind-utils (パッケージ追加)
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> エラー出力が無ければOK
  --------------------------------------------------
  
  vm12$ cd $HOME
  vm12$ nslookup -type=soa yahoo.co.jp (レコードタイプ(SOA)指定、ドメイン名指定)
  
  コマンドの実行結果
  --------------------------------------------------
  Server: 192.168.122.1
  Address: 192.168.122.1#53
  
  Non-authoritative answer:
  yahoo.co.jp
    origin    = yahoo.co.jp
    mail addr = postmaster.yahoo.co.jp
    serial    = 2201070009
    refresh   = 1800
    retry     = 900
    expire    = 86400
    minimum   = 900
  
  Authoritative answers can be found from:
  --------------------------------------------------
  
  vm12$ cd $HOME
  vm12$ nslookup -type=ns yahoo.co.jp (レコードタイプ(NS)指定、ドメイン名指定)
  
  コマンドの実行結果
  --------------------------------------------------
  Server:  192.168.122.1
  Address: 192.168.122.1#53
  
  Non-authoritative answer:
  yahoo.co.jp  nameserver = ns02.yahoo.co.jp.
  yahoo.co.jp  nameserver = ns11.yahoo.co.jp.
  yahoo.co.jp  nameserver = ns12.yahoo.co.jp.
  yahoo.co.jp  nameserver = ns01.yahoo.co.jp.
  
  Authoritative answers can be found from:
  ns02.yahoo.co.jp  internet address = 118.151.254.149
  ns11.yahoo.co.jp  internet address = 124.83.255.37
  ns12.yahoo.co.jp  internet address = 124.83.255.101
  ns01.yahoo.co.jp  internet address = 118.151.254.133
  --------------------------------------------------
  
  vm12$ cd $HOME
  vm12$ nslookup -type=mx yahoo.co.jp (レコードタイプ(MX)指定、ドメイン名指定)
  
  コマンドの実行結果
  --------------------------------------------------
  Server: 192.168.122.1
  Address: 192.168.122.1#53
  
  Non-authoritative answer:
  yahoo.co.jp  mail exchanger = 10 mx5.mail.yahoo.co.jp.
  yahoo.co.jp  mail exchanger = 10 mx3.mail.yahoo.co.jp.
  yahoo.co.jp  mail exchanger = 10 mx2.mail.yahoo.co.jp.
  yahoo.co.jp  mail exchanger = 10 mx1.mail.yahoo.co.jp.
  
  Authoritative answers can be found from:
  --------------------------------------------------
  
  vm12$ cd $HOME
  vm12$ nslookup ns02.yahoo.co.jp (正引き名前解決)
  
  コマンドの実行結果
  --------------------------------------------------
  Server: 192.168.122.1
  Address: 192.168.122.1#53
  
  Non-authoritative answer:  // ドメイン「yahoo.co.jp」の権威サーバーからの回答ではない
  Name: ns02.yahoo.co.jp
  Address: 118.151.254.149
  --------------------------------------------------
  
  vm12$ cd $HOME
  vm12$ nslookup 118.151.254.149 (逆引き名前解決)
  
  コマンドの実行結果
  --------------------------------------------------
  149.254.151.118.in-addr.arpa  name = ns02.yahoo.co.jp.
  
  Authoritative answers can be found from:
  --------------------------------------------------
  
  以下の確認に続く
  
================================================================================
[02]
  DNSクライアントコマンド - 02 (host)
  
[内容]
  ## 作業内容
    コマンド(host)でDNSサーバーに名前解決を依頼する
  
  ## 使用マシン
    HOST : vm12
    IPV4 : 192.168.122.12
    MEMO : 仮想マシン
  
  ## コマンド(host)
    host -t XX  // レコードタイプ(XX)を指定
    host -v     // 詳細情報を表示
  
[確認]
  vm12$ cd $HOME
  vm12$ host -t soa yahoo.co.jp (レコードタイプ(SOA)指定、ドメイン名指定)
  
  コマンドの実行結果
  --------------------------------------------------
  yahoo.co.jp has SOA record yahoo.co.jp. postmaster.yahoo.co.jp. 2201070009 1800 900 86400 900
  --------------------------------------------------
  
  vm12$ cd $HOME
  vm12$ host -t ns yahoo.co.jp (レコードタイプ(NS)指定、ドメイン名指定)
  
  コマンドの実行結果
  --------------------------------------------------
  yahoo.co.jp name server ns11.yahoo.co.jp.
  yahoo.co.jp name server ns01.yahoo.co.jp.
  yahoo.co.jp name server ns02.yahoo.co.jp.
  yahoo.co.jp name server ns12.yahoo.co.jp.
  --------------------------------------------------
  
  vm12$ cd $HOME
  vm12$ host -t mx yahoo.co.jp (レコードタイプ(MX)指定、ドメイン名指定)
  
  コマンドの実行結果
  --------------------------------------------------
  yahoo.co.jp mail is handled by 10 mx2.mail.yahoo.co.jp.
  yahoo.co.jp mail is handled by 10 mx3.mail.yahoo.co.jp.
  yahoo.co.jp mail is handled by 10 mx5.mail.yahoo.co.jp.
  yahoo.co.jp mail is handled by 10 mx1.mail.yahoo.co.jp.
  --------------------------------------------------
  
  vm12$ cd $HOME
  vm12$ host ns02.yahoo.co.jp (正引き名前解決)
  
  コマンドの実行結果
  --------------------------------------------------
  ns02.yahoo.co.jp has address 118.151.254.149
  --------------------------------------------------
  
  vm12$ cd $HOME
  vm12$ host 118.151.254.149 (逆引き名前解決)
  
  コマンドの実行結果
  --------------------------------------------------
  149.254.151.118.in-addr.arpa domain name pointer ns02.yahoo.co.jp.
  --------------------------------------------------
  
  以下の確認に続く
  
================================================================================
[03]
  DNSクライアントコマンド - 03 (dig)
  
[内容]
  ## 作業内容
    コマンド(dig)でDNSサーバーに名前解決を依頼する
  
  ## 使用マシン
    HOST : vm12
    IPV4 : 192.168.122.12
    MEMO : 仮想マシン
  
  ## コマンド(dig)
    dig -x      // 逆引き名前解決を行う
    dig -p XX   // 問合先ポート(XX)を指定
    dig +norec  // 再帰問合せをしない
    dig +rec    // 再帰問合せをする
    dig +noall  // 全セクション非表示
    dig +all    // 全セクション表示
    dig +noquestion  // 質問セクション非表示
    dig +question    // 質問セクション表示
    dig +noanswer    // 回答セクション非表示
    dig +answer      // 回答セクション表示
  
[確認]
  vm12$ cd $HOME
  vm12$ dig +noall +answer yahoo.co.jp soa (全セクション非表示、回答セクション表示、ドメイン名指定、レコード(SOA)指定)
  
  コマンドの実行結果
  --------------------------------------------------
  yahoo.co.jp.  900 IN  SOA yahoo.co.jp. postmaster.yahoo.co.jp. 2201070009 1800 900 86400 900
  --------------------------------------------------
  
  vm12$ cd $HOME
  vm12$ dig +noall +answer yahoo.co.jp ns (全セクション非表示、回答セクション表示、ドメイン名指定、レコード(NS)指定)
  
  コマンドの実行結果
  --------------------------------------------------
  yahoo.co.jp.  900 IN  NS  ns11.yahoo.co.jp.
  yahoo.co.jp.  900 IN  NS  ns12.yahoo.co.jp.
  yahoo.co.jp.  900 IN  NS  ns01.yahoo.co.jp.
  yahoo.co.jp.  900 IN  NS  ns02.yahoo.co.jp.
  --------------------------------------------------
  
  vm12$ cd $HOME
  vm12$ dig +noall +answer yahoo.co.jp mx (全セクション非表示、回答セクション表示、ドメイン名指定、レコード(MX)指定)
  
  コマンドの実行結果
  --------------------------------------------------
  yahoo.co.jp.  900 IN  MX  10 mx1.mail.yahoo.co.jp.
  yahoo.co.jp.  900 IN  MX  10 mx3.mail.yahoo.co.jp.
  yahoo.co.jp.  900 IN  MX  10 mx5.mail.yahoo.co.jp.
  yahoo.co.jp.  900 IN  MX  10 mx2.mail.yahoo.co.jp.
  --------------------------------------------------
  
  vm12$ cd $HOME
  vm12$ dig ns11.yahoo.co.jp (オプションなし、正引き名前解決)
  
  コマンドの実行結果
  --------------------------------------------------
  ; <<>> DiG 9.11.4-P2-RedHat-9.11.4-26.P2.el7_9.8 <<>> ns11.yahoo.co.jp
  ;; global options: +cmd
  ;; Got answer:
  ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 20753
  ;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1
  
  ;; OPT PSEUDOSECTION:
  ; EDNS: version: 0, flags:; udp: 512
  
  -- 質問セクション
  ;; QUESTION SECTION:
  ;ns11.yahoo.co.jp. IN A
  
  -- 回答セクション
  ;; ANSWER SECTION:
  ns11.yahoo.co.jp. 599 IN A 124.83.255.37
  
  ;; Query time: 23 msec
  ;; SERVER: 192.168.122.1#53(192.168.122.1)
  ;; WHEN: 金  1月 07 22:46:35 JST 2022
  ;; MSG SIZE  rcvd: 61
  --------------------------------------------------
  
  vm12$ cd $HOME
  vm12$ dig +noall +answer ns11.yahoo.co.jp (全セクション非表示、回答セクション表示、正引き名前解決)
  
  コマンドの実行結果
  --------------------------------------------------
  ns11.yahoo.co.jp. 498 IN A 124.83.255.37
  --------------------------------------------------
  
  vm12$ cd $HOME
  vm12$ dig +noall +answer -x 124.83.255.37 (全セクション非表示、回答セクション表示、逆引き名前解決)
  
  コマンドの実行結果
  --------------------------------------------------
  37.255.83.124.in-addr.arpa. 900 IN  PTR ns11.yahoo.co.jp.
  --------------------------------------------------
  
  以下の確認に続く
  
================================================================================
[04]
  設定ファイル(/etc/named.conf) - 01 (コンテンツサーバー)
  
[内容]
  ## 作業内容
    設定ファイル(/etc/named.conf)を編集してコンテンツサーバー(マスター)を構築する
  
  ## 使用マシン
    HOST : vm12
    IPV4 : 192.168.122.12
    MEMO : 仮想マシン
  
[確認]
  vm12$ cd $HOME
  vm12$ sudo yum -y install bind bind-chroot bind-utils (パッケージ追加)
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> エラー出力が無ければOK
  --------------------------------------------------
  
  vm12$ cd /usr/libexec
  vm12$ sudo ./setup-named-chroot.sh /var/named/chroot on (スクリプト実行)
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> chroot有効化
  --------------------------------------------------
  
  vm12$ cd $HOME
  vm12$ (TSIG用の鍵ファイル作成のコマンドを1行で指定)
    dnssec-keygen  // コマンド本体
    -a HMAC-MD5    // アルゴリズム
    -b 128         // 鍵長
    -n HOST        // 所有者のタイプ
    tsig-key       // 鍵の名前
  
  コマンドの実行結果
  --------------------------------------------------
  Ktsig-key.+157+23920
  --------------------------------------------------
  
  vm12$ cd $HOME
  vm12$ ls -lh Ktsig-key* (TSIG用の鍵ファイル確認)
  
  コマンドの実行結果
  --------------------------------------------------
  -rw-------. 1 makoto makoto  52  1月  9 18:31 Ktsig-key.+157+23920.key      // 公開鍵
  -rw-------. 1 makoto makoto 165  1月  9 18:31 Ktsig-key.+157+23920.private  // 秘密鍵
  --------------------------------------------------
  
  vm12$ cd $HOME
  vm12$ cat Ktsig-key.+157+23920.key (TSIG用の鍵ファイルのうち公開鍵を確認)
  
  コマンドの実行結果
  --------------------------------------------------
  tsig-key. IN KEY 512 3 157 CBwbqLAX24F7NjFVo3BYeQ== -> 共有鍵「CBwbqLAX24F7NjFVo3BYeQ==」
  --------------------------------------------------
  
  vm12$ cd $HOME
  vm12$ cat Ktsig-key.+157+23920.private (TSIG用の鍵ファイルのうち秘密鍵を確認)
  
  コマンドの実行結果
  --------------------------------------------------
  Private-key-format: v1.3
  Algorithm: 157 (HMAC_MD5)
  Key: CBwbqLAX24F7NjFVo3BYeQ==  // 共有鍵「CBwbqLAX24F7NjFVo3BYeQ==」-> ゾーン転送時に使用
  Bits: AAA=
  Created: 20220109093130
  Publish: 20220109093130
  Activate: 20220109093130
  --------------------------------------------------
  
  vm12$ cd $HOME
  vm12$ sudo cp -p /var/named/chroot/etc/named.conf /var/named/chroot/etc/named.conf.org (設定ファイルのバックアップ)
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> 出力なし
  --------------------------------------------------
  
  vm12$ cd $HOME
  vm12$ sudo vi /var/named/chroot/etc/named.conf (設定ファイル修正)
  
  コマンドの実行結果
  --------------------------------------------------
  ## プログラム(named)の操作可能ホスト
  controls
  {
    inet 127.0.0.1 allow { localhost; };              # ローカルホストからのアクセス許可
    inet 192.168.122.12 allow { 192.168.122.0/24; };  # ネットワーク(192.168.122.0)からのアクセス許可
  };
  
  ## プログラム(named)の詳細オプション
  options
  {
    directory "/var/named";              # ゾーンファイル格納先 -> /var/named/chroot/var/named
    listen-on-v6 { none; };              # 不使用(IPv6)
    allow-transfer { 192.168.122.13; };  # ゾーン転送許可ホスト
    notify yes;                          # ゾーン更新をスレーブに通知
    recursion no;                        # 再帰問合わせを受付
    version "unknown";                   # バージョン表示
  };
  
  ## ゾーン転送のセキュリティ対策(TSIG)
  key tsig-key
  {
    algorithm hmac-md5;                # ゾーン転送の暗号化アルゴリズム
    secret CBwbqLAX24F7NjFVo3BYeQ==;   # 共有秘密鍵
  };
  
  ## ゾーンファイル(正引き)
  zone example.com IN
  {
    type master;                       # マスター
    file "example.com.zone";           # ファイル名
    allow-transfer { key tsig-key; };  # ゾーン転送時の共有鍵情報
  };
  
  ## ゾーンファイル(逆引き)
  zone 122.168.192.in-addr.arpa IN
  {
    type master;                       # マスター
    file "example.com.rev.zone";       # ファイル名
    allow-transfer { key tsig-key; };  # ゾーン転送時の共有鍵情報
  };
  --------------------------------------------------
  
  vm12$ cd $HOME
  vm12$ sudo named-checkconf -t /var/named/chroot /etc/named.conf (文法チェック)
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> 出力なし
  --------------------------------------------------
  
  vm12$ cd $HOME
  vm12$ sudo vi /var/named/chroot/var/named/example.com.zone (正引きファイル作成)
  
  コマンドの実行結果
  --------------------------------------------------
  $ORIGIN example.com.
  $TTL 1D
  example.com. IN SOA vm12.example.com. makoto.example.com. (
    2022010901  ; シリアル(年月日＋2桁)
    5M          ; スレーブがマスターをチェックする間隔(5分)
    5M          ; スレーブがマスターにアクセス不能時に再試行までの時間(5分)
    1D          ; スレーブがマスターにアクセス不能時にゾーン情報を破棄するまでの時間(1日)
    1D          ; ネガティブキャッシュ有効期限(1日)
  )
  
  example.com.           IN  NS     vm12.example.com.
  vm12.example.com.      IN  A      192.168.122.12
  vm13.example.com.      IN  A      192.168.122.13
  vm14.example.com.      IN  A      192.168.122.14
  vm15.example.com.      IN  A      192.168.122.15
  --------------------------------------------------
  
  vm12$ cd $HOME
  vm12$ sudo named-checkzone -t /var/named/chroot -w /var/named example.com example.com.zone (正引きファイルの文法チェック)
  
  コマンドの実行結果
  --------------------------------------------------
  zone example.com/IN: loaded serial 2022010901
  OK
  --------------------------------------------------
  
  vm12$ cd $HOME
  vm12$ sudo vi /var/named/chroot/var/named/example.com.rev.zone (逆引きファイルの作成)
  
  コマンドの実行結果
  --------------------------------------------------
  $ORIGIN example.com.
  $TTL 1D
  122.168.192.in-addr.arpa. IN SOA vm12.example.com. makoto.example.com. (
    2022010901  ; シリアル(年月日＋2桁)
    5M          ; スレーブがマスターをチェックする間隔(5分)
    5M          ; スレーブがマスターにアクセス不能時に再試行までの時間(5分)
    1D          ; スレーブがマスターにアクセス不能時にゾーン情報を破棄するまでの時間(1日)
    1D          ; ネガティブキャッシュ有効期限(1日)
  )
  
  122.168.192.in-addr.arpa.       IN  NS     vm12.example.com.
  12.122.168.192.in-addr.arpa.    IN  PTR    vm12.example.com.
  13.122.168.192.in-addr.arpa.    IN  PTR    vm13.example.com.
  14.122.168.192.in-addr.arpa.    IN  PTR    vm14.example.com.
  15.122.168.192.in-addr.arpa.    IN  PTR    vm15.example.com.
  --------------------------------------------------
  
  vm12$ cd $HOME (逆引きファイルの文法チェック)
  vm12$ sudo named-checkzone -t /var/named/chroot -w /var/named 122.168.192.in-addr.arpa example.com.rev.zone
  
  コマンドの実行結果
  --------------------------------------------------
  zone 122.168.192.in-addr.arpa/IN: loaded serial 2022010901
  OK
  --------------------------------------------------
  
  vm12$ cd $HOME
  vm12$ sudo systemctl disable named (自動起動設定を無効化)
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> chroot有効化でDNSサービス名は「named-chroot」に変更されたため出力なし
  --------------------------------------------------
  
  vm12$ cd $HOME
  vm12$ sudo systemctl enable named-chroot (自動起動設定を有効化)
  
  コマンドの実行結果
  --------------------------------------------------
  Created symlink from /etc/systemd/system/multi-user.target.wants/named-chroot.service
  to /usr/lib/systemd/system/named-chroot.service.
  --------------------------------------------------
  
  vm12$ cd $HOME
  vm12$ sudo systemctl start named-chroot (プログラム起動)
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> 出力なし
  --------------------------------------------------
  
  vm12$ cd $HOME
  vm12$ sudo firewall-cmd --add-service=dns --permanent (ファイアーウォールの設定)
  
  コマンドの実行結果
  --------------------------------------------------
  success
  --------------------------------------------------
  
  vm12$ cd $HOME
  vm12$ sudo firewall-cmd --reload (ファイアーウォールの設定を反映)
  
  コマンドの実行結果
  --------------------------------------------------
  success
  --------------------------------------------------
  
  以下の確認に続く
  
================================================================================
[05]
  設定ファイル(/etc/named.conf) - 02 (コンテンツサーバー)
  
[内容]
  ## 作業内容
    設定ファイル(/etc/named.conf)を編集してコンテンツサーバー(スレーブ)を構築する
  
  ## 使用マシン
    HOST : vm13
    IPV4 : 192.168.122.13
    MEMO : 仮想マシン
  
[確認]
  vm13$ cd $HOME
  vm13$ sudo yum -y install bind bind-chroot bind-utils (パッケージ追加)
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> エラー出力が無ければOK
  --------------------------------------------------
  
  vm13$ cd /usr/libexec
  vm13$ sudo ./setup-named-chroot.sh /var/named/chroot on (スクリプト実行)
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> chroot有効化
  --------------------------------------------------
  
  vm13$ cd $HOME
  vm13$ sudo cp -p /var/named/chroot/etc/named.conf /var/named/chroot/etc/named.conf.org (設定ファイルのバックアップ)
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> 出力なし
  --------------------------------------------------
  
  vm13$ cd $HOME
  vm13$ sudo vi /var/named/chroot/etc/named.conf (設定ファイル修正)
  
  コマンドの実行結果
  --------------------------------------------------
  ## プログラム(named)の操作可能ホスト
  controls
  {
    inet 127.0.0.1 allow { localhost; };              # ローカルホストからのアクセス許可
    inet 192.168.122.13 allow { 192.168.122.0/24; };  # ネットワーク(192.168.122.0)からのアクセス許可
  };
  
  ## プログラム(named)の詳細オプション
  options
  {
    directory "/var/named";              # ゾーンファイル格納先 -> /var/named/chroot/var/named
    listen-on-v6 { none; };              # 不使用(IPv6)
    recursion no;                        # 再帰問合わせを受付
    version "unknown";                   # バージョン表示
  };
  
  ## ゾーン転送のセキュリティ対策(TSIG)
  key tsig-key
  {
    algorithm hmac-md5;                  # ゾーン転送の暗号化アルゴリズム
    secret CBwbqLAX24F7NjFVo3BYeQ==;     # 共有鍵
  };
  
  ## コンテンツサーバー(マスター)
  server 192.168.122.12
  {
    keys { tsig-key; };                  # 前述の共有鍵(tsig-key)を使用
  };
  
  ## ゾーンファイル(正引き)
  zone "example.com" IN
  {
    type slave;                          # スレーブ
    masters { 192.168.122.12; };         # マスター情報
    file "slaves/example.com.zone";      # ファイル名
  };
  
  ## ゾーンファイル(逆引き)
  zone "122.168.192.in-addr.arpa" IN
  {
    type slave;                          # スレーブ
    masters { 192.168.122.12; };         # マスター情報
    file "slaves/example.com.rev.zone";  # ファイル名
  };
  --------------------------------------------------
  
  vm13$ cd $HOME
  vm13$ sudo named-checkconf -t /var/named/chroot /etc/named.conf (文法チェック)
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> 出力なし
  --------------------------------------------------
  
  vm13$ cd $HOME
  vm13$ sudo systemctl disable named (自動起動設定を無効化)
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> chroot有効化でDNSサービス名は「named-chroot」に変更されたため出力なし
  --------------------------------------------------
  
  vm13$ cd $HOME
  vm13$ sudo systemctl enable named-chroot (自動起動設定を有効化)
  
  コマンドの実行結果
  --------------------------------------------------
  Created symlink from /etc/systemd/system/multi-user.target.wants/named-chroot.service
  to /usr/lib/systemd/system/named-chroot.service.
  --------------------------------------------------
  
  vm13$ cd $HOME
  vm13$ sudo systemctl start named-chroot (プログラム起動)
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> 出力なし
  --------------------------------------------------
  
  vm13$ cd $HOME
  vm13$ sudo firewall-cmd --add-service=dns --permanent (ファイアーウォールの設定)
  
  コマンドの実行結果
  --------------------------------------------------
  success
  --------------------------------------------------
  
  vm13$ cd $HOME
  vm13$ sudo firewall-cmd --reload (ファイアーウォールの設定を反映)
  
  コマンドの実行結果
  --------------------------------------------------
  success
  --------------------------------------------------
  
  ==================================================
  ゾーン情報がマスターからスレーブへ転送されるまで待機
  ==================================================
  
  vm13$ cd $HOME
  vm13$ sudo grep -i tsig /var/log/messages (TSIG保護下のゾーン転送ログ)
  
  コマンドの実行結果
  --------------------------------------------------
  Jan  9 20:44:35 vm13 named[1651]: transfer of 'example.com/IN' from 192.168.122.12#53: ...
  Jan  9 20:44:36 vm13 named[1651]: zone example.com/IN: transferred serial 2022010901: TSIG 'tsig-key'
  Jan  9 20:44:36 vm13 named[1651]: transfer of '122.168.192.in-addr.arpa/IN' from 192.168.122.12#53: ...
  Jan  9 20:44:36 vm13 named[1651]: zone 122.168.192.in-addr.arpa/IN: transferred serial 2022010901: TSIG 'tsig-key'
  --------------------------------------------------
  
  vm13$ cd $HOME
  vm13$ sudo ls -lh /var/named/chroot/var/named/slaves (TSIG保護下のゾーン転送ファイル確認)
  
  コマンドの実行結果
  --------------------------------------------------
  -rw-r--r--. 1 named named 472  1月  9 20:44 example.com.rev.zone
  -rw-r--r--. 1 named named 346  1月  9 20:44 example.com.zone
  --------------------------------------------------
  
  vm13$ cd $HOME
  vm13$ (ゾーン転送ファイルのうち正引きファイルを確認)
    sudo named-compilezone                               // コマンド
    -f raw                                               // 変換前はバイナリ(デフォルト)
    -F text                                              // 変換後はテキスト
    -o /dev/stdout                                       // 出力先
    example.com                                          // 対象ゾーン
    /var/named/chroot/var/named/slaves/example.com.zone  // ファイル名
    
  コマンドの実行結果
  --------------------------------------------------
  zone example.com/IN: loaded serial 2022010901
  example.com.              86400 IN SOA  vm12.example.com. makoto.example.com. 2022010901 300 300 86400 86400
  example.com.              86400 IN NS   vm12.example.com.
  vm12.example.com.         86400 IN A    192.168.122.12
  vm13.example.com.         86400 IN A    192.168.122.13
  vm14.example.com.         86400 IN A    192.168.122.14
  vm15.example.com.         86400 IN A    192.168.122.15
  OK
  --------------------------------------------------
    
  vm13$ cd $HOME
  vm13$ (ゾーン転送ファイルのうち逆引きファイルを確認)
    sudo named-compilezone                                   // コマンド
    -f raw                                                   // 変換前はバイナリ(デフォルト)
    -F text                                                  // 変換後はテキスト
    -o /dev/stdout                                           // 出力先
    122.168.192.in-addr.arpa                                 // 対象ゾーン
    /var/named/chroot/var/named/slaves/example.com.rev.zone  // ファイル名
    
  コマンドの実行結果
  --------------------------------------------------
  zone 122.168.192.in-addr.arpa/IN: loaded serial 2022010901
  122.168.192.in-addr.arpa.          86400 IN SOA  vm12.example.com. makoto.example.com. 2022010901 300 300 86400 86400
  122.168.192.in-addr.arpa.          86400 IN NS   vm12.example.com.
  12.122.168.192.in-addr.arpa.       86400 IN PTR  vm12.example.com.
  13.122.168.192.in-addr.arpa.       86400 IN PTR  vm13.example.com.
  14.122.168.192.in-addr.arpa.       86400 IN PTR  vm14.example.com.
  15.122.168.192.in-addr.arpa.       86400 IN PTR  vm15.example.com.
  OK
  --------------------------------------------------
  
  以下の確認に続く
  
================================================================================
[06]
  設定ファイル(/etc/named.conf) - 03 (キャッシュサーバー)
  
[内容]
  ## 作業内容
    設定ファイル(/etc/named.conf)を編集してキャッシュサーバーを構築する
  
  ## 使用マシン
    HOST : vm14
    IPV4 : 192.168.122.14
    MEMO : 仮想マシン
  
[確認]
  vm14$ cd $HOME
  vm14$ sudo yum -y install bind bind-chroot bind-utils (パッケージ追加)
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> エラー出力が無ければOK
  --------------------------------------------------
  
  vm14$ cd /usr/libexec
  vm14$ sudo ./setup-named-chroot.sh /var/named/chroot on (スクリプト実行)
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> chroot有効化
  --------------------------------------------------
  
  vm14$ cd $HOME
  vm14$ sudo cp -p /var/named/chroot/etc/named.conf /var/named/chroot/etc/named.conf.org (設定ファイルのバックアップ)
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> 出力なし
  --------------------------------------------------
  
  vm14$ cd $HOME
  vm14$ sudo vi /var/named/chroot/etc/named.conf (設定ファイル修正)
  
  コマンドの実行結果
  --------------------------------------------------
  ## プログラム(named)の操作可能ホスト
  controls
  {
    inet 127.0.0.1 allow { localhost; };              # ローカルホストからのアクセス許可
    inet 192.168.122.14 allow { 192.168.122.0/24; };  # ネットワーク(192.168.122.0)からのアクセス許可
  };
  
  ## プログラム(named)の詳細オプション
  options
  {
    directory "/var/named";                            # ゾーンファイル格納先 -> /var/named/chroot/var/named
    listen-on-v6 { none; };                            # 不使用(IPv6)
    recursion yes;                                     # 再帰問合わせを受付
    recursive-clients 300;                             # 再帰問合わせを受付可能なクライアント数
    allow-query { 192.168.122.0/24; localhost; };      # 問合わせの受付ホスト
    allow-recursion { 192.168.122.0/24; localhost; };  # 再帰問合わせの受付ホスト
    forward only;                                      # フォワードのみ
    forwarders { 192.168.122.1; };                     # フォワード先(192.168.122.14 -> 192.168.122.1 -> プロバイダDNS)
    version "unknown";                                 # バージョン表示
  };
  
  ## ルートサーバー情報
  zone "." IN
  {
    type hint;
    file "named.ca";
  };
  --------------------------------------------------
  
  vm14$ cd $HOME
  vm14$ sudo named-checkconf -t /var/named/chroot /etc/named.conf (文法チェック)
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> 出力なし
  --------------------------------------------------
  
  vm14$ cd $HOME
  vm14$ sudo systemctl disable named (自動起動設定を無効化)
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> chroot有効化でDNSサービス名は「named-chroot」に変更されたため出力なし
  --------------------------------------------------
  
  vm14$ cd $HOME
  vm14$ sudo systemctl enable named-chroot (自動起動設定を有効化)
  
  コマンドの実行結果
  --------------------------------------------------
  Created symlink from /etc/systemd/system/multi-user.target.wants/named-chroot.service
  to /usr/lib/systemd/system/named-chroot.service.
  --------------------------------------------------
  
  vm14$ cd $HOME
  vm14$ sudo systemctl start named-chroot (プログラム起動)
  
  コマンドの実行結果
  --------------------------------------------------
  (省略) -> 出力なし
  --------------------------------------------------
  
  vm14$ cd $HOME
  vm14$ sudo firewall-cmd --add-service=dns --permanent (ファイアーウォールの設定)
  
  コマンドの実行結果
  --------------------------------------------------
  success
  --------------------------------------------------
  
  vm14$ cd $HOME
  vm14$ sudo firewall-cmd --reload (ファイアーウォールの設定を反映)
  
  コマンドの実行結果
  --------------------------------------------------
  success
  --------------------------------------------------
  
  vm14$ cd $HOME
  vm14$ dig @vm14 ns11.yahoo.co.jp (問合せサーバー指定、オプションなし、正引き名前解決)
  
  コマンドの実行結果
  --------------------------------------------------
  ; <<>> DiG 9.11.4-P2-RedHat-9.11.4-26.P2.el7_9.8 <<>> @vm14 ns11.yahoo.co.jp
  ; (1 server found)
  ;; global options: +cmd
  ;; Got answer:
  ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 41323
  ;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1
  
  ;; OPT PSEUDOSECTION:
  ; EDNS: version: 0, flags:; udp: 4096

  -- 質問セクション
  ;; QUESTION SECTION:
  ;ns11.yahoo.co.jp. IN A
  
  -- 回答セクション
  ;; ANSWER SECTION:
  ns11.yahoo.co.jp. 632 IN A 124.83.255.37
  
  ;; Query time: 26 msec
  ;; SERVER: 192.168.122.14#53(192.168.122.14)  // 指定したキャッシュサーバーに問合せ
  ;; WHEN: 日  1月 09 22:07:22 JST 2022
  ;; MSG SIZE  rcvd: 61
  --------------------------------------------------
  
  以下の確認に続く
  
================================================================================
